<!DOCTYPE html>
<HTML lang = "en">
<HEAD>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
  
  

  <script type="text/x-mathjax-config">
    MathJax.Hub.Config({
      tex2jax: {inlineMath: [['$','$'], ['\\(','\\)']]},
      TeX: { equationNumbers: { autoNumber: "AMS" } }
    });
  </script>

  <script type="text/javascript" async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
  </script>

  
<style>
pre.hljl {
    border: 1px solid #ccc;
    margin: 5px;
    padding: 5px;
    overflow-x: auto;
    color: rgb(68,68,68); background-color: rgb(251,251,251); }
pre.hljl > span.hljl-t { }
pre.hljl > span.hljl-w { }
pre.hljl > span.hljl-e { }
pre.hljl > span.hljl-eB { }
pre.hljl > span.hljl-o { }
pre.hljl > span.hljl-k { color: rgb(148,91,176); font-weight: bold; }
pre.hljl > span.hljl-kc { color: rgb(59,151,46); font-style: italic; }
pre.hljl > span.hljl-kd { color: rgb(214,102,97); font-style: italic; }
pre.hljl > span.hljl-kn { color: rgb(148,91,176); font-weight: bold; }
pre.hljl > span.hljl-kp { color: rgb(148,91,176); font-weight: bold; }
pre.hljl > span.hljl-kr { color: rgb(148,91,176); font-weight: bold; }
pre.hljl > span.hljl-kt { color: rgb(148,91,176); font-weight: bold; }
pre.hljl > span.hljl-n { }
pre.hljl > span.hljl-na { }
pre.hljl > span.hljl-nb { }
pre.hljl > span.hljl-nbp { }
pre.hljl > span.hljl-nc { }
pre.hljl > span.hljl-ncB { }
pre.hljl > span.hljl-nd { color: rgb(214,102,97); }
pre.hljl > span.hljl-ne { }
pre.hljl > span.hljl-neB { }
pre.hljl > span.hljl-nf { color: rgb(66,102,213); }
pre.hljl > span.hljl-nfm { color: rgb(66,102,213); }
pre.hljl > span.hljl-np { }
pre.hljl > span.hljl-nl { }
pre.hljl > span.hljl-nn { }
pre.hljl > span.hljl-no { }
pre.hljl > span.hljl-nt { }
pre.hljl > span.hljl-nv { }
pre.hljl > span.hljl-nvc { }
pre.hljl > span.hljl-nvg { }
pre.hljl > span.hljl-nvi { }
pre.hljl > span.hljl-nvm { }
pre.hljl > span.hljl-l { }
pre.hljl > span.hljl-ld { color: rgb(148,91,176); font-style: italic; }
pre.hljl > span.hljl-s { color: rgb(201,61,57); }
pre.hljl > span.hljl-sa { color: rgb(201,61,57); }
pre.hljl > span.hljl-sb { color: rgb(201,61,57); }
pre.hljl > span.hljl-sc { color: rgb(201,61,57); }
pre.hljl > span.hljl-sd { color: rgb(201,61,57); }
pre.hljl > span.hljl-sdB { color: rgb(201,61,57); }
pre.hljl > span.hljl-sdC { color: rgb(201,61,57); }
pre.hljl > span.hljl-se { color: rgb(59,151,46); }
pre.hljl > span.hljl-sh { color: rgb(201,61,57); }
pre.hljl > span.hljl-si { }
pre.hljl > span.hljl-so { color: rgb(201,61,57); }
pre.hljl > span.hljl-sr { color: rgb(201,61,57); }
pre.hljl > span.hljl-ss { color: rgb(201,61,57); }
pre.hljl > span.hljl-ssB { color: rgb(201,61,57); }
pre.hljl > span.hljl-nB { color: rgb(59,151,46); }
pre.hljl > span.hljl-nbB { color: rgb(59,151,46); }
pre.hljl > span.hljl-nfB { color: rgb(59,151,46); }
pre.hljl > span.hljl-nh { color: rgb(59,151,46); }
pre.hljl > span.hljl-ni { color: rgb(59,151,46); }
pre.hljl > span.hljl-nil { color: rgb(59,151,46); }
pre.hljl > span.hljl-noB { color: rgb(59,151,46); }
pre.hljl > span.hljl-oB { color: rgb(102,102,102); font-weight: bold; }
pre.hljl > span.hljl-ow { color: rgb(102,102,102); font-weight: bold; }
pre.hljl > span.hljl-p { }
pre.hljl > span.hljl-c { color: rgb(153,153,119); font-style: italic; }
pre.hljl > span.hljl-ch { color: rgb(153,153,119); font-style: italic; }
pre.hljl > span.hljl-cm { color: rgb(153,153,119); font-style: italic; }
pre.hljl > span.hljl-cp { color: rgb(153,153,119); font-style: italic; }
pre.hljl > span.hljl-cpB { color: rgb(153,153,119); font-style: italic; }
pre.hljl > span.hljl-cs { color: rgb(153,153,119); font-style: italic; }
pre.hljl > span.hljl-csB { color: rgb(153,153,119); font-style: italic; }
pre.hljl > span.hljl-g { }
pre.hljl > span.hljl-gd { }
pre.hljl > span.hljl-ge { }
pre.hljl > span.hljl-geB { }
pre.hljl > span.hljl-gh { }
pre.hljl > span.hljl-gi { }
pre.hljl > span.hljl-go { }
pre.hljl > span.hljl-gp { }
pre.hljl > span.hljl-gs { }
pre.hljl > span.hljl-gsB { }
pre.hljl > span.hljl-gt { }
</style>



  <style type="text/css">
  @font-face {
  font-style: normal;
  font-weight: 300;
}
@font-face {
  font-style: normal;
  font-weight: 400;
}
@font-face {
  font-style: normal;
  font-weight: 600;
}
html {
  font-family: sans-serif; /* 1 */
  -ms-text-size-adjust: 100%; /* 2 */
  -webkit-text-size-adjust: 100%; /* 2 */
}
body {
  margin: 0;
}
article,
aside,
details,
figcaption,
figure,
footer,
header,
hgroup,
main,
menu,
nav,
section,
summary {
  display: block;
}
audio,
canvas,
progress,
video {
  display: inline-block; /* 1 */
  vertical-align: baseline; /* 2 */
}
audio:not([controls]) {
  display: none;
  height: 0;
}
[hidden],
template {
  display: none;
}
a:active,
a:hover {
  outline: 0;
}
abbr[title] {
  border-bottom: 1px dotted;
}
b,
strong {
  font-weight: bold;
}
dfn {
  font-style: italic;
}
h1 {
  font-size: 2em;
  margin: 0.67em 0;
}
mark {
  background: #ff0;
  color: #000;
}
small {
  font-size: 80%;
}
sub,
sup {
  font-size: 75%;
  line-height: 0;
  position: relative;
  vertical-align: baseline;
}
sup {
  top: -0.5em;
}
sub {
  bottom: -0.25em;
}
img {
  border: 0;
}
svg:not(:root) {
  overflow: hidden;
}
figure {
  margin: 1em 40px;
}
hr {
  -moz-box-sizing: content-box;
  box-sizing: content-box;
  height: 0;
}
pre {
  overflow: auto;
}
code,
kbd,
pre,
samp {
  font-family: monospace, monospace;
  font-size: 1em;
}
button,
input,
optgroup,
select,
textarea {
  color: inherit; /* 1 */
  font: inherit; /* 2 */
  margin: 0; /* 3 */
}
button {
  overflow: visible;
}
button,
select {
  text-transform: none;
}
button,
html input[type="button"], /* 1 */
input[type="reset"],
input[type="submit"] {
  -webkit-appearance: button; /* 2 */
  cursor: pointer; /* 3 */
}
button[disabled],
html input[disabled] {
  cursor: default;
}
button::-moz-focus-inner,
input::-moz-focus-inner {
  border: 0;
  padding: 0;
}
input {
  line-height: normal;
}
input[type="checkbox"],
input[type="radio"] {
  box-sizing: border-box; /* 1 */
  padding: 0; /* 2 */
}
input[type="number"]::-webkit-inner-spin-button,
input[type="number"]::-webkit-outer-spin-button {
  height: auto;
}
input[type="search"] {
  -webkit-appearance: textfield; /* 1 */
  -moz-box-sizing: content-box;
  -webkit-box-sizing: content-box; /* 2 */
  box-sizing: content-box;
}
input[type="search"]::-webkit-search-cancel-button,
input[type="search"]::-webkit-search-decoration {
  -webkit-appearance: none;
}
fieldset {
  border: 1px solid #c0c0c0;
  margin: 0 2px;
  padding: 0.35em 0.625em 0.75em;
}
legend {
  border: 0; /* 1 */
  padding: 0; /* 2 */
}
textarea {
  overflow: auto;
}
optgroup {
  font-weight: bold;
}
table {
  font-family: monospace, monospace;
  font-size : 0.8em;
  border-collapse: collapse;
  border-spacing: 0;
}
td,
th {
  padding: 0;
}
thead th {
    border-bottom: 1px solid black;
    background-color: white;
}
tr:nth-child(odd){
  background-color: rgb(248,248,248);
}


/*
* Skeleton V2.0.4
* Copyright 2014, Dave Gamache
* www.getskeleton.com
* Free to use under the MIT license.
* http://www.opensource.org/licenses/mit-license.php
* 12/29/2014
*/
.container {
  position: relative;
  width: 100%;
  max-width: 960px;
  margin: 0 auto;
  padding: 0 20px;
  box-sizing: border-box; }
.column,
.columns {
  width: 100%;
  float: left;
  box-sizing: border-box; }
@media (min-width: 400px) {
  .container {
    width: 85%;
    padding: 0; }
}
@media (min-width: 550px) {
  .container {
    width: 80%; }
  .column,
  .columns {
    margin-left: 4%; }
  .column:first-child,
  .columns:first-child {
    margin-left: 0; }

  .one.column,
  .one.columns                    { width: 4.66666666667%; }
  .two.columns                    { width: 13.3333333333%; }
  .three.columns                  { width: 22%;            }
  .four.columns                   { width: 30.6666666667%; }
  .five.columns                   { width: 39.3333333333%; }
  .six.columns                    { width: 48%;            }
  .seven.columns                  { width: 56.6666666667%; }
  .eight.columns                  { width: 65.3333333333%; }
  .nine.columns                   { width: 74.0%;          }
  .ten.columns                    { width: 82.6666666667%; }
  .eleven.columns                 { width: 91.3333333333%; }
  .twelve.columns                 { width: 100%; margin-left: 0; }

  .one-third.column               { width: 30.6666666667%; }
  .two-thirds.column              { width: 65.3333333333%; }

  .one-half.column                { width: 48%; }

  /* Offsets */
  .offset-by-one.column,
  .offset-by-one.columns          { margin-left: 8.66666666667%; }
  .offset-by-two.column,
  .offset-by-two.columns          { margin-left: 17.3333333333%; }
  .offset-by-three.column,
  .offset-by-three.columns        { margin-left: 26%;            }
  .offset-by-four.column,
  .offset-by-four.columns         { margin-left: 34.6666666667%; }
  .offset-by-five.column,
  .offset-by-five.columns         { margin-left: 43.3333333333%; }
  .offset-by-six.column,
  .offset-by-six.columns          { margin-left: 52%;            }
  .offset-by-seven.column,
  .offset-by-seven.columns        { margin-left: 60.6666666667%; }
  .offset-by-eight.column,
  .offset-by-eight.columns        { margin-left: 69.3333333333%; }
  .offset-by-nine.column,
  .offset-by-nine.columns         { margin-left: 78.0%;          }
  .offset-by-ten.column,
  .offset-by-ten.columns          { margin-left: 86.6666666667%; }
  .offset-by-eleven.column,
  .offset-by-eleven.columns       { margin-left: 95.3333333333%; }

  .offset-by-one-third.column,
  .offset-by-one-third.columns    { margin-left: 34.6666666667%; }
  .offset-by-two-thirds.column,
  .offset-by-two-thirds.columns   { margin-left: 69.3333333333%; }

  .offset-by-one-half.column,
  .offset-by-one-half.columns     { margin-left: 52%; }

}
html {
  font-size: 62.5%; }
body {
  font-size: 1.5em; /* currently ems cause chrome bug misinterpreting rems on body element */
  line-height: 1.6;
  font-weight: 400;
  font-family: "Raleway", "HelveticaNeue", "Helvetica Neue", Helvetica, Arial, sans-serif;
  color: #222; }
h1, h2, h3, h4, h5, h6 {
  margin-top: 0;
  margin-bottom: 2rem;
  font-weight: 300; }
h1 { font-size: 3.6rem; line-height: 1.2;  letter-spacing: -.1rem;}
h2 { font-size: 3.4rem; line-height: 1.25; letter-spacing: -.1rem; }
h3 { font-size: 3.2rem; line-height: 1.3;  letter-spacing: -.1rem; }
h4 { font-size: 2.8rem; line-height: 1.35; letter-spacing: -.08rem; }
h5 { font-size: 2.4rem; line-height: 1.5;  letter-spacing: -.05rem; }
h6 { font-size: 1.5rem; line-height: 1.6;  letter-spacing: 0; }

p {
  margin-top: 0; }
a {
  color: #1EAEDB; }
a:hover {
  color: #0FA0CE; }
.button,
button,
input[type="submit"],
input[type="reset"],
input[type="button"] {
  display: inline-block;
  height: 38px;
  padding: 0 30px;
  color: #555;
  text-align: center;
  font-size: 11px;
  font-weight: 600;
  line-height: 38px;
  letter-spacing: .1rem;
  text-transform: uppercase;
  text-decoration: none;
  white-space: nowrap;
  background-color: transparent;
  border-radius: 4px;
  border: 1px solid #bbb;
  cursor: pointer;
  box-sizing: border-box; }
.button:hover,
button:hover,
input[type="submit"]:hover,
input[type="reset"]:hover,
input[type="button"]:hover,
.button:focus,
button:focus,
input[type="submit"]:focus,
input[type="reset"]:focus,
input[type="button"]:focus {
  color: #333;
  border-color: #888;
  outline: 0; }
.button.button-primary,
button.button-primary,
input[type="submit"].button-primary,
input[type="reset"].button-primary,
input[type="button"].button-primary {
  color: #FFF;
  background-color: #33C3F0;
  border-color: #33C3F0; }
.button.button-primary:hover,
button.button-primary:hover,
input[type="submit"].button-primary:hover,
input[type="reset"].button-primary:hover,
input[type="button"].button-primary:hover,
.button.button-primary:focus,
button.button-primary:focus,
input[type="submit"].button-primary:focus,
input[type="reset"].button-primary:focus,
input[type="button"].button-primary:focus {
  color: #FFF;
  background-color: #1EAEDB;
  border-color: #1EAEDB; }
input[type="email"],
input[type="number"],
input[type="search"],
input[type="text"],
input[type="tel"],
input[type="url"],
input[type="password"],
textarea,
select {
  height: 38px;
  padding: 6px 10px; /* The 6px vertically centers text on FF, ignored by Webkit */
  background-color: #fff;
  border: 1px solid #D1D1D1;
  border-radius: 4px;
  box-shadow: none;
  box-sizing: border-box; }
/* Removes awkward default styles on some inputs for iOS */
input[type="email"],
input[type="number"],
input[type="search"],
input[type="text"],
input[type="tel"],
input[type="url"],
input[type="password"],
textarea {
  -webkit-appearance: none;
     -moz-appearance: none;
          appearance: none; }
textarea {
  min-height: 65px;
  padding-top: 6px;
  padding-bottom: 6px; }
input[type="email"]:focus,
input[type="number"]:focus,
input[type="search"]:focus,
input[type="text"]:focus,
input[type="tel"]:focus,
input[type="url"]:focus,
input[type="password"]:focus,
textarea:focus,
select:focus {
  border: 1px solid #33C3F0;
  outline: 0; }
label,
legend {
  display: block;
  margin-bottom: .5rem;
  font-weight: 600; }
fieldset {
  padding: 0;
  border-width: 0; }
input[type="checkbox"],
input[type="radio"] {
  display: inline; }
label > .label-body {
  display: inline-block;
  margin-left: .5rem;
  font-weight: normal; }
ul {
  list-style: circle; }
ol {
  list-style: decimal; }
ul ul,
ul ol,
ol ol,
ol ul {
  margin: 1.5rem 0 1.5rem 3rem;
  font-size: 90%; }
li > p {margin : 0;}
th,
td {
  padding: 12px 15px;
  text-align: left;
  border-bottom: 1px solid #E1E1E1; }
th:first-child,
td:first-child {
  padding-left: 0; }
th:last-child,
td:last-child {
  padding-right: 0; }
button,
.button {
  margin-bottom: 1rem; }
input,
textarea,
select,
fieldset {
  margin-bottom: 1.5rem; }
pre,
blockquote,
dl,
figure,
table,
p,
ul,
ol,
form {
  margin-bottom: 1.0rem; }
.u-full-width {
  width: 100%;
  box-sizing: border-box; }
.u-max-full-width {
  max-width: 100%;
  box-sizing: border-box; }
.u-pull-right {
  float: right; }
.u-pull-left {
  float: left; }
hr {
  margin-top: 3rem;
  margin-bottom: 3.5rem;
  border-width: 0;
  border-top: 1px solid #E1E1E1; }
.container:after,
.row:after,
.u-cf {
  content: "";
  display: table;
  clear: both; }

pre {
  display: block;
  padding: 9.5px;
  margin: 0 0 10px;
  font-size: 13px;
  line-height: 1.42857143;
  word-break: break-all;
  word-wrap: break-word;
  border: 1px solid #ccc;
  border-radius: 4px;
}

pre.hljl {
  margin: 0 0 10px;
  display: block;
  background: #f5f5f5;
  border-radius: 4px;
  padding : 5px;
}

pre.output {
  background: #ffffff;
}

pre.code {
  background: #ffffff;
}

pre.julia-error {
  color : red
}

code,
kbd,
pre,
samp {
  font-family: Menlo, Monaco, Consolas, "Courier New", monospace;
  font-size: 0.9em;
}


@media (min-width: 400px) {}
@media (min-width: 550px) {}
@media (min-width: 750px) {}
@media (min-width: 1000px) {}
@media (min-width: 1200px) {}

h1.title {margin-top : 20px}
img {max-width : 100%}
div.title {text-align: center;}

  </style>
</HEAD>

<BODY>
  <div class ="container">
    <div class = "row">
      <div class = "col-md-12 twelve columns">
        <div class="title">
          
          
          
        </div>

        <h1>Structural Econometrics - Assignment 2 Tutorial</h1>
<h3>Author: Jaepil Lee</h3>
<h3>Date: 11/1/2021</h3>
<p>I thank Christine Dabbs and Martin Michelini for their help and comments.</p>

<h3><a href="#ols_liv_GMM">How GMM works: OLS and LIV</a>&lt;a name&#61;&quot;ols<em>liv</em>GMM_menu&quot;&gt;&lt;/a&gt;</h3>
<h3><a href="#review">Model</a>&lt;a name&#61;&quot;review_menu&quot;&gt;&lt;/a&gt;</h3>
<h3><a href="#data">Data</a>&lt;a name&#61;&quot;data_menu&quot;&gt;&lt;/a&gt;</h3>
<h3><a href="#estimation">Estimation</a>&lt;a name&#61;&quot;estimation_menu&quot;&gt;&lt;/a&gt;</h3>

<p>We aim to replicate a table below by using <strong>monthly data</strong> from 1960-1 to 2020-12.</p>
<p>Note: The panels of Table III that this assignment asks you to replicate appear in their errata published in 1984.</p>

<p>&lt;img src&#61;&quot;&#91;Hansen,Singleton;1984;Ecma&#93; ERRATA - Table III estimates with multiple returns.png&quot;&gt;</p>


<pre class='hljl'>
<span class='hljl-n'>ENV</span><span class='hljl-p'>[</span><span class='hljl-s'>&quot;COLUMNS&quot;</span><span class='hljl-p'>]</span><span class='hljl-oB'>=</span><span class='hljl-ni'>100</span><span class='hljl-p'>;</span><span class='hljl-t'> </span><span class='hljl-n'>ENV</span><span class='hljl-p'>[</span><span class='hljl-s'>&quot;LINES&quot;</span><span class='hljl-p'>]</span><span class='hljl-oB'>=</span><span class='hljl-ni'>1000</span><span class='hljl-t'>
</span><span class='hljl-cs'># Importing packages...</span><span class='hljl-t'>
</span><span class='hljl-k'>using</span><span class='hljl-t'> </span><span class='hljl-n'>Pkg</span><span class='hljl-p'>;</span><span class='hljl-t'> </span><span class='hljl-n'>Pkg</span><span class='hljl-oB'>.</span><span class='hljl-nf'>activate</span><span class='hljl-p'>(</span><span class='hljl-s'>&quot;./..&quot;</span><span class='hljl-p'>);</span><span class='hljl-t'> </span><span class='hljl-n'>Pkg</span><span class='hljl-oB'>.</span><span class='hljl-nf'>instantiate</span><span class='hljl-p'>();</span><span class='hljl-t'>
</span><span class='hljl-k'>using</span><span class='hljl-t'> </span><span class='hljl-n'>Distributions</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>Statistics</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>Random</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>HypothesisTests</span><span class='hljl-p'>,</span><span class='hljl-t'>
      </span><span class='hljl-n'>LinearAlgebra</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>Distances</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>SharedArrays</span><span class='hljl-p'>,</span><span class='hljl-t'> 
      </span><span class='hljl-n'>Optim</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>ForwardDiff</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>NLSolversBase</span><span class='hljl-p'>,</span><span class='hljl-t'> 
      </span><span class='hljl-n'>Plots</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>Printf</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>LaTeXStrings</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>PlotThemes</span><span class='hljl-p'>,</span><span class='hljl-t'>
      </span><span class='hljl-n'>CSV</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>DataFrames</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>TimeSeries</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>Dates</span><span class='hljl-p'>,</span><span class='hljl-t'>
      </span><span class='hljl-n'>FredApi</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>FredData</span><span class='hljl-p'>;</span>
</pre>


<pre class="julia-error">
ERROR: Failed to precompile CSV &#91;336ed68f-0bac-5ca0-87d4-7b16caf5d00b&#93; to C:\Users\jaepi\.julia\compiled\v1.7\CSV\jl_ABD3.tmp.
</pre>


<h2><a href="#ols_liv_GMM">How GMM works: OLS and LIV</a>&lt;a name&#61;&quot;ols<em>liv</em>GMM_menu&quot;&gt;&lt;/a&gt;</h2>

<p>Let&#39;s first see how GMM estimation routine works in OLS and LIV. Let&#39;s construct a hypothetical dataset with <span class="math">$N$</span> where:</p>
<ul>
<li><p class="math">\[
y_i = \beta_0 + \beta_1 x_{i,1} + \beta_2 x_{i,2} + \varepsilon_i, \varepsilon_i \sim \mathcal{N}(0,\sigma^2)
\]</p>
<p>for <span class="math">$i=1,\ldots,N$</span></p>
</li>
<li><p class="math">\[
(\beta_0, \beta_1, \beta_2) = (0.15, 0.25, -1.5), \sigma = 1.2
\]</p>
</li>
</ul>
<p>We all know what <span class="math">$\beta_{ols}$</span> looks like: <span class="math">$(X'X)^{-1}X'Y$</span>. We also know its standard errors. Let&#39;s code it just for fun:</p>


<pre class='hljl'>
<span class='hljl-cs'>#%% DGP</span><span class='hljl-t'>
</span><span class='hljl-k'>function</span><span class='hljl-t'> </span><span class='hljl-nf'>DGP_OLS</span><span class='hljl-p'>(</span><span class='hljl-n'>N</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>β_DGP</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>σ_DGP</span><span class='hljl-p'>)</span><span class='hljl-t'>
    </span><span class='hljl-n'>Random</span><span class='hljl-oB'>.</span><span class='hljl-nf'>seed!</span><span class='hljl-p'>(</span><span class='hljl-ni'>42</span><span class='hljl-p'>)</span><span class='hljl-t'> </span><span class='hljl-cs'># RNG: We get the same number for replicability</span><span class='hljl-t'>
    </span><span class='hljl-p'>(</span><span class='hljl-n'>β₀</span><span class='hljl-p'>,</span><span class='hljl-n'>β₁</span><span class='hljl-p'>,</span><span class='hljl-n'>β₂</span><span class='hljl-p'>)</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-n'>β_DGP</span><span class='hljl-t'>
    </span><span class='hljl-n'>x₁</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-nf'>randn</span><span class='hljl-p'>(</span><span class='hljl-n'>N</span><span class='hljl-p'>)</span><span class='hljl-t'> </span><span class='hljl-cs'># a Nx1 vector</span><span class='hljl-t'>
    </span><span class='hljl-n'>x₂</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-nf'>randn</span><span class='hljl-p'>(</span><span class='hljl-n'>N</span><span class='hljl-p'>)</span><span class='hljl-t'> </span><span class='hljl-cs'># a Nx1 vector</span><span class='hljl-t'>
    </span><span class='hljl-n'>ε</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-n'>σ_DGP</span><span class='hljl-t'> </span><span class='hljl-oB'>*</span><span class='hljl-t'> </span><span class='hljl-nf'>randn</span><span class='hljl-p'>(</span><span class='hljl-n'>N</span><span class='hljl-p'>)</span><span class='hljl-t'>  </span><span class='hljl-cs'># a Nx1 vector</span><span class='hljl-t'>
    </span><span class='hljl-n'>y</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-n'>β₀</span><span class='hljl-t'> </span><span class='hljl-oB'>.+</span><span class='hljl-t'> </span><span class='hljl-n'>β₁</span><span class='hljl-t'> </span><span class='hljl-oB'>.*</span><span class='hljl-t'> </span><span class='hljl-n'>x₁</span><span class='hljl-t'> </span><span class='hljl-oB'>.+</span><span class='hljl-t'> </span><span class='hljl-n'>β₂</span><span class='hljl-t'> </span><span class='hljl-oB'>.*</span><span class='hljl-t'> </span><span class='hljl-n'>x₂</span><span class='hljl-t'> </span><span class='hljl-oB'>.+</span><span class='hljl-t'> </span><span class='hljl-n'>ε</span><span class='hljl-t'> </span><span class='hljl-cs'># a Nx1 vector</span><span class='hljl-t'>
    </span><span class='hljl-n'>X</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-p'>[</span><span class='hljl-nf'>ones</span><span class='hljl-p'>(</span><span class='hljl-n'>N</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-ni'>1</span><span class='hljl-p'>)</span><span class='hljl-t'> </span><span class='hljl-n'>x₁</span><span class='hljl-t'> </span><span class='hljl-n'>x₂</span><span class='hljl-p'>]</span><span class='hljl-t'> </span><span class='hljl-cs'># a Nx3 matrix</span><span class='hljl-t'>
    </span><span class='hljl-cs'># If you wish to use other statistical packages, use this CSV file.</span><span class='hljl-t'>
    </span><span class='hljl-cs'># df = DataFrame(X0 = X[:, 1], X1 = X[:, 2], X2 = X[:, 3], y = y);</span><span class='hljl-t'>
    </span><span class='hljl-cs'># CSV.write(&quot;./OLS.csv&quot;,df);</span><span class='hljl-t'>
    </span><span class='hljl-k'>return</span><span class='hljl-t'> </span><span class='hljl-n'>y</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>X</span><span class='hljl-t'>
</span><span class='hljl-k'>end</span><span class='hljl-t'>
</span><span class='hljl-cs'>#%% OLS estimation</span><span class='hljl-t'>
</span><span class='hljl-k'>function</span><span class='hljl-t'> </span><span class='hljl-nf'>OLS_estimation</span><span class='hljl-p'>(</span><span class='hljl-n'>y</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>X</span><span class='hljl-p'>)</span><span class='hljl-t'>
    </span><span class='hljl-n'>N</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-nf'>length</span><span class='hljl-p'>(</span><span class='hljl-n'>y</span><span class='hljl-p'>)</span><span class='hljl-t'>
    </span><span class='hljl-n'>β_OLS</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-nf'>inv</span><span class='hljl-p'>(</span><span class='hljl-n'>X</span><span class='hljl-oB'>&#39;</span><span class='hljl-n'>X</span><span class='hljl-p'>)</span><span class='hljl-t'> </span><span class='hljl-oB'>*</span><span class='hljl-t'> </span><span class='hljl-n'>X</span><span class='hljl-oB'>&#39;</span><span class='hljl-n'>y</span><span class='hljl-t'> </span><span class='hljl-cs'># a 3x1 vector given DGP</span><span class='hljl-t'>
    </span><span class='hljl-n'>ε_OLS</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-n'>y</span><span class='hljl-t'> </span><span class='hljl-oB'>-</span><span class='hljl-t'> </span><span class='hljl-n'>X</span><span class='hljl-t'> </span><span class='hljl-oB'>*</span><span class='hljl-t'> </span><span class='hljl-n'>β_OLS</span><span class='hljl-t'>
    </span><span class='hljl-n'>invXX</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-nf'>inv</span><span class='hljl-p'>(</span><span class='hljl-n'>X</span><span class='hljl-oB'>&#39;*</span><span class='hljl-n'>X</span><span class='hljl-p'>)</span><span class='hljl-t'>
    </span><span class='hljl-n'>Xε</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-n'>X</span><span class='hljl-oB'>.*</span><span class='hljl-n'>ε_OLS</span><span class='hljl-t'>
    </span><span class='hljl-n'>Σ_OLS</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-n'>invXX</span><span class='hljl-oB'>*</span><span class='hljl-p'>(</span><span class='hljl-n'>Xε</span><span class='hljl-oB'>&#39;*</span><span class='hljl-n'>Xε</span><span class='hljl-p'>)</span><span class='hljl-oB'>*</span><span class='hljl-n'>invXX</span><span class='hljl-t'> </span><span class='hljl-cs'># V_HC0 - White-Heteroskedasticity-Robust VCov</span><span class='hljl-t'>
    </span><span class='hljl-n'>σ_OLS</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-n'>sqrt</span><span class='hljl-oB'>.</span><span class='hljl-p'>(</span><span class='hljl-nf'>diag</span><span class='hljl-p'>(</span><span class='hljl-n'>Σ_OLS</span><span class='hljl-p'>))</span><span class='hljl-t'>
    </span><span class='hljl-k'>return</span><span class='hljl-t'> </span><span class='hljl-n'>β_OLS</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>σ_OLS</span><span class='hljl-t'>
</span><span class='hljl-k'>end</span><span class='hljl-p'>;</span>
</pre>



<p>Let&#39;s take <span class="math">$\mathbf{Y}$</span> and <span class="math">$\mathbf{X}$</span> we generated above and find <span class="math">$\beta$</span> via GMM. You will see that they are exactly equal to each other. Let <span class="math">$f_i(\beta):=f(Y_i,X_i,\beta)$</span> be the function of orthogonality conditions evaluated at <span class="math">$i$</span>&#39;s covariates. The orthogonality condition for OLS is <span class="math">$\mathbb{E}(\varepsilon_i X_i) = 0$</span>, where <span class="math">$\varepsilon_i = Y_i - X_i'\beta$</span> and the expectation is taken over <span class="math">$i$</span>. In the GMM framework, we wish to find <span class="math">$\beta$</span> that satisfies:</p>
<p class="math">\[
    0 = \frac{1}{N}\sum_{i=1}^{N}f_i(\beta) = \frac{1}{N}\sum_{i=1}^{N} \varepsilon_i X_i= \frac{1}{N}\sum_{i=1}^{N} (Y_i - X_i'\beta) \times X_i.
\]</p>
<p>Notice there are <span class="math">$3 \times 1$</span> orthogonality conditions: <span class="math">$\varepsilon_i$</span> is a scalar and <span class="math">$X_i$</span> is a <span class="math">$3\times1$</span> vector. Thus, the above equation is an &quot;element-wise&quot; average of a vector-valued function.</p>
<p>If you recall from econometrics I, what OLS really does is minimizing the sum of squared residuals, <span class="math">$\frac{1}{N}\sum_{i=1}^N \varepsilon_i^2$</span> where <span class="math">$\varepsilon_i=Y_i-X_i'\beta$</span>. The first order condition of the minimization problem is found by taking a gradient of the sum of squared residuals &#40;as a function of <span class="math">$\beta$</span>, <span class="math">$X$</span>, and <span class="math">$Y$</span>&#41; with respect to <span class="math">$\beta$</span>. </p>
<p class="math">\[
    \frac{\partial}{\partial\beta'}\left(\frac{1}{N}\sum_{i}^{N}Y_i^2 - \frac{1}{N}\sum_{i}^{N} 2 X_i Y_i \beta + \frac{1}{N}\sum_{i}^{N} \beta' X_i X_i' \beta \right) = \frac{1}{N}\sum_{i}^{N}2(X_iX_i'\beta - X_i Y_i) = 0 \\
    \frac{1}{N}\sum_{i}^{N}(Y_i - X_i'\beta) \times X_i = 0
\]</p>
<p>This is exactly equal to the moment that GMM uses.</p>


<pre class='hljl'>
<span class='hljl-cs'># OLS via GMM</span><span class='hljl-t'>
</span><span class='hljl-k'>function</span><span class='hljl-t'> </span><span class='hljl-nf'>GMM_OLS</span><span class='hljl-p'>(</span><span class='hljl-n'>y</span><span class='hljl-p'>,</span><span class='hljl-n'>X</span><span class='hljl-p'>)</span><span class='hljl-t'>

    </span><span class='hljl-cm'>#=
    f_OLS(β,y,X): orthogonality conditions
    W: weighting matrix. In OLS, this is the identity matrix.
    f_sum(β): a (k x 1) vector of sample average of normal function.
    obj_OLS(β): a &quot;sandwich&quot; of f_sum(β).
    Q: In OLS, it is inv(X&#39;*X).
    Ω: In OLS, it is the outer product of (X&#39;*ε).
    =#</span><span class='hljl-t'>

    </span><span class='hljl-k'>function</span><span class='hljl-t'> </span><span class='hljl-nf'>f_OLS</span><span class='hljl-p'>(</span><span class='hljl-n'>β</span><span class='hljl-p'>,</span><span class='hljl-n'>y</span><span class='hljl-p'>,</span><span class='hljl-n'>X</span><span class='hljl-p'>)</span><span class='hljl-t'>
        </span><span class='hljl-k'>return</span><span class='hljl-t'> </span><span class='hljl-p'>(</span><span class='hljl-n'>y</span><span class='hljl-t'> </span><span class='hljl-oB'>-</span><span class='hljl-t'> </span><span class='hljl-n'>X</span><span class='hljl-oB'>*</span><span class='hljl-n'>β</span><span class='hljl-p'>)</span><span class='hljl-t'> </span><span class='hljl-oB'>.*</span><span class='hljl-t'> </span><span class='hljl-n'>X</span><span class='hljl-t'>
    </span><span class='hljl-k'>end</span><span class='hljl-t'>
    
    </span><span class='hljl-n'>k</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-nf'>size</span><span class='hljl-p'>(</span><span class='hljl-n'>X</span><span class='hljl-p'>)[</span><span class='hljl-ni'>2</span><span class='hljl-p'>]</span><span class='hljl-t'>
    </span><span class='hljl-n'>N</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-nf'>length</span><span class='hljl-p'>(</span><span class='hljl-n'>y</span><span class='hljl-p'>)</span><span class='hljl-t'>
    </span><span class='hljl-n'>W</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-n'>I</span><span class='hljl-p'>;</span><span class='hljl-t'>
    </span><span class='hljl-nf'>f_sum</span><span class='hljl-p'>(</span><span class='hljl-n'>β</span><span class='hljl-p'>)</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-nf'>vec</span><span class='hljl-p'>(</span><span class='hljl-nf'>sum</span><span class='hljl-p'>(</span><span class='hljl-nf'>f_OLS</span><span class='hljl-p'>(</span><span class='hljl-n'>β</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>y</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>X</span><span class='hljl-p'>),</span><span class='hljl-n'>dims</span><span class='hljl-oB'>=</span><span class='hljl-ni'>1</span><span class='hljl-p'>));</span><span class='hljl-t'>
    </span><span class='hljl-nf'>obj_OLS</span><span class='hljl-p'>(</span><span class='hljl-n'>β</span><span class='hljl-p'>)</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-n'>N</span><span class='hljl-t'> </span><span class='hljl-oB'>*</span><span class='hljl-t'> </span><span class='hljl-p'>(</span><span class='hljl-nf'>f_sum</span><span class='hljl-p'>(</span><span class='hljl-n'>β</span><span class='hljl-p'>)</span><span class='hljl-oB'>/</span><span class='hljl-n'>N</span><span class='hljl-p'>)</span><span class='hljl-oB'>&#39;</span><span class='hljl-t'> </span><span class='hljl-oB'>*</span><span class='hljl-t'> </span><span class='hljl-n'>W</span><span class='hljl-t'> </span><span class='hljl-oB'>*</span><span class='hljl-t'> </span><span class='hljl-p'>(</span><span class='hljl-nf'>f_sum</span><span class='hljl-p'>(</span><span class='hljl-n'>β</span><span class='hljl-p'>)</span><span class='hljl-oB'>/</span><span class='hljl-n'>N</span><span class='hljl-p'>);</span><span class='hljl-t'>
    </span><span class='hljl-n'>opt</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-nf'>optimize</span><span class='hljl-p'>(</span><span class='hljl-n'>obj_OLS</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-nf'>randn</span><span class='hljl-p'>(</span><span class='hljl-n'>k</span><span class='hljl-p'>),</span><span class='hljl-t'> </span><span class='hljl-nf'>BFGS</span><span class='hljl-p'>(),</span><span class='hljl-t'> </span><span class='hljl-n'>autodiff</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-sc'>:forward</span><span class='hljl-p'>);</span><span class='hljl-t'>

    </span><span class='hljl-n'>β_OLS_GMM</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-n'>opt</span><span class='hljl-oB'>.</span><span class='hljl-n'>minimizer</span><span class='hljl-p'>;</span><span class='hljl-t'>
    </span><span class='hljl-n'>Q</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-n'>ForwardDiff</span><span class='hljl-oB'>.</span><span class='hljl-nf'>jacobian</span><span class='hljl-p'>(</span><span class='hljl-n'>β</span><span class='hljl-t'> </span><span class='hljl-oB'>-&gt;</span><span class='hljl-t'> </span><span class='hljl-nf'>f_sum</span><span class='hljl-p'>(</span><span class='hljl-n'>β</span><span class='hljl-p'>)</span><span class='hljl-t'> </span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>β_OLS_GMM</span><span class='hljl-p'>)</span><span class='hljl-oB'>/</span><span class='hljl-n'>N</span><span class='hljl-p'>;</span><span class='hljl-t'>
    </span><span class='hljl-n'>Ω</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-nf'>f_OLS</span><span class='hljl-p'>(</span><span class='hljl-n'>β_OLS_GMM</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>y</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>X</span><span class='hljl-p'>)</span><span class='hljl-oB'>&#39;*</span><span class='hljl-nf'>f_OLS</span><span class='hljl-p'>(</span><span class='hljl-n'>β_OLS_GMM</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>y</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>X</span><span class='hljl-p'>)</span><span class='hljl-oB'>/</span><span class='hljl-n'>N</span><span class='hljl-p'>;</span><span class='hljl-t'>
    </span><span class='hljl-n'>Σ_OLS_GMM</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-nf'>inv</span><span class='hljl-p'>(</span><span class='hljl-n'>Q</span><span class='hljl-oB'>&#39;*</span><span class='hljl-n'>W</span><span class='hljl-oB'>*</span><span class='hljl-n'>Q</span><span class='hljl-p'>)</span><span class='hljl-oB'>*</span><span class='hljl-p'>(</span><span class='hljl-n'>Q</span><span class='hljl-oB'>&#39;*</span><span class='hljl-n'>W</span><span class='hljl-oB'>*</span><span class='hljl-n'>Ω</span><span class='hljl-oB'>*</span><span class='hljl-n'>W</span><span class='hljl-oB'>*</span><span class='hljl-n'>Q</span><span class='hljl-p'>)</span><span class='hljl-oB'>*</span><span class='hljl-nf'>inv</span><span class='hljl-p'>(</span><span class='hljl-n'>Q</span><span class='hljl-oB'>&#39;*</span><span class='hljl-n'>W</span><span class='hljl-oB'>*</span><span class='hljl-n'>Q</span><span class='hljl-p'>)</span><span class='hljl-oB'>/</span><span class='hljl-n'>N</span><span class='hljl-p'>;</span><span class='hljl-t'> </span><span class='hljl-cs'># remember to divide by N to compute s.e. of β_hat!</span><span class='hljl-t'>
    </span><span class='hljl-n'>σ_OLS_GMM</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-n'>sqrt</span><span class='hljl-oB'>.</span><span class='hljl-p'>(</span><span class='hljl-nf'>diag</span><span class='hljl-p'>(</span><span class='hljl-n'>Σ_OLS_GMM</span><span class='hljl-p'>));</span><span class='hljl-t'>
    
    </span><span class='hljl-k'>return</span><span class='hljl-t'> </span><span class='hljl-n'>β_OLS_GMM</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>σ_OLS_GMM</span><span class='hljl-t'>

</span><span class='hljl-k'>end</span><span class='hljl-p'>;</span>
</pre>




<pre class='hljl'>
<span class='hljl-cs'>#%% Simulation &amp; Estimation</span><span class='hljl-t'>
</span><span class='hljl-n'>N</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-ni'>100_000</span><span class='hljl-t'>
</span><span class='hljl-n'>β_DGP</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-p'>(</span><span class='hljl-nfB'>0.15</span><span class='hljl-p'>,</span><span class='hljl-nfB'>0.25</span><span class='hljl-p'>,</span><span class='hljl-oB'>-</span><span class='hljl-nfB'>1.5</span><span class='hljl-p'>)</span><span class='hljl-t'>
</span><span class='hljl-n'>σ_DGP</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-nfB'>1.2</span><span class='hljl-t'>
</span><span class='hljl-n'>y_OLS</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>X_OLS</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-nf'>DGP_OLS</span><span class='hljl-p'>(</span><span class='hljl-n'>N</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>β_DGP</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>σ_DGP</span><span class='hljl-p'>)</span><span class='hljl-t'>
</span><span class='hljl-n'>β_OLS</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>σ_OLS</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-nf'>OLS_estimation</span><span class='hljl-p'>(</span><span class='hljl-n'>y_OLS</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>X_OLS</span><span class='hljl-p'>);</span><span class='hljl-t'>
</span><span class='hljl-n'>β_OLS_GMM</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>σ_OLS_GMM</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-nf'>GMM_OLS</span><span class='hljl-p'>(</span><span class='hljl-n'>y_OLS</span><span class='hljl-p'>,</span><span class='hljl-n'>X_OLS</span><span class='hljl-p'>);</span><span class='hljl-t'>

</span><span class='hljl-cs'># Print the results</span><span class='hljl-t'>
</span><span class='hljl-nf'>print</span><span class='hljl-p'>(</span><span class='hljl-s'>&quot;Using the formula for OLS:</span><span class='hljl-se'>\n</span><span class='hljl-s'>&quot;</span><span class='hljl-p'>)</span><span class='hljl-t'>
</span><span class='hljl-nf'>print</span><span class='hljl-p'>(</span><span class='hljl-s'>&quot;    |     β₀     |     β₁     |     β₂     | </span><span class='hljl-se'>\n</span><span class='hljl-s'>&quot;</span><span class='hljl-p'>)</span><span class='hljl-t'>
</span><span class='hljl-nd'>@printf</span><span class='hljl-p'>(</span><span class='hljl-s'>&quot;DGP | %10.7f | %10.7f | %10.7f |</span><span class='hljl-se'>\n</span><span class='hljl-s'>&quot;</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>β_DGP</span><span class='hljl-p'>[</span><span class='hljl-ni'>1</span><span class='hljl-p'>],</span><span class='hljl-t'> </span><span class='hljl-n'>β_DGP</span><span class='hljl-p'>[</span><span class='hljl-ni'>2</span><span class='hljl-p'>],</span><span class='hljl-t'> </span><span class='hljl-n'>β_DGP</span><span class='hljl-p'>[</span><span class='hljl-ni'>3</span><span class='hljl-p'>])</span><span class='hljl-t'>
</span><span class='hljl-nd'>@printf</span><span class='hljl-p'>(</span><span class='hljl-s'>&quot;OLS | %10.7f | %10.7f | %10.7f |</span><span class='hljl-se'>\n</span><span class='hljl-s'>&quot;</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>β_OLS</span><span class='hljl-p'>[</span><span class='hljl-ni'>1</span><span class='hljl-p'>],</span><span class='hljl-t'> </span><span class='hljl-n'>β_OLS</span><span class='hljl-p'>[</span><span class='hljl-ni'>2</span><span class='hljl-p'>],</span><span class='hljl-t'> </span><span class='hljl-n'>β_OLS</span><span class='hljl-p'>[</span><span class='hljl-ni'>3</span><span class='hljl-p'>])</span><span class='hljl-t'>
</span><span class='hljl-nd'>@printf</span><span class='hljl-p'>(</span><span class='hljl-s'>&quot;    |(%10.7f)|(%10.7f)|(%10.7f)|</span><span class='hljl-se'>\n</span><span class='hljl-s'>&quot;</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>σ_OLS</span><span class='hljl-p'>[</span><span class='hljl-ni'>1</span><span class='hljl-p'>],</span><span class='hljl-t'> </span><span class='hljl-n'>σ_OLS</span><span class='hljl-p'>[</span><span class='hljl-ni'>2</span><span class='hljl-p'>],</span><span class='hljl-t'> </span><span class='hljl-n'>σ_OLS</span><span class='hljl-p'>[</span><span class='hljl-ni'>3</span><span class='hljl-p'>])</span><span class='hljl-t'>
</span><span class='hljl-nd'>@printf</span><span class='hljl-p'>(</span><span class='hljl-s'>&quot;GMM | %10.7f | %10.7f | %10.7f |</span><span class='hljl-se'>\n</span><span class='hljl-s'>&quot;</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>β_OLS_GMM</span><span class='hljl-p'>[</span><span class='hljl-ni'>1</span><span class='hljl-p'>],</span><span class='hljl-t'> </span><span class='hljl-n'>β_OLS_GMM</span><span class='hljl-p'>[</span><span class='hljl-ni'>2</span><span class='hljl-p'>],</span><span class='hljl-t'> </span><span class='hljl-n'>β_OLS_GMM</span><span class='hljl-p'>[</span><span class='hljl-ni'>3</span><span class='hljl-p'>])</span><span class='hljl-t'>
</span><span class='hljl-nd'>@printf</span><span class='hljl-p'>(</span><span class='hljl-s'>&quot;    |(%10.7f)|(%10.7f)|(%10.7f)|</span><span class='hljl-se'>\n</span><span class='hljl-s'>&quot;</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>σ_OLS_GMM</span><span class='hljl-p'>[</span><span class='hljl-ni'>1</span><span class='hljl-p'>],</span><span class='hljl-t'> </span><span class='hljl-n'>σ_OLS_GMM</span><span class='hljl-p'>[</span><span class='hljl-ni'>2</span><span class='hljl-p'>],</span><span class='hljl-t'> </span><span class='hljl-n'>σ_OLS_GMM</span><span class='hljl-p'>[</span><span class='hljl-ni'>3</span><span class='hljl-p'>])</span><span class='hljl-t'>
</span><span class='hljl-nf'>print</span><span class='hljl-p'>(</span><span class='hljl-s'>&quot;Standard errors in parentheses.&quot;</span><span class='hljl-p'>)</span>
</pre>


<pre class="output">
Using the formula for OLS:
    |     β₀     |     β₁     |     β₂     | 
DGP |  0.1500000 |  0.2500000 | -1.5000000 |
OLS |  0.1574148 |  0.2556172 | -1.5032818 |
    |&#40; 0.0038011&#41;|&#40; 0.0037832&#41;|&#40; 0.0038027&#41;|
GMM |  0.1574148 |  0.2556172 | -1.5032818 |
    |&#40; 0.0038011&#41;|&#40; 0.0037832&#41;|&#40; 0.0038027&#41;|
Standard errors in parentheses.
</pre>


<p>As we expect, OLS and GMM estimation give us the same estimates.</p>

<p>Let&#39;s scale up a little bit and do LIV. 2SLS in the over-identified case is what we will use in GMM.</p>
<p>Let <span class="math">$f_i(\beta):=f(Y_i,X_i,Z_i,\beta)$</span> be the function of orthogonality conditions. The orthogonality condition for LIV is <span class="math">$\mathbb{E}(\varepsilon_i Z_i) = 0$</span>, where <span class="math">$\varepsilon_i = Y_i - X_i'\beta$</span> and the expectation is taken over <span class="math">$i$</span>. In the GMM framework, we wish to find <span class="math">$\beta$</span> that satisfies below:</p>
<p class="math">\[
    0 = \frac{1}{N}\sum_{i=1}^{N}f_i(\beta) = \frac{1}{N}\sum_{i=1}^{N} \varepsilon_i Z_i= \frac{1}{N}\sum_{i=1}^{N} (Y_i - X_i'\beta) \times Z_i.
\]</p>
<p>If we have more instruments than the number of endogenous variables, we call the model is over-identified. In the example below, I set <span class="math">$x_2$</span> to be the endogenous variable and provide 2 instruments, <span class="math">$z_1$</span> and <span class="math">$z_2$</span>. If we use both <span class="math">$z_1$</span> and <span class="math">$z_2$</span>, then we have 4 orthogonality conditions and 3 parameters to estimate. It is almost surely impossible to find <span class="math">$\beta$</span> where the moment is zero. Thus, we just find <span class="math">$\beta$</span> that makes the moment as close to zero as possible. We instead can introduce some positive definite weighting matrix <span class="math">$W$</span> and make the estimate more efficient.</p>


<pre class='hljl'>
<span class='hljl-cs'># DGP for LIV</span><span class='hljl-t'>
</span><span class='hljl-k'>function</span><span class='hljl-t'> </span><span class='hljl-nf'>DGP_LIV</span><span class='hljl-p'>(</span><span class='hljl-n'>N</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>β_DGP</span><span class='hljl-p'>,</span><span class='hljl-n'>μ</span><span class='hljl-p'>,</span><span class='hljl-n'>Σ</span><span class='hljl-p'>)</span><span class='hljl-t'>
     </span><span class='hljl-n'>Random</span><span class='hljl-oB'>.</span><span class='hljl-nf'>seed!</span><span class='hljl-p'>(</span><span class='hljl-ni'>42</span><span class='hljl-p'>)</span><span class='hljl-t'>
     </span><span class='hljl-p'>(</span><span class='hljl-n'>β₀</span><span class='hljl-p'>,</span><span class='hljl-n'>β₁</span><span class='hljl-p'>,</span><span class='hljl-n'>β₂</span><span class='hljl-p'>)</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-n'>β_DGP</span><span class='hljl-t'>
     </span><span class='hljl-p'>(</span><span class='hljl-n'>x₂</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>z₁</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>z₂</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>ε</span><span class='hljl-p'>)</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-n'>collect</span><span class='hljl-oB'>.</span><span class='hljl-p'>(</span><span class='hljl-nf'>eachrow</span><span class='hljl-p'>(</span><span class='hljl-nf'>rand</span><span class='hljl-p'>(</span><span class='hljl-nf'>MvNormal</span><span class='hljl-p'>(</span><span class='hljl-n'>μ</span><span class='hljl-p'>,</span><span class='hljl-n'>Σ</span><span class='hljl-p'>),</span><span class='hljl-n'>N</span><span class='hljl-p'>)))</span><span class='hljl-t'>
     </span><span class='hljl-n'>x₁</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-nf'>randn</span><span class='hljl-p'>(</span><span class='hljl-n'>N</span><span class='hljl-p'>)</span><span class='hljl-t'>
     </span><span class='hljl-n'>y</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-n'>β₀</span><span class='hljl-t'> </span><span class='hljl-oB'>.+</span><span class='hljl-t'> </span><span class='hljl-n'>β₁</span><span class='hljl-oB'>*</span><span class='hljl-n'>x₁</span><span class='hljl-t'> </span><span class='hljl-oB'>.+</span><span class='hljl-t'> </span><span class='hljl-n'>β₂</span><span class='hljl-oB'>*</span><span class='hljl-n'>x₂</span><span class='hljl-t'> </span><span class='hljl-oB'>.+</span><span class='hljl-t'> </span><span class='hljl-n'>ε</span><span class='hljl-t'> </span><span class='hljl-cs'># a Nx1 vector</span><span class='hljl-t'>
     </span><span class='hljl-n'>X</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-p'>[</span><span class='hljl-n'>x₁</span><span class='hljl-t'> </span><span class='hljl-n'>x₂</span><span class='hljl-p'>]</span><span class='hljl-t'> </span><span class='hljl-cs'># a Nx2 matrix</span><span class='hljl-t'>
     </span><span class='hljl-n'>Z</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-p'>[</span><span class='hljl-n'>z₁</span><span class='hljl-t'> </span><span class='hljl-n'>z₂</span><span class='hljl-p'>]</span><span class='hljl-t'>
     </span><span class='hljl-k'>return</span><span class='hljl-t'> </span><span class='hljl-n'>y</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>X</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>Z</span><span class='hljl-t'>
</span><span class='hljl-k'>end</span><span class='hljl-p'>;</span>
</pre>




<pre class='hljl'>
<span class='hljl-k'>function</span><span class='hljl-t'> </span><span class='hljl-nf'>LIV_estimation</span><span class='hljl-p'>(</span><span class='hljl-n'>y</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>X_data</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>Z</span><span class='hljl-p'>)</span><span class='hljl-t'>

     </span><span class='hljl-n'>N</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-nf'>length</span><span class='hljl-p'>(</span><span class='hljl-n'>y</span><span class='hljl-p'>)</span><span class='hljl-t'>
     </span><span class='hljl-n'>X</span><span class='hljl-t'>      </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-p'>[</span><span class='hljl-nf'>ones</span><span class='hljl-p'>(</span><span class='hljl-n'>N</span><span class='hljl-p'>)</span><span class='hljl-t'> </span><span class='hljl-n'>X_data</span><span class='hljl-p'>]</span><span class='hljl-t'>
     </span><span class='hljl-n'>X₁Z₁</span><span class='hljl-t'>   </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-p'>[</span><span class='hljl-nf'>ones</span><span class='hljl-p'>(</span><span class='hljl-n'>N</span><span class='hljl-p'>)</span><span class='hljl-t'> </span><span class='hljl-n'>X</span><span class='hljl-p'>[</span><span class='hljl-oB'>:</span><span class='hljl-p'>,</span><span class='hljl-ni'>2</span><span class='hljl-p'>]</span><span class='hljl-t'> </span><span class='hljl-n'>Z</span><span class='hljl-p'>[</span><span class='hljl-oB'>:</span><span class='hljl-p'>,</span><span class='hljl-ni'>1</span><span class='hljl-p'>]]</span><span class='hljl-t'>
     </span><span class='hljl-n'>X₁Z₂</span><span class='hljl-t'>   </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-p'>[</span><span class='hljl-nf'>ones</span><span class='hljl-p'>(</span><span class='hljl-n'>N</span><span class='hljl-p'>)</span><span class='hljl-t'> </span><span class='hljl-n'>X</span><span class='hljl-p'>[</span><span class='hljl-oB'>:</span><span class='hljl-p'>,</span><span class='hljl-ni'>2</span><span class='hljl-p'>]</span><span class='hljl-t'> </span><span class='hljl-n'>Z</span><span class='hljl-p'>[</span><span class='hljl-oB'>:</span><span class='hljl-p'>,</span><span class='hljl-ni'>2</span><span class='hljl-p'>]]</span><span class='hljl-t'>
     </span><span class='hljl-n'>X₁Z_oi</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-p'>[</span><span class='hljl-nf'>ones</span><span class='hljl-p'>(</span><span class='hljl-n'>N</span><span class='hljl-p'>)</span><span class='hljl-t'> </span><span class='hljl-n'>X</span><span class='hljl-p'>[</span><span class='hljl-oB'>:</span><span class='hljl-p'>,</span><span class='hljl-ni'>2</span><span class='hljl-p'>]</span><span class='hljl-t'> </span><span class='hljl-n'>Z</span><span class='hljl-p'>[</span><span class='hljl-oB'>:</span><span class='hljl-p'>,</span><span class='hljl-ni'>1</span><span class='hljl-p'>]</span><span class='hljl-t'> </span><span class='hljl-n'>Z</span><span class='hljl-p'>[</span><span class='hljl-oB'>:</span><span class='hljl-p'>,</span><span class='hljl-ni'>2</span><span class='hljl-p'>]]</span><span class='hljl-t'> </span><span class='hljl-cs'># over-identified case</span><span class='hljl-t'>
 
     </span><span class='hljl-cs'># Naive OLS produces biased estimates</span><span class='hljl-t'>
     </span><span class='hljl-n'>β_IV_OLS</span><span class='hljl-t'>  </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-nf'>inv</span><span class='hljl-p'>(</span><span class='hljl-n'>X</span><span class='hljl-oB'>&#39;*</span><span class='hljl-n'>X</span><span class='hljl-p'>)</span><span class='hljl-t'> </span><span class='hljl-oB'>*</span><span class='hljl-t'> </span><span class='hljl-n'>X</span><span class='hljl-oB'>&#39;*</span><span class='hljl-n'>y</span><span class='hljl-t'> </span><span class='hljl-cs'># a 3x1 vector</span><span class='hljl-t'>
     </span><span class='hljl-n'>ε_OLS</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-n'>y</span><span class='hljl-t'> </span><span class='hljl-oB'>-</span><span class='hljl-t'> </span><span class='hljl-n'>X</span><span class='hljl-t'> </span><span class='hljl-oB'>*</span><span class='hljl-t'> </span><span class='hljl-n'>β_IV_OLS</span><span class='hljl-t'>
     </span><span class='hljl-n'>invXX</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-nf'>inv</span><span class='hljl-p'>(</span><span class='hljl-n'>X</span><span class='hljl-oB'>&#39;*</span><span class='hljl-n'>X</span><span class='hljl-p'>)</span><span class='hljl-t'>
     </span><span class='hljl-n'>Xε</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-n'>X</span><span class='hljl-oB'>.*</span><span class='hljl-n'>ε_OLS</span><span class='hljl-t'>
     </span><span class='hljl-n'>Σ_IV_OLS</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-n'>invXX</span><span class='hljl-oB'>*</span><span class='hljl-p'>(</span><span class='hljl-n'>Xε</span><span class='hljl-oB'>&#39;*</span><span class='hljl-n'>Xε</span><span class='hljl-p'>)</span><span class='hljl-oB'>*</span><span class='hljl-n'>invXX</span><span class='hljl-t'> </span><span class='hljl-cs'># V_HC0 - White-Heteroskedasticity-Robust VCov</span><span class='hljl-t'>
     </span><span class='hljl-n'>σ_IV_OLS</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-n'>sqrt</span><span class='hljl-oB'>.</span><span class='hljl-p'>(</span><span class='hljl-nf'>diag</span><span class='hljl-p'>(</span><span class='hljl-n'>Σ_IV_OLS</span><span class='hljl-p'>))</span><span class='hljl-t'>

     </span><span class='hljl-cs'># Using Z₁ as instrument</span><span class='hljl-t'>
     </span><span class='hljl-cs'># β_IV_Z₁ = inv(X&#39;*X₁Z₁)*(X₁Z₁&#39;*y)</span><span class='hljl-t'>
     </span><span class='hljl-cs'># ε_IV_Z₁ = y - X * β_IV_Z₁</span><span class='hljl-t'>
     </span><span class='hljl-cs'># invXZ₁  = inv(X&#39;*X₁Z₁)</span><span class='hljl-t'>
     </span><span class='hljl-cs'># Z₁ε     = X₁Z₁.*ε_IV_Z₁</span><span class='hljl-t'>
     </span><span class='hljl-cs'># Σ_IV_Z₁ = invXZ₁*(Z₁ε&#39;*Z₁ε)*invXZ₁</span><span class='hljl-t'>
     </span><span class='hljl-cs'># σ_IV_Z₁ = sqrt.(diag(Σ_IV_Z₁))</span><span class='hljl-t'>

     </span><span class='hljl-cs'># Using Z₂ as instrument</span><span class='hljl-t'>
     </span><span class='hljl-cs'># β_IV_Z₂ = inv(X&#39;*X₁Z₂)*(X₁Z₂&#39;*y)</span><span class='hljl-t'>
     </span><span class='hljl-cs'># ε_IV_Z₂ = y - X * β_IV_Z₂</span><span class='hljl-t'>
     </span><span class='hljl-cs'># invXZ₂  = inv(X&#39;*X₁Z₂)</span><span class='hljl-t'>
     </span><span class='hljl-cs'># Z₂ε     = X₁Z₂.*ε_IV_Z₂</span><span class='hljl-t'>
     </span><span class='hljl-cs'># Σ_IV_Z₂ = invXZ₂*(Z₂ε&#39;*Z₂ε)*invXZ₂</span><span class='hljl-t'>
     </span><span class='hljl-cs'># σ_IV_Z₂ = sqrt.(diag(Σ_IV_Z₂))</span><span class='hljl-t'>

     </span><span class='hljl-cs'># 2SLS - Using Z₁ as instrument</span><span class='hljl-t'>
     </span><span class='hljl-n'>β_2SLS_Z₁</span><span class='hljl-t'>  </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-nf'>inv</span><span class='hljl-p'>(</span><span class='hljl-n'>X</span><span class='hljl-oB'>&#39;*</span><span class='hljl-n'>X₁Z₁</span><span class='hljl-oB'>*</span><span class='hljl-nf'>inv</span><span class='hljl-p'>(</span><span class='hljl-n'>X₁Z₁</span><span class='hljl-oB'>&#39;*</span><span class='hljl-n'>X₁Z₁</span><span class='hljl-p'>)</span><span class='hljl-oB'>*</span><span class='hljl-n'>X₁Z₁</span><span class='hljl-oB'>&#39;*</span><span class='hljl-n'>X</span><span class='hljl-p'>)</span><span class='hljl-oB'>*</span><span class='hljl-n'>X</span><span class='hljl-oB'>&#39;*</span><span class='hljl-n'>X₁Z₁</span><span class='hljl-oB'>*</span><span class='hljl-nf'>inv</span><span class='hljl-p'>(</span><span class='hljl-n'>X₁Z₁</span><span class='hljl-oB'>&#39;*</span><span class='hljl-n'>X₁Z₁</span><span class='hljl-p'>)</span><span class='hljl-oB'>*</span><span class='hljl-n'>X₁Z₁</span><span class='hljl-oB'>&#39;*</span><span class='hljl-n'>y</span><span class='hljl-t'>
     </span><span class='hljl-n'>ε_2SLS_Z₁</span><span class='hljl-t'>  </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-n'>y</span><span class='hljl-t'> </span><span class='hljl-oB'>-</span><span class='hljl-t'> </span><span class='hljl-n'>X</span><span class='hljl-t'> </span><span class='hljl-oB'>*</span><span class='hljl-t'> </span><span class='hljl-n'>β_2SLS_Z₁</span><span class='hljl-t'>
     </span><span class='hljl-n'>Zε_2SLS_Z₁</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-n'>X₁Z₁</span><span class='hljl-oB'>.*</span><span class='hljl-n'>ε_2SLS_Z₁</span><span class='hljl-t'>
     </span><span class='hljl-n'>Qxz₁</span><span class='hljl-t'>  </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-n'>X</span><span class='hljl-oB'>&#39;*</span><span class='hljl-n'>X₁Z₁</span><span class='hljl-t'>
     </span><span class='hljl-n'>Qz₁z₁</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-n'>X₁Z₁</span><span class='hljl-oB'>&#39;*</span><span class='hljl-n'>X₁Z₁</span><span class='hljl-t'>
     </span><span class='hljl-n'>Qz₁x</span><span class='hljl-t'>  </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-n'>X₁Z₁</span><span class='hljl-oB'>&#39;*</span><span class='hljl-n'>X</span><span class='hljl-t'>
     </span><span class='hljl-n'>Ω_2SLS_Z₁</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-n'>Zε_2SLS_Z₁</span><span class='hljl-oB'>&#39;*</span><span class='hljl-n'>Zε_2SLS_Z₁</span><span class='hljl-t'>
     </span><span class='hljl-n'>Σ_2SLS_Z₁</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-nf'>inv</span><span class='hljl-p'>(</span><span class='hljl-n'>Qxz₁</span><span class='hljl-oB'>*</span><span class='hljl-nf'>inv</span><span class='hljl-p'>(</span><span class='hljl-n'>Qz₁z₁</span><span class='hljl-p'>)</span><span class='hljl-oB'>*</span><span class='hljl-n'>Qz₁x</span><span class='hljl-p'>)</span><span class='hljl-oB'>*</span><span class='hljl-p'>(</span><span class='hljl-n'>Qxz₁</span><span class='hljl-oB'>*</span><span class='hljl-nf'>inv</span><span class='hljl-p'>(</span><span class='hljl-n'>Qz₁z₁</span><span class='hljl-p'>)</span><span class='hljl-oB'>*</span><span class='hljl-n'>Ω_2SLS_Z₁</span><span class='hljl-oB'>*</span><span class='hljl-nf'>inv</span><span class='hljl-p'>(</span><span class='hljl-n'>Qz₁z₁</span><span class='hljl-p'>)</span><span class='hljl-oB'>*</span><span class='hljl-n'>Qz₁x</span><span class='hljl-p'>)</span><span class='hljl-oB'>*</span><span class='hljl-nf'>inv</span><span class='hljl-p'>(</span><span class='hljl-n'>Qxz₁</span><span class='hljl-oB'>*</span><span class='hljl-nf'>inv</span><span class='hljl-p'>(</span><span class='hljl-n'>Qz₁z₁</span><span class='hljl-p'>)</span><span class='hljl-oB'>*</span><span class='hljl-n'>Qz₁x</span><span class='hljl-p'>)</span><span class='hljl-t'>
     </span><span class='hljl-n'>σ_2SLS_Z₁</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-n'>sqrt</span><span class='hljl-oB'>.</span><span class='hljl-p'>(</span><span class='hljl-nf'>diag</span><span class='hljl-p'>(</span><span class='hljl-n'>Σ_2SLS_Z₁</span><span class='hljl-p'>))</span><span class='hljl-t'>

     </span><span class='hljl-cs'># 2SLS - Using Z₂ as instrument</span><span class='hljl-t'>
     </span><span class='hljl-cs'># β_2SLS_Z₂  = inv(X&#39;*X₁Z₁*inv(X₁Z₁&#39;*X₁Z₁)*X₁Z₁&#39;*X)*X&#39;*X₁Z₁*inv(X₁Z₁&#39;*X₁Z₁)*X₁Z₁&#39;*y</span><span class='hljl-t'>
     </span><span class='hljl-cs'># ε_2SLS_Z₂  = y - X * β_2SLS_Z₂</span><span class='hljl-t'>
     </span><span class='hljl-cs'># Zε_2SLS_Z₂ = X₁Z₂.*ε_2SLS_Z₂</span><span class='hljl-t'>
     </span><span class='hljl-cs'># Qxz₂  = X&#39;*X₁Z₂</span><span class='hljl-t'>
     </span><span class='hljl-cs'># Qz₂z₂ = X₁Z₂&#39;*X₁Z₂</span><span class='hljl-t'>
     </span><span class='hljl-cs'># Qz₂x  = X₁Z₂&#39;*X</span><span class='hljl-t'>
     </span><span class='hljl-cs'># Ω_2SLS_Z₂ = Zε_2SLS_Z₂&#39;*Zε_2SLS_Z₂</span><span class='hljl-t'>
     </span><span class='hljl-cs'># Σ_2SLS_Z₂ = inv(Qxz₂*inv(Qz₂z₂)*Qz₂x)*(Qxz₂*inv(Qz₂z₂)*Ω_2SLS_Z₂*inv(Qz₂z₂)*Qz₂x)*inv(Qxz₂*inv(Qz₂z₂)*Qz₂x)</span><span class='hljl-t'>
     </span><span class='hljl-cs'># σ_2SLS_Z₂ =sqrt.(diag(Σ_2SLS_Z₂))</span><span class='hljl-t'>

     </span><span class='hljl-cs'># Using Z₁ and Z₂ as instrument: OVERIDENTIFIED!</span><span class='hljl-t'>
     </span><span class='hljl-n'>Qxz</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-n'>X</span><span class='hljl-oB'>&#39;*</span><span class='hljl-n'>X₁Z_oi</span><span class='hljl-t'>
     </span><span class='hljl-n'>Qzz</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-n'>X₁Z_oi</span><span class='hljl-oB'>&#39;*</span><span class='hljl-n'>X₁Z_oi</span><span class='hljl-t'>
     </span><span class='hljl-n'>Qzx</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-n'>X₁Z_oi</span><span class='hljl-oB'>&#39;*</span><span class='hljl-n'>X</span><span class='hljl-t'>
     </span><span class='hljl-n'>β_2SLS_oi</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-nf'>inv</span><span class='hljl-p'>(</span><span class='hljl-n'>Qxz</span><span class='hljl-oB'>*</span><span class='hljl-nf'>inv</span><span class='hljl-p'>(</span><span class='hljl-n'>Qzz</span><span class='hljl-p'>)</span><span class='hljl-oB'>*</span><span class='hljl-n'>Qzx</span><span class='hljl-p'>)</span><span class='hljl-oB'>*</span><span class='hljl-p'>(</span><span class='hljl-n'>Qxz</span><span class='hljl-oB'>*</span><span class='hljl-nf'>inv</span><span class='hljl-p'>(</span><span class='hljl-n'>Qzz</span><span class='hljl-p'>)</span><span class='hljl-oB'>*</span><span class='hljl-n'>X₁Z_oi</span><span class='hljl-oB'>&#39;</span><span class='hljl-p'>)</span><span class='hljl-oB'>*</span><span class='hljl-n'>y</span><span class='hljl-t'>
     </span><span class='hljl-n'>ε_2SLS_oi</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-n'>y</span><span class='hljl-t'> </span><span class='hljl-oB'>-</span><span class='hljl-t'> </span><span class='hljl-n'>X</span><span class='hljl-oB'>*</span><span class='hljl-n'>β_2SLS_oi</span><span class='hljl-t'>
     </span><span class='hljl-n'>Zε</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-n'>X₁Z_oi</span><span class='hljl-oB'>.*</span><span class='hljl-n'>ε_2SLS_oi</span><span class='hljl-t'>
     </span><span class='hljl-n'>Ω_2SLS_oi</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-n'>Zε</span><span class='hljl-oB'>&#39;*</span><span class='hljl-n'>Zε</span><span class='hljl-t'>
     </span><span class='hljl-n'>Σ_2SLS_oi</span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-nf'>inv</span><span class='hljl-p'>(</span><span class='hljl-n'>Qxz</span><span class='hljl-oB'>*</span><span class='hljl-nf'>inv</span><span class='hljl-p'>(</span><span class='hljl-n'>Qzz</span><span class='hljl-p'>)</span><span class='hljl-oB'>*</span><span class='hljl-n'>Qzx</span><span class='hljl-p'>)</span><span class='hljl-oB'>*</span><span class='hljl-p'>(</span><span class='hljl-n'>Qxz</span><span class='hljl-oB'>*</span><span class='hljl-nf'>inv</span><span class='hljl-p'>(</span><span class='hljl-n'>Qzz</span><span class='hljl-p'>)</span><span class='hljl-oB'>*</span><span class='hljl-n'>Ω_2SLS_oi</span><span class='hljl-oB'>*</span><span class='hljl-nf'>inv</span><span class='hljl-p'>(</span><span class='hljl-n'>Qzz</span><span class='hljl-p'>)</span><span class='hljl-oB'>*</span><span class='hljl-n'>Qzx</span><span class='hljl-p'>)</span><span class='hljl-oB'>*</span><span class='hljl-nf'>inv</span><span class='hljl-p'>(</span><span class='hljl-n'>Qxz</span><span class='hljl-oB'>*</span><span class='hljl-nf'>inv</span><span class='hljl-p'>(</span><span class='hljl-n'>Qzz</span><span class='hljl-p'>)</span><span class='hljl-oB'>*</span><span class='hljl-n'>Qzx</span><span class='hljl-p'>)</span><span class='hljl-t'>
     </span><span class='hljl-n'>σ_2SLS_oi</span><span class='hljl-oB'>=</span><span class='hljl-n'>sqrt</span><span class='hljl-oB'>.</span><span class='hljl-p'>(</span><span class='hljl-nf'>diag</span><span class='hljl-p'>(</span><span class='hljl-n'>Σ_2SLS_oi</span><span class='hljl-p'>))</span><span class='hljl-t'>

     </span><span class='hljl-cs'># β_IV_Z₁,   σ_IV_Z₁,</span><span class='hljl-t'>
     </span><span class='hljl-cs'># β_IV_Z₂,   σ_IV_Z₂,</span><span class='hljl-t'>
     </span><span class='hljl-cs'># β_2SLS_Z₁, σ_2SLS_Z₁,</span><span class='hljl-t'>
     </span><span class='hljl-cs'># β_2SLS_Z₂, σ_2SLS_Z₂,</span><span class='hljl-t'>

     </span><span class='hljl-k'>return</span><span class='hljl-t'> </span><span class='hljl-n'>β_IV_OLS</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>σ_IV_OLS</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>β_2SLS_Z₁</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>σ_2SLS_Z₁</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>β_2SLS_oi</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>σ_2SLS_oi</span><span class='hljl-t'>
</span><span class='hljl-k'>end</span><span class='hljl-p'>;</span>
</pre>




<pre class='hljl'>
<span class='hljl-cs'># order: x₂, Z₁, Z₂, ε</span><span class='hljl-t'>
</span><span class='hljl-n'>μ</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-p'>[</span><span class='hljl-nfB'>0.0</span><span class='hljl-p'>;</span><span class='hljl-t'> </span><span class='hljl-nfB'>0.0</span><span class='hljl-p'>;</span><span class='hljl-t'> </span><span class='hljl-nfB'>0.0</span><span class='hljl-p'>;</span><span class='hljl-t'> </span><span class='hljl-nfB'>0.0</span><span class='hljl-p'>];</span><span class='hljl-t'>
</span><span class='hljl-n'>Σ</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-p'>[</span><span class='hljl-nfB'>2.0</span><span class='hljl-t'>  </span><span class='hljl-nfB'>0.5</span><span class='hljl-t'>  </span><span class='hljl-oB'>-</span><span class='hljl-nfB'>.5</span><span class='hljl-t'>  </span><span class='hljl-nfB'>1.0</span><span class='hljl-p'>;</span><span class='hljl-t'>
     </span><span class='hljl-nfB'>0.5</span><span class='hljl-t'>  </span><span class='hljl-nfB'>1.0</span><span class='hljl-t'>  </span><span class='hljl-nfB'>0.5</span><span class='hljl-t'>  </span><span class='hljl-nfB'>0.0</span><span class='hljl-p'>;</span><span class='hljl-t'>
     </span><span class='hljl-oB'>-</span><span class='hljl-nfB'>.5</span><span class='hljl-t'>  </span><span class='hljl-nfB'>0.5</span><span class='hljl-t'>  </span><span class='hljl-nfB'>1.0</span><span class='hljl-t'>  </span><span class='hljl-nfB'>0.0</span><span class='hljl-p'>;</span><span class='hljl-t'>
     </span><span class='hljl-nfB'>1.0</span><span class='hljl-t'>  </span><span class='hljl-nfB'>0.0</span><span class='hljl-t'>  </span><span class='hljl-nfB'>0.0</span><span class='hljl-t'>  </span><span class='hljl-nfB'>2.0</span><span class='hljl-p'>];</span><span class='hljl-t'>
</span><span class='hljl-n'>Y_LIV</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>X_LIV</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>Z_LIV</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-nf'>DGP_LIV</span><span class='hljl-p'>(</span><span class='hljl-n'>N</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>β_DGP</span><span class='hljl-p'>,</span><span class='hljl-n'>μ</span><span class='hljl-p'>,</span><span class='hljl-n'>Σ</span><span class='hljl-p'>);</span><span class='hljl-t'>
</span><span class='hljl-n'>β_IV_OLS</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>σ_IV_OLS</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>β_2SLS_Z₁</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>σ_2SLS_Z₁</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>β_2SLS_oi</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>σ_2SLS_oi</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-nf'>LIV_estimation</span><span class='hljl-p'>(</span><span class='hljl-n'>Y_LIV</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>X_LIV</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>Z_LIV</span><span class='hljl-p'>);</span><span class='hljl-t'>

</span><span class='hljl-nf'>print</span><span class='hljl-p'>(</span><span class='hljl-s'>&quot;LIV result: β₂ is biased in OLS </span><span class='hljl-se'>\n</span><span class='hljl-s'>&quot;</span><span class='hljl-p'>)</span><span class='hljl-t'>
</span><span class='hljl-nf'>print</span><span class='hljl-p'>(</span><span class='hljl-s'>&quot;        |     β₀     |     β₁     |     β₂     | </span><span class='hljl-se'>\n</span><span class='hljl-s'>&quot;</span><span class='hljl-p'>)</span><span class='hljl-t'>
</span><span class='hljl-nd'>@printf</span><span class='hljl-p'>(</span><span class='hljl-s'>&quot;DGP     | %10.7f | %10.7f | %10.7f |</span><span class='hljl-se'>\n</span><span class='hljl-s'>&quot;</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>β_DGP</span><span class='hljl-p'>[</span><span class='hljl-ni'>1</span><span class='hljl-p'>],</span><span class='hljl-t'> </span><span class='hljl-n'>β_DGP</span><span class='hljl-p'>[</span><span class='hljl-ni'>2</span><span class='hljl-p'>],</span><span class='hljl-t'> </span><span class='hljl-n'>β_DGP</span><span class='hljl-p'>[</span><span class='hljl-ni'>3</span><span class='hljl-p'>])</span><span class='hljl-t'>
</span><span class='hljl-nd'>@printf</span><span class='hljl-p'>(</span><span class='hljl-s'>&quot;OLS     | %10.7f | %10.7f | %10.7f |</span><span class='hljl-se'>\n</span><span class='hljl-s'>&quot;</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>β_IV_OLS</span><span class='hljl-p'>[</span><span class='hljl-ni'>1</span><span class='hljl-p'>],</span><span class='hljl-t'> </span><span class='hljl-n'>β_IV_OLS</span><span class='hljl-p'>[</span><span class='hljl-ni'>2</span><span class='hljl-p'>],</span><span class='hljl-t'> </span><span class='hljl-n'>β_IV_OLS</span><span class='hljl-p'>[</span><span class='hljl-ni'>3</span><span class='hljl-p'>])</span><span class='hljl-t'>
</span><span class='hljl-nd'>@printf</span><span class='hljl-p'>(</span><span class='hljl-s'>&quot;        |(%10.7f)|(%10.7f)|(%10.7f)|</span><span class='hljl-se'>\n</span><span class='hljl-s'>&quot;</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>σ_OLS</span><span class='hljl-p'>[</span><span class='hljl-ni'>1</span><span class='hljl-p'>],</span><span class='hljl-t'> </span><span class='hljl-n'>σ_OLS</span><span class='hljl-p'>[</span><span class='hljl-ni'>2</span><span class='hljl-p'>],</span><span class='hljl-t'> </span><span class='hljl-n'>σ_OLS</span><span class='hljl-p'>[</span><span class='hljl-ni'>3</span><span class='hljl-p'>])</span><span class='hljl-t'>
</span><span class='hljl-cs'>#@printf(&quot;IV-Z₁   | %10.7f | %10.7f | %10.7f |\n&quot;, β_IV_Z₁[1], β_IV_Z₁[2], β_IV_Z₁[3])</span><span class='hljl-t'>
</span><span class='hljl-cs'>#@printf(&quot;        |(%10.7f)|(%10.7f)|(%10.7f)|\n&quot;, σ_IV_Z₁[1], σ_IV_Z₁[2], σ_IV_Z₁[3])</span><span class='hljl-t'>
</span><span class='hljl-cs'>#@printf(&quot;IV-Z₂   | %10.7f | %10.7f | %10.7f |\n&quot;, β_IV_Z₂[1], β_IV_Z₂[2], β_IV_Z₂[3])</span><span class='hljl-t'>
</span><span class='hljl-cs'>#@printf(&quot;        |(%10.7f)|(%10.7f)|(%10.7f)|\n&quot;, σ_IV_Z₂[1], σ_IV_Z₂[2], σ_IV_Z₂[3])</span><span class='hljl-t'>
</span><span class='hljl-nd'>@printf</span><span class='hljl-p'>(</span><span class='hljl-s'>&quot;2SLS-Z₁ | %10.7f | %10.7f | %10.7f |</span><span class='hljl-se'>\n</span><span class='hljl-s'>&quot;</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>β_2SLS_Z₁</span><span class='hljl-p'>[</span><span class='hljl-ni'>1</span><span class='hljl-p'>],</span><span class='hljl-t'> </span><span class='hljl-n'>β_2SLS_Z₁</span><span class='hljl-p'>[</span><span class='hljl-ni'>2</span><span class='hljl-p'>],</span><span class='hljl-t'> </span><span class='hljl-n'>β_2SLS_Z₁</span><span class='hljl-p'>[</span><span class='hljl-ni'>3</span><span class='hljl-p'>])</span><span class='hljl-t'>
</span><span class='hljl-nd'>@printf</span><span class='hljl-p'>(</span><span class='hljl-s'>&quot;        |(%10.7f)|(%10.7f)|(%10.7f)|</span><span class='hljl-se'>\n</span><span class='hljl-s'>&quot;</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>σ_2SLS_Z₁</span><span class='hljl-p'>[</span><span class='hljl-ni'>1</span><span class='hljl-p'>],</span><span class='hljl-t'> </span><span class='hljl-n'>σ_2SLS_Z₁</span><span class='hljl-p'>[</span><span class='hljl-ni'>2</span><span class='hljl-p'>],</span><span class='hljl-t'> </span><span class='hljl-n'>σ_2SLS_Z₁</span><span class='hljl-p'>[</span><span class='hljl-ni'>3</span><span class='hljl-p'>])</span><span class='hljl-t'>
</span><span class='hljl-cs'>#@printf(&quot;2SLS-Z₂ | %10.7f | %10.7f | %10.7f |\n&quot;, β_2SLS_Z₂[1], β_2SLS_Z₂[2], β_2SLS_Z₂[3])</span><span class='hljl-t'>
</span><span class='hljl-cs'>#@printf(&quot;        |(%7.4f)|(%7.4f)|(%7.4f)|\n&quot;, σ_2SLS_Z₂[1], σ_2SLS_Z₂[2], σ_2SLS_Z₂[3])</span><span class='hljl-t'>
</span><span class='hljl-nd'>@printf</span><span class='hljl-p'>(</span><span class='hljl-s'>&quot;2SLS-oi | %10.7f | %10.7f | %10.7f |</span><span class='hljl-se'>\n</span><span class='hljl-s'>&quot;</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>β_2SLS_oi</span><span class='hljl-p'>[</span><span class='hljl-ni'>1</span><span class='hljl-p'>],</span><span class='hljl-t'> </span><span class='hljl-n'>β_2SLS_oi</span><span class='hljl-p'>[</span><span class='hljl-ni'>2</span><span class='hljl-p'>],</span><span class='hljl-t'> </span><span class='hljl-n'>β_2SLS_oi</span><span class='hljl-p'>[</span><span class='hljl-ni'>3</span><span class='hljl-p'>])</span><span class='hljl-t'>
</span><span class='hljl-nd'>@printf</span><span class='hljl-p'>(</span><span class='hljl-s'>&quot;        |(%10.7f)|(%10.7f)|(%10.7f)|</span><span class='hljl-se'>\n</span><span class='hljl-s'>&quot;</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>σ_2SLS_oi</span><span class='hljl-p'>[</span><span class='hljl-ni'>1</span><span class='hljl-p'>],</span><span class='hljl-t'> </span><span class='hljl-n'>σ_2SLS_oi</span><span class='hljl-p'>[</span><span class='hljl-ni'>2</span><span class='hljl-p'>],</span><span class='hljl-t'> </span><span class='hljl-n'>σ_2SLS_oi</span><span class='hljl-p'>[</span><span class='hljl-ni'>3</span><span class='hljl-p'>])</span><span class='hljl-t'>
</span><span class='hljl-nf'>print</span><span class='hljl-p'>(</span><span class='hljl-s'>&quot;Standard errors in parentheses.&quot;</span><span class='hljl-p'>)</span>
</pre>


<pre class="output">
LIV result: β₂ is biased in OLS 
        |     β₀     |     β₁     |     β₂     | 
DGP     |  0.1500000 |  0.2500000 | -1.5000000 |
OLS     |  0.1479366 |  0.2514084 | -1.0057541 |
        |&#40; 0.0038011&#41;|&#40; 0.0037832&#41;|&#40; 0.0038027&#41;|
2SLS-Z₁ |  0.1467703 |  0.2517546 | -1.4979841 |
        |&#40; 0.0044668&#41;|&#40; 0.0044696&#41;|&#40; 0.0088246&#41;|
2SLS-oi |  0.1467379 |  0.2517642 | -1.5116826 |
        |&#40; 0.0044974&#41;|&#40; 0.0045002&#41;|&#40; 0.0044776&#41;|
Standard errors in parentheses.
</pre>


<p>You can see that LIV estimate for <span class="math">$\beta_2$</span> in over-identified case has smaller standard error compared to just-identified case. Motivated by these examples, let&#39;s take a look at what GMM does:</p>

<h4>Definition &#40;<a href="https://www.ssc.wisc.edu/~bhansen/econometrics/Econometrics.pdf">Bruce Hansen, p.416</a>&#41;</h4>
<p>Let <span class="math">$\beta$</span> be a <span class="math">$k\times1$</span> vector, <span class="math">$f_i(\beta)$</span> be a <span class="math">$l\times1$</span> orthogonality conditions, and <span class="math">$W$</span> be a <span class="math">$l\times l$</span> positive definite weighting matrix. Define the GMM criterion function <span class="math">$J(\beta)$</span> as</p>
<p class="math">\[
    J(\beta) = N \left(\frac{1}{N}\sum_{i=1}^N f_i(\beta)\right)' W \left(\frac{1}{N}\sum_{i=1}^N f_i(\beta)\right).
\]</p>
<p>The GMM estimator is </p>
<p class="math">\[
    \hat{\beta}_{gmm} = \underset{\beta}{\arg\min}\; J(\beta).
\]</p>
<h4>Proposition &#40;<a href="https://www.ssc.wisc.edu/~bhansen/econometrics/Econometrics.pdf">Bruce Hansen, p.432</a>&#41;</h4>
<p>Under general regularity conditions, <span class="math">$\sqrt{N}(\hat{\beta}_{gmm}-\beta_0) \xrightarrow[]{d} N(0,V_\beta)$</span> where </p>
<p class="math">\[
\begin{align*}
    V_\beta &= (Q'WQ)^{-1}(Q'W\Omega WQ)(Q'WQ)^{-1}\\
    \Omega &= \mathbb{E}(f_i f_i') \\
    Q &= \mathbb{E}\left[\frac{\partial}{\partial \beta'}f_i(\beta)\right].
\end{align*}
\]</p>
<p>If <span class="math">$W$</span> is efficient, <span class="math">$V_\beta = (Q'\Omega^{-1} Q)^{-1}$</span>.</p>

<p>Note that when you compute standard errors for <span class="math">$\hat{\beta}_{gmm}$</span>, you must divide <span class="math">$V_\beta$</span> by <span class="math">$N$</span>&#33; <span class="math">$V_\beta$</span> is the variance for <span class="math">$\sqrt{N}(\hat{\beta}_{gmm}-\beta)$</span>, not <span class="math">$\hat{\beta}_{gmm}$</span> .</p>

<h4>Two-step GMM &#40;<a href="https://www.ssc.wisc.edu/~bhansen/econometrics/Econometrics.pdf">Bruce Hansen, p.444</a>&#41;</h4>
<p>In order to construct the efficient GMM estimator, we need to know what is the optimal <span class="math">$W$</span> in our model. In LIV, we know that <span class="math">$W=(Z'Z)^{-1}$</span>. If the optimal weighting matrix <span class="math">$W=\Omega^{-1}$</span> is unknown, then we can first estimate <span class="math">$W$</span> with a standard GMM routine &#40;say, by setting <span class="math">$W=I$</span>&#41;, and then do the GMM routine again with <span class="math">$W=\hat{\Omega}^{-1}$</span>.</p>
<h4>Programming</h4>
<p>In this case, we can simply code GMM as follows:</p>
<ol>
<li><p>Set some weighting matrix <span class="math">$W$</span>. In our example, for the just-identified case, use <span class="math">$W=I$</span> and for the over-identified case, use <span class="math">$W=(Z'Z)^{-1}$</span>.</p>
</li>
<li><p>Construct the GMM criterion function. It is <strong>obj_IV</strong> in my code.</p>
</li>
<li><p>Ask the computer to minimize the criterion function for you. The minimizer is your <span class="math">$\hat{\beta}_{gmm}$</span>.</p>
</li>
<li><p>Compute <span class="math">$Q$</span> and <span class="math">$\Omega$</span>.</p>
<ul>
<li><p>If you are using a two-step GMM, then repeat step 3 and 4 by setting <span class="math">$W=\hat{\Omega}^{-1}$</span></p>
</li>
</ul>
</li>
<li><p>Compute the asymptotic variance <span class="math">$V_\beta$</span>. </p>
</li>
<li><p>Compute standard errors with <span class="math">$\textbf{sqrt}.(\textbf{diag}(\mathbf{V_\beta}/N))$</span></p>
</li>
</ol>


<pre class='hljl'>
<span class='hljl-cs'>#%% GMM_IV</span><span class='hljl-t'>
</span><span class='hljl-k'>function</span><span class='hljl-t'> </span><span class='hljl-nf'>GMM_one_step</span><span class='hljl-p'>(</span><span class='hljl-n'>y</span><span class='hljl-p'>,</span><span class='hljl-n'>Z_data</span><span class='hljl-p'>,</span><span class='hljl-n'>X_data</span><span class='hljl-p'>;</span><span class='hljl-n'>W</span><span class='hljl-oB'>=</span><span class='hljl-n'>I</span><span class='hljl-p'>)</span><span class='hljl-t'>

    </span><span class='hljl-cm'>#=
    f_IV(β, y, Z, X): orthogonality conditions
    W: the weighting matrix. In one-step GMM, we do not update this.
    =#</span><span class='hljl-t'>
   
    </span><span class='hljl-n'>N</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-nf'>length</span><span class='hljl-p'>(</span><span class='hljl-n'>y</span><span class='hljl-p'>)</span><span class='hljl-t'>
    </span><span class='hljl-n'>X</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-p'>[</span><span class='hljl-nf'>ones</span><span class='hljl-p'>(</span><span class='hljl-n'>N</span><span class='hljl-p'>)</span><span class='hljl-t'> </span><span class='hljl-n'>X_data</span><span class='hljl-p'>]</span><span class='hljl-t'>
    </span><span class='hljl-n'>Z</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-p'>[</span><span class='hljl-nf'>ones</span><span class='hljl-p'>(</span><span class='hljl-n'>N</span><span class='hljl-p'>)</span><span class='hljl-t'> </span><span class='hljl-n'>X_data</span><span class='hljl-p'>[</span><span class='hljl-oB'>:</span><span class='hljl-p'>,</span><span class='hljl-ni'>1</span><span class='hljl-p'>]</span><span class='hljl-t'> </span><span class='hljl-n'>Z_data</span><span class='hljl-p'>]</span><span class='hljl-t'>
    </span><span class='hljl-n'>k</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-nf'>size</span><span class='hljl-p'>(</span><span class='hljl-n'>X</span><span class='hljl-p'>)[</span><span class='hljl-ni'>2</span><span class='hljl-p'>]</span><span class='hljl-t'> </span><span class='hljl-cs'># size of β</span><span class='hljl-t'>
    
    </span><span class='hljl-k'>function</span><span class='hljl-t'> </span><span class='hljl-nf'>f_IV</span><span class='hljl-p'>(</span><span class='hljl-n'>β</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>y</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>Z</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>X</span><span class='hljl-p'>)</span><span class='hljl-t'>
        </span><span class='hljl-k'>return</span><span class='hljl-t'> </span><span class='hljl-p'>(</span><span class='hljl-n'>y</span><span class='hljl-t'> </span><span class='hljl-oB'>-</span><span class='hljl-t'> </span><span class='hljl-n'>X</span><span class='hljl-oB'>*</span><span class='hljl-n'>β</span><span class='hljl-p'>)</span><span class='hljl-t'> </span><span class='hljl-oB'>.*</span><span class='hljl-t'> </span><span class='hljl-n'>Z</span><span class='hljl-t'> </span><span class='hljl-cs'># (N×1) * (N×4)</span><span class='hljl-t'>
    </span><span class='hljl-k'>end</span><span class='hljl-t'>
    
    </span><span class='hljl-nf'>f_sum_IV</span><span class='hljl-p'>(</span><span class='hljl-n'>β</span><span class='hljl-p'>)</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-nf'>vec</span><span class='hljl-p'>(</span><span class='hljl-nf'>sum</span><span class='hljl-p'>(</span><span class='hljl-nf'>f_IV</span><span class='hljl-p'>(</span><span class='hljl-n'>β</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>y</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>Z</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>X</span><span class='hljl-p'>),</span><span class='hljl-n'>dims</span><span class='hljl-oB'>=</span><span class='hljl-ni'>1</span><span class='hljl-p'>));</span><span class='hljl-t'>
    </span><span class='hljl-nf'>obj_IV</span><span class='hljl-p'>(</span><span class='hljl-n'>β</span><span class='hljl-p'>)</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-n'>N</span><span class='hljl-t'> </span><span class='hljl-oB'>*</span><span class='hljl-t'> </span><span class='hljl-p'>(</span><span class='hljl-nf'>f_sum_IV</span><span class='hljl-p'>(</span><span class='hljl-n'>β</span><span class='hljl-p'>)</span><span class='hljl-oB'>/</span><span class='hljl-n'>N</span><span class='hljl-p'>)</span><span class='hljl-oB'>&#39;</span><span class='hljl-t'> </span><span class='hljl-oB'>*</span><span class='hljl-t'> </span><span class='hljl-n'>W</span><span class='hljl-t'> </span><span class='hljl-oB'>*</span><span class='hljl-t'> </span><span class='hljl-p'>(</span><span class='hljl-nf'>f_sum_IV</span><span class='hljl-p'>(</span><span class='hljl-n'>β</span><span class='hljl-p'>)</span><span class='hljl-oB'>/</span><span class='hljl-n'>N</span><span class='hljl-p'>);</span><span class='hljl-t'>
    </span><span class='hljl-n'>opt</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-nf'>optimize</span><span class='hljl-p'>(</span><span class='hljl-n'>obj_IV</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-nf'>randn</span><span class='hljl-p'>(</span><span class='hljl-n'>k</span><span class='hljl-p'>),</span><span class='hljl-t'> </span><span class='hljl-nf'>BFGS</span><span class='hljl-p'>(),</span><span class='hljl-t'> </span><span class='hljl-n'>autodiff</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-sc'>:forward</span><span class='hljl-p'>);</span><span class='hljl-t'>
    </span><span class='hljl-n'>β_GMM</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-n'>opt</span><span class='hljl-oB'>.</span><span class='hljl-n'>minimizer</span><span class='hljl-t'>
    </span><span class='hljl-n'>Q</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-n'>ForwardDiff</span><span class='hljl-oB'>.</span><span class='hljl-nf'>jacobian</span><span class='hljl-p'>(</span><span class='hljl-n'>β</span><span class='hljl-t'> </span><span class='hljl-oB'>-&gt;</span><span class='hljl-t'> </span><span class='hljl-nf'>f_sum_IV</span><span class='hljl-p'>(</span><span class='hljl-n'>β</span><span class='hljl-p'>)</span><span class='hljl-t'> </span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>β_GMM</span><span class='hljl-p'>)</span><span class='hljl-oB'>/</span><span class='hljl-n'>N</span><span class='hljl-p'>;</span><span class='hljl-t'>
    </span><span class='hljl-n'>Ω</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-nf'>f_IV</span><span class='hljl-p'>(</span><span class='hljl-n'>β_GMM</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>y</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>Z</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>X</span><span class='hljl-p'>)</span><span class='hljl-oB'>&#39;*</span><span class='hljl-nf'>f_IV</span><span class='hljl-p'>(</span><span class='hljl-n'>β_GMM</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>y</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>Z</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>X</span><span class='hljl-p'>)</span><span class='hljl-oB'>/</span><span class='hljl-n'>N</span><span class='hljl-p'>;</span><span class='hljl-t'>
    </span><span class='hljl-n'>V_GMM</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-nf'>inv</span><span class='hljl-p'>(</span><span class='hljl-n'>Q</span><span class='hljl-oB'>&#39;*</span><span class='hljl-n'>W</span><span class='hljl-oB'>*</span><span class='hljl-n'>Q</span><span class='hljl-p'>)</span><span class='hljl-oB'>*</span><span class='hljl-p'>(</span><span class='hljl-n'>Q</span><span class='hljl-oB'>&#39;*</span><span class='hljl-n'>W</span><span class='hljl-oB'>*</span><span class='hljl-n'>Ω</span><span class='hljl-oB'>*</span><span class='hljl-n'>W</span><span class='hljl-oB'>*</span><span class='hljl-n'>Q</span><span class='hljl-p'>)</span><span class='hljl-oB'>*</span><span class='hljl-nf'>inv</span><span class='hljl-p'>(</span><span class='hljl-n'>Q</span><span class='hljl-oB'>&#39;*</span><span class='hljl-n'>W</span><span class='hljl-oB'>*</span><span class='hljl-n'>Q</span><span class='hljl-p'>)</span><span class='hljl-oB'>/</span><span class='hljl-n'>N</span><span class='hljl-p'>;</span><span class='hljl-t'> </span><span class='hljl-cs'># remember to divide by N!</span><span class='hljl-t'>
    </span><span class='hljl-n'>σ_GMM</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-n'>sqrt</span><span class='hljl-oB'>.</span><span class='hljl-p'>(</span><span class='hljl-nf'>diag</span><span class='hljl-p'>(</span><span class='hljl-n'>V_GMM</span><span class='hljl-p'>))</span><span class='hljl-t'>

    </span><span class='hljl-k'>return</span><span class='hljl-t'> </span><span class='hljl-n'>β_GMM</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>σ_GMM</span><span class='hljl-t'>

</span><span class='hljl-k'>end</span><span class='hljl-p'>;</span>
</pre>




<pre class='hljl'>
<span class='hljl-k'>function</span><span class='hljl-t'> </span><span class='hljl-nf'>GMM_two_step</span><span class='hljl-p'>(</span><span class='hljl-n'>y</span><span class='hljl-p'>,</span><span class='hljl-n'>Z_data</span><span class='hljl-p'>,</span><span class='hljl-n'>X_data</span><span class='hljl-p'>)</span><span class='hljl-t'>

    </span><span class='hljl-cm'>#=
    f_IV(β, y, Z, X): orthogonality conditions
    W: the weighting matrix. In this case, we update this once.
    =#</span><span class='hljl-t'>

    </span><span class='hljl-n'>N</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-nf'>length</span><span class='hljl-p'>(</span><span class='hljl-n'>y</span><span class='hljl-p'>)</span><span class='hljl-t'>
    </span><span class='hljl-n'>X</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-p'>[</span><span class='hljl-nf'>ones</span><span class='hljl-p'>(</span><span class='hljl-n'>N</span><span class='hljl-p'>)</span><span class='hljl-t'> </span><span class='hljl-n'>X_data</span><span class='hljl-p'>]</span><span class='hljl-t'>
    </span><span class='hljl-n'>Z</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-p'>[</span><span class='hljl-nf'>ones</span><span class='hljl-p'>(</span><span class='hljl-n'>N</span><span class='hljl-p'>)</span><span class='hljl-t'> </span><span class='hljl-n'>X_data</span><span class='hljl-p'>[</span><span class='hljl-oB'>:</span><span class='hljl-p'>,</span><span class='hljl-ni'>1</span><span class='hljl-p'>]</span><span class='hljl-t'> </span><span class='hljl-n'>Z_data</span><span class='hljl-p'>]</span><span class='hljl-t'>
    </span><span class='hljl-n'>k</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-nf'>size</span><span class='hljl-p'>(</span><span class='hljl-n'>X</span><span class='hljl-p'>)[</span><span class='hljl-ni'>2</span><span class='hljl-p'>]</span><span class='hljl-t'> </span><span class='hljl-cs'># size of β</span><span class='hljl-t'>
    
    </span><span class='hljl-k'>function</span><span class='hljl-t'> </span><span class='hljl-nf'>f_IV</span><span class='hljl-p'>(</span><span class='hljl-n'>β</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>y</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>Z</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>X</span><span class='hljl-p'>)</span><span class='hljl-t'>
        </span><span class='hljl-k'>return</span><span class='hljl-t'> </span><span class='hljl-p'>(</span><span class='hljl-n'>y</span><span class='hljl-t'> </span><span class='hljl-oB'>-</span><span class='hljl-t'> </span><span class='hljl-n'>X</span><span class='hljl-oB'>*</span><span class='hljl-n'>β</span><span class='hljl-p'>)</span><span class='hljl-t'> </span><span class='hljl-oB'>.*</span><span class='hljl-t'> </span><span class='hljl-n'>Z</span><span class='hljl-t'> </span><span class='hljl-cs'># (N×1) * (N×4)</span><span class='hljl-t'>
    </span><span class='hljl-k'>end</span><span class='hljl-t'>
    </span><span class='hljl-nf'>f_sum_IV</span><span class='hljl-p'>(</span><span class='hljl-n'>β</span><span class='hljl-p'>)</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-nf'>vec</span><span class='hljl-p'>(</span><span class='hljl-nf'>sum</span><span class='hljl-p'>(</span><span class='hljl-nf'>f_IV</span><span class='hljl-p'>(</span><span class='hljl-n'>β</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>y</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>Z</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>X</span><span class='hljl-p'>),</span><span class='hljl-n'>dims</span><span class='hljl-oB'>=</span><span class='hljl-ni'>1</span><span class='hljl-p'>));</span><span class='hljl-t'>
    
    </span><span class='hljl-cs'># First-step: the estimates and the standard errors are the same as setting W=I in one-step GMM.</span><span class='hljl-t'>
    </span><span class='hljl-n'>W_1</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-n'>I</span><span class='hljl-p'>;</span><span class='hljl-t'>
    </span><span class='hljl-nf'>obj_GMM_1</span><span class='hljl-p'>(</span><span class='hljl-n'>β</span><span class='hljl-p'>)</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-n'>N</span><span class='hljl-t'> </span><span class='hljl-oB'>*</span><span class='hljl-t'> </span><span class='hljl-p'>(</span><span class='hljl-nf'>f_sum_IV</span><span class='hljl-p'>(</span><span class='hljl-n'>β</span><span class='hljl-p'>)</span><span class='hljl-oB'>/</span><span class='hljl-n'>N</span><span class='hljl-p'>)</span><span class='hljl-oB'>&#39;</span><span class='hljl-t'> </span><span class='hljl-oB'>*</span><span class='hljl-t'> </span><span class='hljl-n'>W_1</span><span class='hljl-t'> </span><span class='hljl-oB'>*</span><span class='hljl-t'> </span><span class='hljl-p'>(</span><span class='hljl-nf'>f_sum_IV</span><span class='hljl-p'>(</span><span class='hljl-n'>β</span><span class='hljl-p'>)</span><span class='hljl-oB'>/</span><span class='hljl-n'>N</span><span class='hljl-p'>);</span><span class='hljl-t'>
    </span><span class='hljl-n'>opt_1</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-nf'>optimize</span><span class='hljl-p'>(</span><span class='hljl-n'>obj_GMM_1</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-nf'>randn</span><span class='hljl-p'>(</span><span class='hljl-n'>k</span><span class='hljl-p'>),</span><span class='hljl-t'> </span><span class='hljl-nf'>BFGS</span><span class='hljl-p'>(),</span><span class='hljl-t'> </span><span class='hljl-n'>autodiff</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-sc'>:forward</span><span class='hljl-p'>);</span><span class='hljl-t'>
    </span><span class='hljl-n'>β_GMM_1</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-n'>opt_1</span><span class='hljl-oB'>.</span><span class='hljl-n'>minimizer</span><span class='hljl-t'>
    </span><span class='hljl-n'>Q_1</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-n'>ForwardDiff</span><span class='hljl-oB'>.</span><span class='hljl-nf'>jacobian</span><span class='hljl-p'>(</span><span class='hljl-n'>β</span><span class='hljl-t'> </span><span class='hljl-oB'>-&gt;</span><span class='hljl-t'> </span><span class='hljl-nf'>f_sum_IV</span><span class='hljl-p'>(</span><span class='hljl-n'>β</span><span class='hljl-p'>)</span><span class='hljl-t'> </span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>β_GMM_1</span><span class='hljl-p'>)</span><span class='hljl-oB'>/</span><span class='hljl-n'>N</span><span class='hljl-p'>;</span><span class='hljl-t'>
    </span><span class='hljl-n'>Ω_1</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-nf'>f_IV</span><span class='hljl-p'>(</span><span class='hljl-n'>β_GMM_1</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>y</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>Z</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>X</span><span class='hljl-p'>)</span><span class='hljl-oB'>&#39;*</span><span class='hljl-nf'>f_IV</span><span class='hljl-p'>(</span><span class='hljl-n'>β_GMM_1</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>y</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>Z</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>X</span><span class='hljl-p'>)</span><span class='hljl-oB'>/</span><span class='hljl-n'>N</span><span class='hljl-p'>;</span><span class='hljl-t'>

    </span><span class='hljl-cs'># Second-step</span><span class='hljl-t'>
    </span><span class='hljl-n'>W_opt</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-nf'>inv</span><span class='hljl-p'>(</span><span class='hljl-n'>Ω_1</span><span class='hljl-p'>)</span><span class='hljl-t'>
    </span><span class='hljl-nf'>obj_GMM_2</span><span class='hljl-p'>(</span><span class='hljl-n'>β</span><span class='hljl-p'>)</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-n'>N</span><span class='hljl-t'> </span><span class='hljl-oB'>*</span><span class='hljl-t'> </span><span class='hljl-p'>(</span><span class='hljl-nf'>f_sum_IV</span><span class='hljl-p'>(</span><span class='hljl-n'>β</span><span class='hljl-p'>)</span><span class='hljl-oB'>/</span><span class='hljl-n'>N</span><span class='hljl-p'>)</span><span class='hljl-oB'>&#39;</span><span class='hljl-t'> </span><span class='hljl-oB'>*</span><span class='hljl-t'> </span><span class='hljl-n'>W_opt</span><span class='hljl-t'> </span><span class='hljl-oB'>*</span><span class='hljl-t'> </span><span class='hljl-p'>(</span><span class='hljl-nf'>f_sum_IV</span><span class='hljl-p'>(</span><span class='hljl-n'>β</span><span class='hljl-p'>)</span><span class='hljl-oB'>/</span><span class='hljl-n'>N</span><span class='hljl-p'>);</span><span class='hljl-t'>
    </span><span class='hljl-n'>opt_2</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-nf'>optimize</span><span class='hljl-p'>(</span><span class='hljl-n'>obj_GMM_2</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-nf'>randn</span><span class='hljl-p'>(</span><span class='hljl-n'>k</span><span class='hljl-p'>),</span><span class='hljl-t'> </span><span class='hljl-nf'>BFGS</span><span class='hljl-p'>(),</span><span class='hljl-t'> </span><span class='hljl-n'>autodiff</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-sc'>:forward</span><span class='hljl-p'>);</span><span class='hljl-t'>
    </span><span class='hljl-n'>β_GMM_2</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-n'>opt_2</span><span class='hljl-oB'>.</span><span class='hljl-n'>minimizer</span><span class='hljl-t'>
    </span><span class='hljl-n'>Q_2</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-n'>ForwardDiff</span><span class='hljl-oB'>.</span><span class='hljl-nf'>jacobian</span><span class='hljl-p'>(</span><span class='hljl-n'>β</span><span class='hljl-t'> </span><span class='hljl-oB'>-&gt;</span><span class='hljl-t'> </span><span class='hljl-nf'>f_sum_IV</span><span class='hljl-p'>(</span><span class='hljl-n'>β</span><span class='hljl-p'>)</span><span class='hljl-t'> </span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>β_GMM_2</span><span class='hljl-p'>)</span><span class='hljl-oB'>/</span><span class='hljl-n'>N</span><span class='hljl-p'>;</span><span class='hljl-t'>
    </span><span class='hljl-n'>Ω_2</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-nf'>f_IV</span><span class='hljl-p'>(</span><span class='hljl-n'>β_GMM_2</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>y</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>Z</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>X</span><span class='hljl-p'>)</span><span class='hljl-oB'>&#39;*</span><span class='hljl-nf'>f_IV</span><span class='hljl-p'>(</span><span class='hljl-n'>β_GMM_2</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>y</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>Z</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>X</span><span class='hljl-p'>)</span><span class='hljl-oB'>/</span><span class='hljl-n'>N</span><span class='hljl-p'>;</span><span class='hljl-t'>
    
    </span><span class='hljl-cs'># Results</span><span class='hljl-t'>
    </span><span class='hljl-n'>V_GMM_1</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-nf'>inv</span><span class='hljl-p'>(</span><span class='hljl-n'>Q_1</span><span class='hljl-oB'>&#39;*</span><span class='hljl-n'>W_1</span><span class='hljl-oB'>*</span><span class='hljl-n'>Q_1</span><span class='hljl-p'>)</span><span class='hljl-oB'>*</span><span class='hljl-p'>(</span><span class='hljl-n'>Q_1</span><span class='hljl-oB'>&#39;*</span><span class='hljl-n'>W_1</span><span class='hljl-oB'>*</span><span class='hljl-n'>Ω_1</span><span class='hljl-oB'>*</span><span class='hljl-n'>W_1</span><span class='hljl-oB'>*</span><span class='hljl-n'>Q_1</span><span class='hljl-p'>)</span><span class='hljl-oB'>*</span><span class='hljl-nf'>inv</span><span class='hljl-p'>(</span><span class='hljl-n'>Q_1</span><span class='hljl-oB'>&#39;*</span><span class='hljl-n'>W_1</span><span class='hljl-oB'>*</span><span class='hljl-n'>Q_1</span><span class='hljl-p'>)</span><span class='hljl-oB'>/</span><span class='hljl-n'>N</span><span class='hljl-p'>;</span><span class='hljl-t'> </span><span class='hljl-cs'># remember to divide by N!</span><span class='hljl-t'>
    </span><span class='hljl-n'>σ_GMM_1</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-n'>sqrt</span><span class='hljl-oB'>.</span><span class='hljl-p'>(</span><span class='hljl-nf'>diag</span><span class='hljl-p'>(</span><span class='hljl-n'>V_GMM_1</span><span class='hljl-p'>))</span><span class='hljl-t'>
    </span><span class='hljl-n'>V_GMM_2</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-nf'>inv</span><span class='hljl-p'>(</span><span class='hljl-n'>Q_2</span><span class='hljl-oB'>&#39;*</span><span class='hljl-n'>W_opt</span><span class='hljl-oB'>*</span><span class='hljl-n'>Q_2</span><span class='hljl-p'>)</span><span class='hljl-oB'>*</span><span class='hljl-p'>(</span><span class='hljl-n'>Q_2</span><span class='hljl-oB'>&#39;*</span><span class='hljl-n'>W_opt</span><span class='hljl-oB'>*</span><span class='hljl-n'>Ω_2</span><span class='hljl-oB'>*</span><span class='hljl-n'>W_opt</span><span class='hljl-oB'>*</span><span class='hljl-n'>Q_2</span><span class='hljl-p'>)</span><span class='hljl-oB'>*</span><span class='hljl-nf'>inv</span><span class='hljl-p'>(</span><span class='hljl-n'>Q_2</span><span class='hljl-oB'>&#39;*</span><span class='hljl-n'>W_opt</span><span class='hljl-oB'>*</span><span class='hljl-n'>Q_2</span><span class='hljl-p'>)</span><span class='hljl-oB'>/</span><span class='hljl-n'>N</span><span class='hljl-p'>;</span><span class='hljl-t'> </span><span class='hljl-cs'># remember to divide by N!</span><span class='hljl-t'>
    </span><span class='hljl-n'>σ_GMM_2</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-n'>sqrt</span><span class='hljl-oB'>.</span><span class='hljl-p'>(</span><span class='hljl-nf'>diag</span><span class='hljl-p'>(</span><span class='hljl-n'>V_GMM_2</span><span class='hljl-p'>))</span><span class='hljl-t'>

    </span><span class='hljl-k'>return</span><span class='hljl-t'> </span><span class='hljl-n'>β_GMM_1</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>σ_GMM_1</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>β_GMM_2</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>σ_GMM_2</span><span class='hljl-t'>

</span><span class='hljl-k'>end</span><span class='hljl-p'>;</span>
</pre>




<pre class='hljl'>
<span class='hljl-cs'># Estimation</span><span class='hljl-t'>
</span><span class='hljl-n'>Z</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-p'>[</span><span class='hljl-nf'>ones</span><span class='hljl-p'>(</span><span class='hljl-n'>N</span><span class='hljl-p'>)</span><span class='hljl-t'> </span><span class='hljl-n'>X_LIV</span><span class='hljl-p'>[</span><span class='hljl-oB'>:</span><span class='hljl-p'>,</span><span class='hljl-ni'>1</span><span class='hljl-p'>]</span><span class='hljl-t'> </span><span class='hljl-n'>Z_LIV</span><span class='hljl-p'>];</span><span class='hljl-t'>
</span><span class='hljl-n'>β_GMM_I</span><span class='hljl-p'>,</span><span class='hljl-t'>  </span><span class='hljl-n'>σ_GMM_I</span><span class='hljl-t'>      </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-nf'>GMM_one_step</span><span class='hljl-p'>(</span><span class='hljl-n'>Y_LIV</span><span class='hljl-p'>,</span><span class='hljl-n'>Z_LIV</span><span class='hljl-p'>,</span><span class='hljl-n'>X_LIV</span><span class='hljl-p'>,</span><span class='hljl-n'>W</span><span class='hljl-oB'>=</span><span class='hljl-n'>I</span><span class='hljl-p'>);</span><span class='hljl-t'>
</span><span class='hljl-n'>β_GMM_ZZ</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>σ_GMM_ZZ</span><span class='hljl-t'>     </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-nf'>GMM_one_step</span><span class='hljl-p'>(</span><span class='hljl-n'>Y_LIV</span><span class='hljl-p'>,</span><span class='hljl-n'>Z_LIV</span><span class='hljl-p'>,</span><span class='hljl-n'>X_LIV</span><span class='hljl-p'>,</span><span class='hljl-n'>W</span><span class='hljl-oB'>=</span><span class='hljl-nf'>inv</span><span class='hljl-p'>(</span><span class='hljl-n'>Z</span><span class='hljl-oB'>&#39;*</span><span class='hljl-n'>Z</span><span class='hljl-p'>));</span><span class='hljl-t'>
</span><span class='hljl-n'>_</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>_</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>β_GMM_2</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>σ_GMM_2</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-nf'>GMM_two_step</span><span class='hljl-p'>(</span><span class='hljl-n'>Y_LIV</span><span class='hljl-p'>,</span><span class='hljl-n'>Z_LIV</span><span class='hljl-p'>,</span><span class='hljl-n'>X_LIV</span><span class='hljl-p'>);</span><span class='hljl-t'>

</span><span class='hljl-cs'># Print the results</span><span class='hljl-t'>
</span><span class='hljl-nf'>print</span><span class='hljl-p'>(</span><span class='hljl-s'>&quot;GMM result, overidentified: β₂ is biased in OLS </span><span class='hljl-se'>\n</span><span class='hljl-s'>&quot;</span><span class='hljl-p'>)</span><span class='hljl-t'>
</span><span class='hljl-nf'>print</span><span class='hljl-p'>(</span><span class='hljl-s'>&quot;              |     β₀    |     β₁    |     β₂    | </span><span class='hljl-se'>\n</span><span class='hljl-s'>&quot;</span><span class='hljl-p'>)</span><span class='hljl-t'>
</span><span class='hljl-nd'>@printf</span><span class='hljl-p'>(</span><span class='hljl-s'>&quot;DGP           | %10.7f | %10.7f | %10.7f |</span><span class='hljl-se'>\n</span><span class='hljl-s'>&quot;</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>β_DGP</span><span class='hljl-p'>[</span><span class='hljl-ni'>1</span><span class='hljl-p'>],</span><span class='hljl-t'> </span><span class='hljl-n'>β_DGP</span><span class='hljl-p'>[</span><span class='hljl-ni'>2</span><span class='hljl-p'>],</span><span class='hljl-t'> </span><span class='hljl-n'>β_DGP</span><span class='hljl-p'>[</span><span class='hljl-ni'>3</span><span class='hljl-p'>])</span><span class='hljl-t'>
</span><span class='hljl-nd'>@printf</span><span class='hljl-p'>(</span><span class='hljl-s'>&quot;One-step GMM: | %10.7f | %10.7f | %10.7f |</span><span class='hljl-se'>\n</span><span class='hljl-s'>&quot;</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>β_GMM_I</span><span class='hljl-p'>[</span><span class='hljl-ni'>1</span><span class='hljl-p'>],</span><span class='hljl-t'> </span><span class='hljl-n'>β_GMM_I</span><span class='hljl-p'>[</span><span class='hljl-ni'>2</span><span class='hljl-p'>],</span><span class='hljl-t'> </span><span class='hljl-n'>β_GMM_I</span><span class='hljl-p'>[</span><span class='hljl-ni'>3</span><span class='hljl-p'>])</span><span class='hljl-t'>
</span><span class='hljl-nd'>@printf</span><span class='hljl-p'>(</span><span class='hljl-s'>&quot; W=I          |(%10.7f)|(%10.7f)|(%10.7f)|</span><span class='hljl-se'>\n</span><span class='hljl-s'>&quot;</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>σ_GMM_I</span><span class='hljl-p'>[</span><span class='hljl-ni'>1</span><span class='hljl-p'>],</span><span class='hljl-t'> </span><span class='hljl-n'>σ_GMM_I</span><span class='hljl-p'>[</span><span class='hljl-ni'>2</span><span class='hljl-p'>],</span><span class='hljl-t'> </span><span class='hljl-n'>σ_GMM_I</span><span class='hljl-p'>[</span><span class='hljl-ni'>3</span><span class='hljl-p'>])</span><span class='hljl-t'>
</span><span class='hljl-nd'>@printf</span><span class='hljl-p'>(</span><span class='hljl-s'>&quot;One-step GMM: | %10.7f | %10.7f | %10.7f |</span><span class='hljl-se'>\n</span><span class='hljl-s'>&quot;</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>β_GMM_ZZ</span><span class='hljl-p'>[</span><span class='hljl-ni'>1</span><span class='hljl-p'>],</span><span class='hljl-t'> </span><span class='hljl-n'>β_GMM_ZZ</span><span class='hljl-p'>[</span><span class='hljl-ni'>2</span><span class='hljl-p'>],</span><span class='hljl-t'> </span><span class='hljl-n'>β_GMM_ZZ</span><span class='hljl-p'>[</span><span class='hljl-ni'>3</span><span class='hljl-p'>])</span><span class='hljl-t'>
</span><span class='hljl-nd'>@printf</span><span class='hljl-p'>(</span><span class='hljl-s'>&quot; W=inv(Z&#39;Z)   |(%10.7f)|(%10.7f)|(%10.7f)|</span><span class='hljl-se'>\n</span><span class='hljl-s'>&quot;</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>σ_GMM_ZZ</span><span class='hljl-p'>[</span><span class='hljl-ni'>1</span><span class='hljl-p'>],</span><span class='hljl-t'> </span><span class='hljl-n'>σ_GMM_ZZ</span><span class='hljl-p'>[</span><span class='hljl-ni'>2</span><span class='hljl-p'>],</span><span class='hljl-t'> </span><span class='hljl-n'>σ_GMM_ZZ</span><span class='hljl-p'>[</span><span class='hljl-ni'>3</span><span class='hljl-p'>])</span><span class='hljl-t'>
</span><span class='hljl-nd'>@printf</span><span class='hljl-p'>(</span><span class='hljl-s'>&quot;Two-step GMM  | %10.7f | %10.7f | %10.7f |</span><span class='hljl-se'>\n</span><span class='hljl-s'>&quot;</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>β_GMM_2</span><span class='hljl-p'>[</span><span class='hljl-ni'>1</span><span class='hljl-p'>],</span><span class='hljl-t'> </span><span class='hljl-n'>β_GMM_2</span><span class='hljl-p'>[</span><span class='hljl-ni'>2</span><span class='hljl-p'>],</span><span class='hljl-t'> </span><span class='hljl-n'>β_GMM_2</span><span class='hljl-p'>[</span><span class='hljl-ni'>3</span><span class='hljl-p'>])</span><span class='hljl-t'>
</span><span class='hljl-nd'>@printf</span><span class='hljl-p'>(</span><span class='hljl-s'>&quot;              |(%10.7f)|(%10.7f)|(%10.7f)|</span><span class='hljl-se'>\n</span><span class='hljl-s'>&quot;</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>σ_GMM_2</span><span class='hljl-p'>[</span><span class='hljl-ni'>1</span><span class='hljl-p'>],</span><span class='hljl-t'> </span><span class='hljl-n'>σ_GMM_2</span><span class='hljl-p'>[</span><span class='hljl-ni'>2</span><span class='hljl-p'>],</span><span class='hljl-t'> </span><span class='hljl-n'>σ_GMM_2</span><span class='hljl-p'>[</span><span class='hljl-ni'>3</span><span class='hljl-p'>])</span><span class='hljl-t'>
</span><span class='hljl-nf'>print</span><span class='hljl-p'>(</span><span class='hljl-s'>&quot;Standard errors in parentheses.&quot;</span><span class='hljl-p'>)</span>
</pre>


<pre class="output">
GMM result, overidentified: β₂ is biased in OLS 
              |     β₀    |     β₁    |     β₂    | 
DGP           |  0.1500000 |  0.2500000 | -1.5000000 |
One-step GMM: |  0.1467573 |  0.2517024 | -1.5115486 |
 W&#61;I          |&#40; 0.0044970&#41;|&#40; 0.0045002&#41;|&#40; 0.0044782&#41;|
One-step GMM: |  0.1467379 |  0.2517642 | -1.5116826 |
 W&#61;inv&#40;Z&#39;Z&#41;   |&#40; 0.0044974&#41;|&#40; 0.0045002&#41;|&#40; 0.0044776&#41;|
Two-step GMM  |  0.1467965 |  0.2517965 | -1.5117060 |
              |&#40; 0.0044973&#41;|&#40; 0.0045002&#41;|&#40; 0.0044777&#41;|
Standard errors in parentheses.
</pre>


<p>There is small difference between two-step GMM and One-step GMM with <span class="math">$W=(Z'Z)^{-1}$</span> because two-step GMM estimated <span class="math">$W$</span>. As you increase <span class="math">$N$</span>, this difference will disappear.</p>
<p>One could also iterate steps as many times as you wish until the updated <span class="math">$\hat{\beta}_{gmm}$</span> converges. This is called <strong>Iterated GMM</strong>. Note, however, the two-step GMM is already asymptotically efficient. You might want to use iterated GMM if you think the estimates are suffering from small sample.</p>
<h4>Programming</h4>
<ol>
<li><p>Set some weighting matrix <span class="math">$W$</span>. In our example, for the just-identified case, use <span class="math">$W=I$</span> and for the over-identified case, use <span class="math">$W=(Z'Z)^{-1}$</span>. Also, set some tolerance to declare &#39;convergence&#39;.</p>
</li>
<li><p>Construct the GMM criterion function. It is <strong>obj_IV</strong> in my code.</p>
</li>
<li><p>Ask the computer to minimize the criterion function for you. The minimizer is your <span class="math">$\hat{\beta}_{gmm}$</span>.</p>
</li>
<li><p>Compute <span class="math">$Q$</span> and <span class="math">$\Omega$</span>.</p>
<ul>
<li><p>Repeat step 3 and 4 by updating <span class="math">$W=\hat{\Omega}^{-1}$</span> iteratively and until convergence up to some tolerance.</p>
</li>
</ul>
</li>
<li><p>Compute the asymptotic variance <span class="math">$V_\beta$</span>. </p>
</li>
<li><p>Compute standard errors with <span class="math">$\textbf{sqrt}.(\textbf{diag}(\mathbf{V_\beta}/N))$</span>.</p>
</li>
</ol>


<pre class='hljl'>
<span class='hljl-k'>function</span><span class='hljl-t'> </span><span class='hljl-nf'>iterated_GMM</span><span class='hljl-p'>(</span><span class='hljl-n'>func</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>γ</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>y</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>X</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>Z</span><span class='hljl-p'>;</span><span class='hljl-t'> </span><span class='hljl-n'>tol</span><span class='hljl-oB'>=</span><span class='hljl-nfB'>0.001</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>max_iter</span><span class='hljl-oB'>=</span><span class='hljl-ni'>10</span><span class='hljl-p'>)</span><span class='hljl-t'>

    </span><span class='hljl-cm'>#=
    func: moment(s)
    X: the matrix of variables that forms moments we wish to make 0
    Z: the matrix orthogonal to moment
    tol: if diff&lt;tol, we claim the update converged
    max_iter: if iter&gt;max_iter, we stop and report what we have so far.
    If max_iter = 2, then it is equivalent to two-step GMM.
    =#</span><span class='hljl-t'>

    </span><span class='hljl-n'>γ_GMM</span><span class='hljl-t'>    </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-nf'>Vector</span><span class='hljl-p'>{</span><span class='hljl-nf'>Vector</span><span class='hljl-p'>{</span><span class='hljl-n'>Float64</span><span class='hljl-p'>}}()</span><span class='hljl-t'>
    </span><span class='hljl-n'>σ_GMM</span><span class='hljl-t'>    </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-nf'>Vector</span><span class='hljl-p'>{</span><span class='hljl-nf'>Vector</span><span class='hljl-p'>{</span><span class='hljl-n'>Float64</span><span class='hljl-p'>}}()</span><span class='hljl-t'>
    </span><span class='hljl-n'>chi2_vec</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-nf'>Vector</span><span class='hljl-p'>{</span><span class='hljl-n'>Float64</span><span class='hljl-p'>}()</span><span class='hljl-t'>
    </span><span class='hljl-n'>pval_vec</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-nf'>Vector</span><span class='hljl-p'>{</span><span class='hljl-n'>Float64</span><span class='hljl-p'>}()</span><span class='hljl-t'>
    </span><span class='hljl-n'>diff_vec</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-nf'>Vector</span><span class='hljl-p'>{</span><span class='hljl-n'>Float64</span><span class='hljl-p'>}()</span><span class='hljl-t'>

    </span><span class='hljl-n'>N</span><span class='hljl-t'>  </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-nf'>size</span><span class='hljl-p'>(</span><span class='hljl-nf'>func</span><span class='hljl-p'>(</span><span class='hljl-n'>γ</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>y</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>X</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>Z</span><span class='hljl-p'>))[</span><span class='hljl-ni'>1</span><span class='hljl-p'>];</span><span class='hljl-t'>
    </span><span class='hljl-n'>l</span><span class='hljl-t'>  </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-nf'>size</span><span class='hljl-p'>(</span><span class='hljl-nf'>func</span><span class='hljl-p'>(</span><span class='hljl-n'>γ</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>y</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>X</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>Z</span><span class='hljl-p'>))[</span><span class='hljl-ni'>2</span><span class='hljl-p'>];</span><span class='hljl-t'>
    </span><span class='hljl-n'>k</span><span class='hljl-t'>  </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-nf'>length</span><span class='hljl-p'>(</span><span class='hljl-n'>γ</span><span class='hljl-p'>);</span><span class='hljl-t'>
    </span><span class='hljl-n'>df</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-n'>l</span><span class='hljl-oB'>-</span><span class='hljl-n'>k</span><span class='hljl-t'>

    </span><span class='hljl-nf'>func_vec</span><span class='hljl-p'>(</span><span class='hljl-n'>γ</span><span class='hljl-p'>)</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-nf'>vec</span><span class='hljl-p'>(</span><span class='hljl-nf'>sum</span><span class='hljl-p'>(</span><span class='hljl-nf'>func</span><span class='hljl-p'>(</span><span class='hljl-n'>γ</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>y</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>X</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>Z</span><span class='hljl-p'>),</span><span class='hljl-n'>dims</span><span class='hljl-oB'>=</span><span class='hljl-ni'>1</span><span class='hljl-p'>));</span><span class='hljl-t'>

    </span><span class='hljl-cs'># First step</span><span class='hljl-t'>
    </span><span class='hljl-n'>W_1</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-n'>I</span><span class='hljl-p'>;</span><span class='hljl-t'>
    </span><span class='hljl-nf'>obj_GMM_1</span><span class='hljl-p'>(</span><span class='hljl-n'>γ</span><span class='hljl-p'>)</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-n'>N</span><span class='hljl-t'> </span><span class='hljl-oB'>*</span><span class='hljl-t'> </span><span class='hljl-p'>(</span><span class='hljl-nf'>func_vec</span><span class='hljl-p'>(</span><span class='hljl-n'>γ</span><span class='hljl-p'>)</span><span class='hljl-oB'>/</span><span class='hljl-n'>N</span><span class='hljl-p'>)</span><span class='hljl-oB'>&#39;</span><span class='hljl-t'> </span><span class='hljl-oB'>*</span><span class='hljl-t'> </span><span class='hljl-n'>W_1</span><span class='hljl-t'> </span><span class='hljl-oB'>*</span><span class='hljl-t'> </span><span class='hljl-p'>(</span><span class='hljl-nf'>func_vec</span><span class='hljl-p'>(</span><span class='hljl-n'>γ</span><span class='hljl-p'>)</span><span class='hljl-oB'>/</span><span class='hljl-n'>N</span><span class='hljl-p'>);</span><span class='hljl-t'>
    </span><span class='hljl-n'>opt_1</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-nf'>optimize</span><span class='hljl-p'>(</span><span class='hljl-n'>obj_GMM_1</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-nf'>randn</span><span class='hljl-p'>(</span><span class='hljl-n'>k</span><span class='hljl-p'>),</span><span class='hljl-t'> </span><span class='hljl-nf'>BFGS</span><span class='hljl-p'>(),</span><span class='hljl-t'> </span><span class='hljl-n'>autodiff</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-sc'>:forward</span><span class='hljl-p'>);</span><span class='hljl-t'>
    </span><span class='hljl-n'>γ_GMM_1</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-nf'>vec</span><span class='hljl-p'>(</span><span class='hljl-n'>opt_1</span><span class='hljl-oB'>.</span><span class='hljl-n'>minimizer</span><span class='hljl-p'>)</span><span class='hljl-t'>
    </span><span class='hljl-n'>Q_1</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-n'>ForwardDiff</span><span class='hljl-oB'>.</span><span class='hljl-nf'>jacobian</span><span class='hljl-p'>(</span><span class='hljl-n'>γ</span><span class='hljl-t'> </span><span class='hljl-oB'>-&gt;</span><span class='hljl-t'> </span><span class='hljl-nf'>func_vec</span><span class='hljl-p'>(</span><span class='hljl-n'>γ</span><span class='hljl-p'>)</span><span class='hljl-t'> </span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>γ_GMM_1</span><span class='hljl-p'>)</span><span class='hljl-oB'>/</span><span class='hljl-n'>N</span><span class='hljl-p'>;</span><span class='hljl-t'>
    </span><span class='hljl-n'>Ω_1</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-nf'>func</span><span class='hljl-p'>(</span><span class='hljl-n'>γ_GMM_1</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>y</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>X</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>Z</span><span class='hljl-p'>)</span><span class='hljl-oB'>&#39;*</span><span class='hljl-nf'>func</span><span class='hljl-p'>(</span><span class='hljl-n'>γ_GMM_1</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>y</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>X</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>Z</span><span class='hljl-p'>)</span><span class='hljl-oB'>/</span><span class='hljl-n'>N</span><span class='hljl-p'>;</span><span class='hljl-t'>
    </span><span class='hljl-n'>V_GMM_1</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-nf'>inv</span><span class='hljl-p'>(</span><span class='hljl-n'>Q_1</span><span class='hljl-oB'>&#39;*</span><span class='hljl-n'>W_1</span><span class='hljl-oB'>*</span><span class='hljl-n'>Q_1</span><span class='hljl-p'>)</span><span class='hljl-oB'>*</span><span class='hljl-p'>(</span><span class='hljl-n'>Q_1</span><span class='hljl-oB'>&#39;*</span><span class='hljl-n'>W_1</span><span class='hljl-oB'>*</span><span class='hljl-n'>Ω_1</span><span class='hljl-oB'>*</span><span class='hljl-n'>W_1</span><span class='hljl-oB'>*</span><span class='hljl-n'>Q_1</span><span class='hljl-p'>)</span><span class='hljl-oB'>*</span><span class='hljl-nf'>inv</span><span class='hljl-p'>(</span><span class='hljl-n'>Q_1</span><span class='hljl-oB'>&#39;*</span><span class='hljl-n'>W_1</span><span class='hljl-oB'>*</span><span class='hljl-n'>Q_1</span><span class='hljl-p'>)</span><span class='hljl-oB'>/</span><span class='hljl-n'>N</span><span class='hljl-p'>;</span><span class='hljl-t'> </span><span class='hljl-cs'># remember to divide by N!</span><span class='hljl-t'>
    </span><span class='hljl-n'>σ_GMM_1</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-n'>sqrt</span><span class='hljl-oB'>.</span><span class='hljl-p'>(</span><span class='hljl-nf'>diag</span><span class='hljl-p'>(</span><span class='hljl-n'>V_GMM_1</span><span class='hljl-p'>))</span><span class='hljl-t'>
    </span><span class='hljl-n'>chi2</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-nf'>obj_GMM_1</span><span class='hljl-p'>(</span><span class='hljl-n'>γ_GMM_1</span><span class='hljl-p'>)</span><span class='hljl-t'>
    </span><span class='hljl-n'>pval</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-nf'>ccdf</span><span class='hljl-p'>(</span><span class='hljl-nf'>Chisq</span><span class='hljl-p'>(</span><span class='hljl-n'>l</span><span class='hljl-oB'>-</span><span class='hljl-n'>k</span><span class='hljl-p'>),</span><span class='hljl-nf'>obj_GMM_1</span><span class='hljl-p'>(</span><span class='hljl-n'>γ_GMM_1</span><span class='hljl-p'>))</span><span class='hljl-t'> </span><span class='hljl-cs'># p-val</span><span class='hljl-t'>

    </span><span class='hljl-nf'>push!</span><span class='hljl-p'>(</span><span class='hljl-n'>γ_GMM</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>γ_GMM_1</span><span class='hljl-p'>)</span><span class='hljl-t'>
    </span><span class='hljl-nf'>push!</span><span class='hljl-p'>(</span><span class='hljl-n'>σ_GMM</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>σ_GMM_1</span><span class='hljl-p'>)</span><span class='hljl-t'>
    </span><span class='hljl-nf'>push!</span><span class='hljl-p'>(</span><span class='hljl-n'>chi2_vec</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>chi2</span><span class='hljl-p'>)</span><span class='hljl-t'>
    </span><span class='hljl-nf'>push!</span><span class='hljl-p'>(</span><span class='hljl-n'>pval_vec</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>pval</span><span class='hljl-p'>)</span><span class='hljl-t'>

    </span><span class='hljl-n'>diff</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-nfB'>1e6</span><span class='hljl-t'>
    </span><span class='hljl-n'>iter</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-ni'>1</span><span class='hljl-t'>
    
    </span><span class='hljl-cs'># Iterated GMM</span><span class='hljl-t'>
    </span><span class='hljl-k'>while</span><span class='hljl-t'> </span><span class='hljl-p'>(</span><span class='hljl-n'>diff</span><span class='hljl-t'> </span><span class='hljl-oB'>&gt;</span><span class='hljl-t'> </span><span class='hljl-n'>tol</span><span class='hljl-p'>)</span><span class='hljl-t'> </span><span class='hljl-oB'>&amp;</span><span class='hljl-t'> </span><span class='hljl-p'>(</span><span class='hljl-n'>iter</span><span class='hljl-t'> </span><span class='hljl-oB'>&lt;</span><span class='hljl-t'> </span><span class='hljl-n'>max_iter</span><span class='hljl-p'>)</span><span class='hljl-t'>
        </span><span class='hljl-n'>W_opt</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-nf'>inv</span><span class='hljl-p'>(</span><span class='hljl-n'>Ω_1</span><span class='hljl-p'>)</span><span class='hljl-t'>
        </span><span class='hljl-nf'>obj_GMM_2</span><span class='hljl-p'>(</span><span class='hljl-n'>γ</span><span class='hljl-p'>)</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-n'>N</span><span class='hljl-t'> </span><span class='hljl-oB'>*</span><span class='hljl-t'> </span><span class='hljl-p'>(</span><span class='hljl-nf'>func_vec</span><span class='hljl-p'>(</span><span class='hljl-n'>γ</span><span class='hljl-p'>)</span><span class='hljl-oB'>/</span><span class='hljl-n'>N</span><span class='hljl-p'>)</span><span class='hljl-oB'>&#39;</span><span class='hljl-t'> </span><span class='hljl-oB'>*</span><span class='hljl-t'> </span><span class='hljl-n'>W_opt</span><span class='hljl-t'> </span><span class='hljl-oB'>*</span><span class='hljl-t'> </span><span class='hljl-p'>(</span><span class='hljl-nf'>func_vec</span><span class='hljl-p'>(</span><span class='hljl-n'>γ</span><span class='hljl-p'>)</span><span class='hljl-oB'>/</span><span class='hljl-n'>N</span><span class='hljl-p'>);</span><span class='hljl-t'>
        </span><span class='hljl-n'>opt_2</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-nf'>optimize</span><span class='hljl-p'>(</span><span class='hljl-n'>obj_GMM_2</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-nf'>randn</span><span class='hljl-p'>(</span><span class='hljl-n'>k</span><span class='hljl-p'>),</span><span class='hljl-t'> </span><span class='hljl-nf'>BFGS</span><span class='hljl-p'>(),</span><span class='hljl-t'> </span><span class='hljl-n'>autodiff</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-sc'>:forward</span><span class='hljl-p'>);</span><span class='hljl-t'>
        </span><span class='hljl-n'>γ_GMM_2</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-nf'>vec</span><span class='hljl-p'>(</span><span class='hljl-n'>opt_2</span><span class='hljl-oB'>.</span><span class='hljl-n'>minimizer</span><span class='hljl-p'>)</span><span class='hljl-t'>
        </span><span class='hljl-n'>Q_2</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-n'>ForwardDiff</span><span class='hljl-oB'>.</span><span class='hljl-nf'>jacobian</span><span class='hljl-p'>(</span><span class='hljl-n'>γ</span><span class='hljl-t'> </span><span class='hljl-oB'>-&gt;</span><span class='hljl-t'> </span><span class='hljl-nf'>func_vec</span><span class='hljl-p'>(</span><span class='hljl-n'>γ</span><span class='hljl-p'>)</span><span class='hljl-t'> </span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>γ_GMM_2</span><span class='hljl-p'>)</span><span class='hljl-oB'>/</span><span class='hljl-n'>N</span><span class='hljl-p'>;</span><span class='hljl-t'>
        </span><span class='hljl-n'>Ω_2</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-nf'>func</span><span class='hljl-p'>(</span><span class='hljl-n'>γ_GMM_2</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>y</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>X</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>Z</span><span class='hljl-p'>)</span><span class='hljl-oB'>&#39;*</span><span class='hljl-nf'>func</span><span class='hljl-p'>(</span><span class='hljl-n'>γ_GMM_2</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>y</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>X</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>Z</span><span class='hljl-p'>)</span><span class='hljl-oB'>/</span><span class='hljl-n'>N</span><span class='hljl-p'>;</span><span class='hljl-t'>
        </span><span class='hljl-n'>V_GMM_2</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-nf'>inv</span><span class='hljl-p'>(</span><span class='hljl-n'>Q_2</span><span class='hljl-oB'>&#39;*</span><span class='hljl-n'>W_opt</span><span class='hljl-oB'>*</span><span class='hljl-n'>Q_2</span><span class='hljl-p'>)</span><span class='hljl-oB'>*</span><span class='hljl-p'>(</span><span class='hljl-n'>Q_2</span><span class='hljl-oB'>&#39;*</span><span class='hljl-n'>W_opt</span><span class='hljl-oB'>*</span><span class='hljl-n'>Ω_2</span><span class='hljl-oB'>*</span><span class='hljl-n'>W_opt</span><span class='hljl-oB'>*</span><span class='hljl-n'>Q_2</span><span class='hljl-p'>)</span><span class='hljl-oB'>*</span><span class='hljl-nf'>inv</span><span class='hljl-p'>(</span><span class='hljl-n'>Q_2</span><span class='hljl-oB'>&#39;*</span><span class='hljl-n'>W_opt</span><span class='hljl-oB'>*</span><span class='hljl-n'>Q_2</span><span class='hljl-p'>)</span><span class='hljl-oB'>/</span><span class='hljl-n'>N</span><span class='hljl-p'>;</span><span class='hljl-t'> </span><span class='hljl-cs'># remember to divide by N!</span><span class='hljl-t'>
        </span><span class='hljl-n'>σ_GMM_2</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-n'>sqrt</span><span class='hljl-oB'>.</span><span class='hljl-p'>(</span><span class='hljl-nf'>diag</span><span class='hljl-p'>(</span><span class='hljl-n'>V_GMM_2</span><span class='hljl-p'>));</span><span class='hljl-t'>
        </span><span class='hljl-n'>chi2</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-nf'>obj_GMM_2</span><span class='hljl-p'>(</span><span class='hljl-n'>γ_GMM_2</span><span class='hljl-p'>)</span><span class='hljl-t'>    
        </span><span class='hljl-n'>pval</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-nf'>ccdf</span><span class='hljl-p'>(</span><span class='hljl-nf'>Chisq</span><span class='hljl-p'>(</span><span class='hljl-n'>l</span><span class='hljl-oB'>-</span><span class='hljl-n'>k</span><span class='hljl-p'>),</span><span class='hljl-nf'>obj_GMM_2</span><span class='hljl-p'>(</span><span class='hljl-n'>γ_GMM_2</span><span class='hljl-p'>))</span><span class='hljl-t'> </span><span class='hljl-cs'># p-val</span><span class='hljl-t'>

        </span><span class='hljl-cs'># update</span><span class='hljl-t'>
        </span><span class='hljl-n'>diff</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-nf'>sqrt</span><span class='hljl-p'>(</span><span class='hljl-nf'>sum</span><span class='hljl-p'>((</span><span class='hljl-n'>γ_GMM_2</span><span class='hljl-oB'>-</span><span class='hljl-n'>γ_GMM_1</span><span class='hljl-p'>)</span><span class='hljl-oB'>.^</span><span class='hljl-ni'>2</span><span class='hljl-p'>))</span><span class='hljl-t'>
        </span><span class='hljl-n'>Ω_1</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-n'>Ω_2</span><span class='hljl-t'>
        </span><span class='hljl-n'>γ_GMM_1</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-n'>γ_GMM_2</span><span class='hljl-t'>
        </span><span class='hljl-n'>iter</span><span class='hljl-t'> </span><span class='hljl-oB'>+=</span><span class='hljl-t'> </span><span class='hljl-ni'>1</span><span class='hljl-t'>

        </span><span class='hljl-cs'># record</span><span class='hljl-t'>
        </span><span class='hljl-nf'>push!</span><span class='hljl-p'>(</span><span class='hljl-n'>diff_vec</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>diff</span><span class='hljl-p'>)</span><span class='hljl-t'>
        </span><span class='hljl-nf'>push!</span><span class='hljl-p'>(</span><span class='hljl-n'>γ_GMM</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>γ_GMM_2</span><span class='hljl-p'>)</span><span class='hljl-t'>
        </span><span class='hljl-nf'>push!</span><span class='hljl-p'>(</span><span class='hljl-n'>σ_GMM</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>σ_GMM_2</span><span class='hljl-p'>)</span><span class='hljl-t'>
        </span><span class='hljl-nf'>push!</span><span class='hljl-p'>(</span><span class='hljl-n'>chi2_vec</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>chi2</span><span class='hljl-p'>)</span><span class='hljl-t'>
        </span><span class='hljl-nf'>push!</span><span class='hljl-p'>(</span><span class='hljl-n'>pval_vec</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>pval</span><span class='hljl-p'>)</span><span class='hljl-t'>
    </span><span class='hljl-k'>end</span><span class='hljl-t'>

    </span><span class='hljl-k'>return</span><span class='hljl-t'> </span><span class='hljl-n'>γ_GMM</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>σ_GMM</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>chi2_vec</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>df</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>pval_vec</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>diff_vec</span><span class='hljl-t'>
    
</span><span class='hljl-k'>end</span><span class='hljl-p'>;</span>
</pre>




<pre class='hljl'>
<span class='hljl-cs'># Estimation</span><span class='hljl-t'>
</span><span class='hljl-n'>Z</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-p'>[</span><span class='hljl-nf'>ones</span><span class='hljl-p'>(</span><span class='hljl-n'>N</span><span class='hljl-p'>)</span><span class='hljl-t'> </span><span class='hljl-n'>X_LIV</span><span class='hljl-p'>[</span><span class='hljl-oB'>:</span><span class='hljl-p'>,</span><span class='hljl-ni'>1</span><span class='hljl-p'>]</span><span class='hljl-t'> </span><span class='hljl-n'>Z_LIV</span><span class='hljl-p'>];</span><span class='hljl-t'>
</span><span class='hljl-n'>β_GMM_I</span><span class='hljl-p'>,</span><span class='hljl-t'>  </span><span class='hljl-n'>σ_GMM_I</span><span class='hljl-t'>      </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-nf'>GMM_one_step</span><span class='hljl-p'>(</span><span class='hljl-n'>Y_LIV</span><span class='hljl-p'>,</span><span class='hljl-n'>Z_LIV</span><span class='hljl-p'>,</span><span class='hljl-n'>X_LIV</span><span class='hljl-p'>,</span><span class='hljl-n'>W</span><span class='hljl-oB'>=</span><span class='hljl-n'>I</span><span class='hljl-p'>);</span><span class='hljl-t'>
</span><span class='hljl-n'>β_GMM_ZZ</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>σ_GMM_ZZ</span><span class='hljl-t'>     </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-nf'>GMM_one_step</span><span class='hljl-p'>(</span><span class='hljl-n'>Y_LIV</span><span class='hljl-p'>,</span><span class='hljl-n'>Z_LIV</span><span class='hljl-p'>,</span><span class='hljl-n'>X_LIV</span><span class='hljl-p'>,</span><span class='hljl-n'>W</span><span class='hljl-oB'>=</span><span class='hljl-nf'>inv</span><span class='hljl-p'>(</span><span class='hljl-n'>Z</span><span class='hljl-oB'>&#39;*</span><span class='hljl-n'>Z</span><span class='hljl-p'>));</span><span class='hljl-t'>
</span><span class='hljl-n'>_</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>_</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>β_GMM_2</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>σ_GMM_2</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-nf'>GMM_two_step</span><span class='hljl-p'>(</span><span class='hljl-n'>Y_LIV</span><span class='hljl-p'>,</span><span class='hljl-n'>Z_LIV</span><span class='hljl-p'>,</span><span class='hljl-n'>X_LIV</span><span class='hljl-p'>);</span><span class='hljl-t'>
</span><span class='hljl-cs'># Iterated GMM </span><span class='hljl-t'>
</span><span class='hljl-k'>function</span><span class='hljl-t'> </span><span class='hljl-nf'>f_IV</span><span class='hljl-p'>(</span><span class='hljl-n'>β</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>y</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>Xdata</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>Zdata</span><span class='hljl-p'>)</span><span class='hljl-t'>
    </span><span class='hljl-n'>N</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-nf'>length</span><span class='hljl-p'>(</span><span class='hljl-n'>y</span><span class='hljl-p'>)</span><span class='hljl-t'>
    </span><span class='hljl-n'>X</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-p'>[</span><span class='hljl-nf'>ones</span><span class='hljl-p'>(</span><span class='hljl-n'>N</span><span class='hljl-p'>)</span><span class='hljl-t'> </span><span class='hljl-n'>Xdata</span><span class='hljl-p'>]</span><span class='hljl-t'>
    </span><span class='hljl-n'>Z</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-p'>[</span><span class='hljl-nf'>ones</span><span class='hljl-p'>(</span><span class='hljl-n'>N</span><span class='hljl-p'>)</span><span class='hljl-t'> </span><span class='hljl-n'>Xdata</span><span class='hljl-p'>[</span><span class='hljl-oB'>:</span><span class='hljl-p'>,</span><span class='hljl-ni'>1</span><span class='hljl-p'>]</span><span class='hljl-t'> </span><span class='hljl-n'>Zdata</span><span class='hljl-p'>]</span><span class='hljl-t'>
    </span><span class='hljl-k'>return</span><span class='hljl-t'> </span><span class='hljl-p'>(</span><span class='hljl-n'>y</span><span class='hljl-t'> </span><span class='hljl-oB'>-</span><span class='hljl-t'> </span><span class='hljl-n'>X</span><span class='hljl-oB'>*</span><span class='hljl-n'>β</span><span class='hljl-p'>)</span><span class='hljl-t'> </span><span class='hljl-oB'>.*</span><span class='hljl-t'> </span><span class='hljl-n'>Z</span><span class='hljl-t'> </span><span class='hljl-cs'># (N×1) * (N×4)</span><span class='hljl-t'>
</span><span class='hljl-k'>end</span><span class='hljl-t'>
</span><span class='hljl-n'>β_GMM_iter</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>σ_GMM_iter</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>chi2_vec</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>df</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>pval_vec</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>diff_vec</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-nf'>iterated_GMM</span><span class='hljl-p'>(</span><span class='hljl-n'>f_IV</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-nf'>randn</span><span class='hljl-p'>(</span><span class='hljl-ni'>3</span><span class='hljl-p'>),</span><span class='hljl-t'> </span><span class='hljl-n'>Y_LIV</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>X_LIV</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>Z_LIV</span><span class='hljl-p'>;</span><span class='hljl-t'> </span><span class='hljl-n'>tol</span><span class='hljl-oB'>=</span><span class='hljl-nfB'>1e-9</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>max_iter</span><span class='hljl-oB'>=</span><span class='hljl-ni'>5</span><span class='hljl-p'>);</span>
</pre>




<pre class='hljl'>
<span class='hljl-cs'># Print the results</span><span class='hljl-t'>
</span><span class='hljl-nf'>print</span><span class='hljl-p'>(</span><span class='hljl-s'>&quot;Iterated GMM result, overidentified: β₂ is biased in OLS </span><span class='hljl-se'>\n</span><span class='hljl-s'>&quot;</span><span class='hljl-p'>)</span><span class='hljl-t'>
</span><span class='hljl-nf'>print</span><span class='hljl-p'>(</span><span class='hljl-s'>&quot;        |     β₀     |     β₁     |     β₂     | </span><span class='hljl-se'>\n</span><span class='hljl-s'>&quot;</span><span class='hljl-p'>)</span><span class='hljl-t'>
</span><span class='hljl-nd'>@printf</span><span class='hljl-p'>(</span><span class='hljl-s'>&quot;DGP     | %10.7f | %10.7f | %10.7f |</span><span class='hljl-se'>\n</span><span class='hljl-s'>&quot;</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>β_DGP</span><span class='hljl-p'>[</span><span class='hljl-ni'>1</span><span class='hljl-p'>],</span><span class='hljl-t'> </span><span class='hljl-n'>β_DGP</span><span class='hljl-p'>[</span><span class='hljl-ni'>2</span><span class='hljl-p'>],</span><span class='hljl-t'> </span><span class='hljl-n'>β_DGP</span><span class='hljl-p'>[</span><span class='hljl-ni'>3</span><span class='hljl-p'>])</span><span class='hljl-t'>
</span><span class='hljl-nd'>@printf</span><span class='hljl-p'>(</span><span class='hljl-s'>&quot;Step 1  | %10.7f | %10.7f | %10.7f |</span><span class='hljl-se'>\n</span><span class='hljl-s'>&quot;</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>β_GMM_iter</span><span class='hljl-p'>[</span><span class='hljl-ni'>1</span><span class='hljl-p'>][</span><span class='hljl-ni'>1</span><span class='hljl-p'>],</span><span class='hljl-t'> </span><span class='hljl-n'>β_GMM_iter</span><span class='hljl-p'>[</span><span class='hljl-ni'>1</span><span class='hljl-p'>][</span><span class='hljl-ni'>2</span><span class='hljl-p'>],</span><span class='hljl-t'> </span><span class='hljl-n'>β_GMM_iter</span><span class='hljl-p'>[</span><span class='hljl-ni'>1</span><span class='hljl-p'>][</span><span class='hljl-ni'>3</span><span class='hljl-p'>])</span><span class='hljl-t'>
</span><span class='hljl-nd'>@printf</span><span class='hljl-p'>(</span><span class='hljl-s'>&quot;        |(%10.7f)|(%10.7f)|(%10.7f)|</span><span class='hljl-se'>\n</span><span class='hljl-s'>&quot;</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>σ_GMM_iter</span><span class='hljl-p'>[</span><span class='hljl-ni'>1</span><span class='hljl-p'>][</span><span class='hljl-ni'>1</span><span class='hljl-p'>],</span><span class='hljl-t'> </span><span class='hljl-n'>σ_GMM_iter</span><span class='hljl-p'>[</span><span class='hljl-ni'>1</span><span class='hljl-p'>][</span><span class='hljl-ni'>2</span><span class='hljl-p'>],</span><span class='hljl-t'> </span><span class='hljl-n'>σ_GMM_iter</span><span class='hljl-p'>[</span><span class='hljl-ni'>1</span><span class='hljl-p'>][</span><span class='hljl-ni'>3</span><span class='hljl-p'>])</span><span class='hljl-t'>
</span><span class='hljl-nd'>@printf</span><span class='hljl-p'>(</span><span class='hljl-s'>&quot;Step 2  | %10.7f | %10.7f | %10.7f |</span><span class='hljl-se'>\n</span><span class='hljl-s'>&quot;</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>β_GMM_iter</span><span class='hljl-p'>[</span><span class='hljl-ni'>2</span><span class='hljl-p'>][</span><span class='hljl-ni'>1</span><span class='hljl-p'>],</span><span class='hljl-t'> </span><span class='hljl-n'>β_GMM_iter</span><span class='hljl-p'>[</span><span class='hljl-ni'>2</span><span class='hljl-p'>][</span><span class='hljl-ni'>2</span><span class='hljl-p'>],</span><span class='hljl-t'> </span><span class='hljl-n'>β_GMM_iter</span><span class='hljl-p'>[</span><span class='hljl-ni'>2</span><span class='hljl-p'>][</span><span class='hljl-ni'>3</span><span class='hljl-p'>])</span><span class='hljl-t'>
</span><span class='hljl-nd'>@printf</span><span class='hljl-p'>(</span><span class='hljl-s'>&quot;        |(%10.7f)|(%10.7f)|(%10.7f)|</span><span class='hljl-se'>\n</span><span class='hljl-s'>&quot;</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>σ_GMM_iter</span><span class='hljl-p'>[</span><span class='hljl-ni'>2</span><span class='hljl-p'>][</span><span class='hljl-ni'>1</span><span class='hljl-p'>],</span><span class='hljl-t'> </span><span class='hljl-n'>σ_GMM_iter</span><span class='hljl-p'>[</span><span class='hljl-ni'>2</span><span class='hljl-p'>][</span><span class='hljl-ni'>2</span><span class='hljl-p'>],</span><span class='hljl-t'> </span><span class='hljl-n'>σ_GMM_iter</span><span class='hljl-p'>[</span><span class='hljl-ni'>2</span><span class='hljl-p'>][</span><span class='hljl-ni'>3</span><span class='hljl-p'>])</span><span class='hljl-t'>
</span><span class='hljl-nd'>@printf</span><span class='hljl-p'>(</span><span class='hljl-s'>&quot;Step 3  | %10.7f | %10.7f | %10.7f |</span><span class='hljl-se'>\n</span><span class='hljl-s'>&quot;</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>β_GMM_iter</span><span class='hljl-p'>[</span><span class='hljl-ni'>3</span><span class='hljl-p'>][</span><span class='hljl-ni'>1</span><span class='hljl-p'>],</span><span class='hljl-t'> </span><span class='hljl-n'>β_GMM_iter</span><span class='hljl-p'>[</span><span class='hljl-ni'>3</span><span class='hljl-p'>][</span><span class='hljl-ni'>2</span><span class='hljl-p'>],</span><span class='hljl-t'> </span><span class='hljl-n'>β_GMM_iter</span><span class='hljl-p'>[</span><span class='hljl-ni'>3</span><span class='hljl-p'>][</span><span class='hljl-ni'>3</span><span class='hljl-p'>])</span><span class='hljl-t'>
</span><span class='hljl-nd'>@printf</span><span class='hljl-p'>(</span><span class='hljl-s'>&quot;        |(%10.7f)|(%10.7f)|(%10.7f)|</span><span class='hljl-se'>\n</span><span class='hljl-s'>&quot;</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>σ_GMM_iter</span><span class='hljl-p'>[</span><span class='hljl-ni'>3</span><span class='hljl-p'>][</span><span class='hljl-ni'>1</span><span class='hljl-p'>],</span><span class='hljl-t'> </span><span class='hljl-n'>σ_GMM_iter</span><span class='hljl-p'>[</span><span class='hljl-ni'>3</span><span class='hljl-p'>][</span><span class='hljl-ni'>2</span><span class='hljl-p'>],</span><span class='hljl-t'> </span><span class='hljl-n'>σ_GMM_iter</span><span class='hljl-p'>[</span><span class='hljl-ni'>3</span><span class='hljl-p'>][</span><span class='hljl-ni'>3</span><span class='hljl-p'>])</span><span class='hljl-t'>
</span><span class='hljl-nd'>@printf</span><span class='hljl-p'>(</span><span class='hljl-s'>&quot;Step 4  | %10.7f | %10.7f | %10.7f |</span><span class='hljl-se'>\n</span><span class='hljl-s'>&quot;</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>β_GMM_iter</span><span class='hljl-p'>[</span><span class='hljl-ni'>4</span><span class='hljl-p'>][</span><span class='hljl-ni'>1</span><span class='hljl-p'>],</span><span class='hljl-t'> </span><span class='hljl-n'>β_GMM_iter</span><span class='hljl-p'>[</span><span class='hljl-ni'>4</span><span class='hljl-p'>][</span><span class='hljl-ni'>2</span><span class='hljl-p'>],</span><span class='hljl-t'> </span><span class='hljl-n'>β_GMM_iter</span><span class='hljl-p'>[</span><span class='hljl-ni'>4</span><span class='hljl-p'>][</span><span class='hljl-ni'>3</span><span class='hljl-p'>])</span><span class='hljl-t'>
</span><span class='hljl-nd'>@printf</span><span class='hljl-p'>(</span><span class='hljl-s'>&quot;        |(%10.7f)|(%10.7f)|(%10.7f)|</span><span class='hljl-se'>\n</span><span class='hljl-s'>&quot;</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>σ_GMM_iter</span><span class='hljl-p'>[</span><span class='hljl-ni'>4</span><span class='hljl-p'>][</span><span class='hljl-ni'>1</span><span class='hljl-p'>],</span><span class='hljl-t'> </span><span class='hljl-n'>σ_GMM_iter</span><span class='hljl-p'>[</span><span class='hljl-ni'>4</span><span class='hljl-p'>][</span><span class='hljl-ni'>2</span><span class='hljl-p'>],</span><span class='hljl-t'> </span><span class='hljl-n'>σ_GMM_iter</span><span class='hljl-p'>[</span><span class='hljl-ni'>4</span><span class='hljl-p'>][</span><span class='hljl-ni'>3</span><span class='hljl-p'>])</span><span class='hljl-t'>
</span><span class='hljl-nf'>print</span><span class='hljl-p'>(</span><span class='hljl-s'>&quot;Standard errors in parentheses.&quot;</span><span class='hljl-p'>)</span>
</pre>


<pre class="output">
Iterated GMM result, overidentified: β₂ is biased in OLS 
        |     β₀     |     β₁     |     β₂     | 
DGP     |  0.1500000 |  0.2500000 | -1.5000000 |
Step 1  |  0.1467573 |  0.2517024 | -1.5115486 |
        |&#40; 0.0044970&#41;|&#40; 0.0045002&#41;|&#40; 0.0044782&#41;|
Step 2  |  0.1467965 |  0.2517965 | -1.5117060 |
        |&#40; 0.0044973&#41;|&#40; 0.0045002&#41;|&#40; 0.0044777&#41;|
Step 3  |  0.1467964 |  0.2517965 | -1.5117060 |
        |&#40; 0.0044973&#41;|&#40; 0.0045002&#41;|&#40; 0.0044777&#41;|
Step 4  |  0.1467964 |  0.2517965 | -1.5117060 |
        |&#40; 0.0044973&#41;|&#40; 0.0045002&#41;|&#40; 0.0044777&#41;|
Standard errors in parentheses.
</pre>


<h2><a href="#review_menu">Review model</a>&lt;a name&#61;&quot;review&quot;&gt;&lt;/a&gt;</h2>

<p>We consider the following model</p>
<p class="math">\[
    1=\mathbb{E}_{t}\left[r_{t+1, k} \beta \frac{u^{\prime}\left(c_{t+1}\right)}{u^{\prime}\left(c_{t}\right)}\right] \equiv \mathbb{E}_{t}\left[r_{t+1, k} MRS_{t+1}\right]
\]</p>
<p>where:</p>
<ul>
<li><p class="math">\[
r_{t+1,k}
\]</p>
<p>is gross real return on asset <span class="math">$k$</span></p>
</li>
<li><p class="math">\[
\beta \frac{u^{\prime}\left(c_{t+1}\right)}{u^{\prime}\left(c_{t}\right)}
\]</p>
<p>is marginal rate of substitution &#40;MRS&#41;.</p>
</li>
</ul>
<p>Subtracting 1 from each side, we have:</p>
<p class="math">\[
    0=\mathbb{E}_{t}\left[r_{t+1, k} \beta \frac{u^{\prime}\left(c_{t+1}\right)}{u^{\prime}\left(c_{t}\right)}-1\right]
\]</p>
<p>Under the assumption this  model is true, we use data <span class="math">$\{(r_{t+1,k},c_{t},c_{t+1})\}_{t=1}^{T}$</span> and estimate the parameters of interest.</p>

<p>Let&#39;s parametrize the utility function as in Hansen and Singleton &#40;1982&#41;.</p>
<p class="math">\[
    u\left(c_{t}\right)=(1+\alpha)^{-1} c_{t}^{1+\alpha}
\]</p>
<p>Notice this utility function exhibits constant relative risk aversion &#40;CRRA&#41; if <span class="math">$\alpha<0$</span>. The population moment becomes a specific nonlinear function of data and parameters:</p>
<p class="math">\[
    \mathbb{E}_t\left[r_{t+1,k}\beta\left(\frac{c_{t+1}}{c_{t}}\right)^{\alpha}-1\right] = 0
\]</p>
<p>where expectation is taken over the information available at <span class="math">$t$</span>. In other words, any deviation from the equality <span class="math">$r_{t+1,k}\beta(\frac{c_{t+1}}{c_{t}})^\alpha-1=0$</span> is considered as error.</p>

<p>We wish to use information <span class="math">$\mathbf{x_t} \in I_t$</span> where <span class="math">$I_t$</span> the information set known by the agent and <span class="math">$\mathbf{x_t}$</span> a vector of information observed by econometrician at time <span class="math">$t$</span>. If <span class="math">$\mathbf{x_t}$</span> is orthogonal to the moment, we can use <span class="math">$\mathbf{x_t}$</span> as an instrument:</p>
<p class="math">\[
    \mathbb{E}\left[\mathbf{x_t}\varepsilon_t|I_t\right]:=\mathbb{E}\left[\mathbf{x_t}\cdot\left(r_{t+1,k}\beta\left(\frac{c_{t+1}}{c_{t}}\right)^{\alpha}-1\right)\right]=0
\]</p>

<h2><a href="#data">Data</a>&lt;a name&#61;&quot;data&quot;&gt;&lt;/a&gt;</h2>

<p>We aim to construct the following data in estimation:</p>
<ul>
<li><p>Real consumption on expenditure on nondurables per capita</p>
</li>
<li><p>Real consumption on nondurables and services per capita</p>
</li>
<li><p>Value weighted aggregate stock returns</p>
</li>
<li><p>Equally weighted aggregate stock returns</p>
</li>
<li><p>S&amp;P composite returns &#40;Hansen and Singleton uses NYSE&#41;</p>
</li>
</ul>

<p>We use the following data:</p>
<ul>
<li><p>FRED Data: https://fred.stlouisfed.org/series/&#91;INDEX NAME&#93;.</p>
<ul>
<li><p>Personal Consumption Expenditures: Nondurable Goods &#40;PCEND&#41;</p>
</li>
<li><p>Personal Consumption Expenditures: Nondurable Goods &#40;chain-type price index&#41; &#40;DNDGRG3M086SBEA, PPCEND&#41;</p>
</li>
<li><p>Personal Consumption Expenditures: Services &#40;PCES&#41;</p>
</li>
<li><p>Personal Consumption Expenditures: Services &#40;chain-type price index&#41; &#40;DSERRG3M086SBEA, PPCES&#41;</p>
</li>
<li><p>Consumer Price Index for All Urban Consumers: All Items in U.S. City Average &#40;CPIAUCSL&#41;</p>
</li>
<li><p>Population &#40;POPTHM&#41;</p>
</li>
<li><p>Population Level &#40;CNP16OV&#41;</p>
</li>
<li><p>1-Year Treasury Constant Maturity Rate &#40;GS1&#41;</p>
</li>
<li><p>Real Personal Consumption Expenditures per Capita: Goods: Nondurable goods &#40;A796RX0Q048SBEA&#41;</p>
</li>
<li><p>Real Personal Consumption Expenditures per Capita: Services &#40;A797RX0Q048SBEA&#41;</p>
</li>
</ul>
</li>
<li><p>WRDS Data &#40;CRSP&#41;</p>
<ul>
<li><p>Value-Weighted Return &#40;Incldues Distributions&#41;  &#40;vwretd&#41;</p>
</li>
<li><p>Value-Weighted Return &#40;Excluding Dividends&#41;     &#40;vwretx&#41;</p>
</li>
<li><p>Equal-Weighted Return &#40;Includes Distributions&#41;  &#40;ewretd&#41;</p>
</li>
<li><p>Equal-Weighted Return &#40;Excluding Dividends&#41;     &#40;ewretx&#41;</p>
</li>
<li><p>Return on S&amp;P Composite Index &#40;sprtrn&#41;</p>
</li>
<li><p>Level on S&amp;P Composite Index &#40;spindx&#41;</p>
</li>
</ul>
</li>
</ul>


<pre class='hljl'>
<span class='hljl-cs'>#%% Fred Data: API available at https://github.com/markushhh/FredApi.jl</span><span class='hljl-t'>
</span><span class='hljl-n'>path</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-s'>&quot;C:/Users/jaepil/Documents/GitHub/Prof_Miller_structural_econometrics/2. Hansen and Singleton, 1982 (GMM)&quot;</span><span class='hljl-t'>
</span><span class='hljl-nf'>set_api_key</span><span class='hljl-p'>(</span><span class='hljl-s'>&quot;###&quot;</span><span class='hljl-p'>);</span><span class='hljl-t'> </span><span class='hljl-cs'># you should get your own API key!</span><span class='hljl-t'>

</span><span class='hljl-cs'># Monthly Data:</span><span class='hljl-t'>
</span><span class='hljl-n'>series_code</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-p'>[</span><span class='hljl-s'>&quot;PCEND&quot;</span><span class='hljl-p'>,</span><span class='hljl-s'>&quot;DNDGRG3M086SBEA&quot;</span><span class='hljl-p'>,</span><span class='hljl-s'>&quot;PCES&quot;</span><span class='hljl-p'>,</span><span class='hljl-s'>&quot;DSERRG3M086SBEA&quot;</span><span class='hljl-p'>,</span><span class='hljl-s'>&quot;CNP16OV&quot;</span><span class='hljl-p'>,</span><span class='hljl-s'>&quot;GS1&quot;</span><span class='hljl-p'>,</span><span class='hljl-s'>&quot;CPIAUCSL&quot;</span><span class='hljl-p'>];</span><span class='hljl-t'>
</span><span class='hljl-n'>series_name</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-p'>[</span><span class='hljl-s'>&quot;PCEND&quot;</span><span class='hljl-p'>,</span><span class='hljl-s'>&quot;PPCEND&quot;</span><span class='hljl-p'>,</span><span class='hljl-s'>&quot;PCES&quot;</span><span class='hljl-p'>,</span><span class='hljl-s'>&quot;PPCES&quot;</span><span class='hljl-p'>,</span><span class='hljl-s'>&quot;POP&quot;</span><span class='hljl-p'>,</span><span class='hljl-s'>&quot;RF&quot;</span><span class='hljl-p'>,</span><span class='hljl-s'>&quot;CPI&quot;</span><span class='hljl-p'>];</span><span class='hljl-t'>

</span><span class='hljl-cs'># Quarterly Data:</span><span class='hljl-t'>
</span><span class='hljl-n'>realND_code</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-s'>&quot;A796RX0Q048SBEA&quot;</span><span class='hljl-p'>;</span><span class='hljl-t'> </span><span class='hljl-n'>realND_name</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-s'>&quot;pce_real_ndg&quot;</span><span class='hljl-p'>;</span><span class='hljl-t'>
</span><span class='hljl-n'>realS_code</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-s'>&quot;A797RX0Q048SBEA&quot;</span><span class='hljl-p'>;</span><span class='hljl-t'> </span><span class='hljl-n'>realS_name</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-s'>&quot;pce_real_svc&quot;</span><span class='hljl-p'>;</span><span class='hljl-t'>

</span><span class='hljl-n'>init_date</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-s'>&quot;1959-12-01&quot;</span><span class='hljl-p'>;</span><span class='hljl-t'> </span><span class='hljl-n'>end_date</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-s'>&quot;2020-12-01&quot;</span><span class='hljl-p'>;</span><span class='hljl-t'>
</span><span class='hljl-n'>Fred_df</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-nf'>DataFrame</span><span class='hljl-p'>()</span><span class='hljl-t'>
</span><span class='hljl-n'>Fred_df</span><span class='hljl-p'>[</span><span class='hljl-oB'>!</span><span class='hljl-p'>,</span><span class='hljl-oB'>:</span><span class='hljl-n'>timestamp</span><span class='hljl-p'>]</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-nf'>DataFrame</span><span class='hljl-p'>(</span><span class='hljl-nf'>get_symbols</span><span class='hljl-p'>(</span><span class='hljl-s'>&quot;PCEND&quot;</span><span class='hljl-p'>,</span><span class='hljl-n'>init_date</span><span class='hljl-p'>,</span><span class='hljl-n'>end_date</span><span class='hljl-p'>))[</span><span class='hljl-ni'>1</span><span class='hljl-p'>]</span><span class='hljl-t'>
</span><span class='hljl-n'>Fred_df</span><span class='hljl-p'>[</span><span class='hljl-oB'>!</span><span class='hljl-p'>,</span><span class='hljl-n'>Symbol</span><span class='hljl-oB'>.</span><span class='hljl-p'>(</span><span class='hljl-n'>series_name</span><span class='hljl-p'>[</span><span class='hljl-ni'>1</span><span class='hljl-p'>])]</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-nf'>DataFrame</span><span class='hljl-p'>(</span><span class='hljl-nf'>get_symbols</span><span class='hljl-p'>(</span><span class='hljl-s'>&quot;PCEND&quot;</span><span class='hljl-p'>,</span><span class='hljl-n'>init_date</span><span class='hljl-p'>,</span><span class='hljl-n'>end_date</span><span class='hljl-p'>))[</span><span class='hljl-ni'>2</span><span class='hljl-p'>]</span><span class='hljl-t'>
</span><span class='hljl-k'>for</span><span class='hljl-t'> </span><span class='hljl-p'>(</span><span class='hljl-n'>i</span><span class='hljl-p'>,</span><span class='hljl-n'>j</span><span class='hljl-p'>)</span><span class='hljl-t'> </span><span class='hljl-kp'>in</span><span class='hljl-t'> </span><span class='hljl-nf'>enumerate</span><span class='hljl-p'>(</span><span class='hljl-n'>series_code</span><span class='hljl-p'>)</span><span class='hljl-t'>
    </span><span class='hljl-n'>Fred_df</span><span class='hljl-p'>[</span><span class='hljl-oB'>!</span><span class='hljl-p'>,</span><span class='hljl-nf'>Symbol</span><span class='hljl-p'>(</span><span class='hljl-n'>series_name</span><span class='hljl-p'>[</span><span class='hljl-n'>i</span><span class='hljl-p'>])]</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-nf'>DataFrame</span><span class='hljl-p'>(</span><span class='hljl-nf'>get_symbols</span><span class='hljl-p'>(</span><span class='hljl-n'>j</span><span class='hljl-p'>,</span><span class='hljl-n'>init_date</span><span class='hljl-p'>,</span><span class='hljl-n'>end_date</span><span class='hljl-p'>))[</span><span class='hljl-ni'>2</span><span class='hljl-p'>]</span><span class='hljl-t'>
</span><span class='hljl-k'>end</span><span class='hljl-t'>

</span><span class='hljl-n'>wrds</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-n'>CSV</span><span class='hljl-oB'>.</span><span class='hljl-nf'>read</span><span class='hljl-p'>(</span><span class='hljl-nf'>string</span><span class='hljl-p'>(</span><span class='hljl-n'>path</span><span class='hljl-p'>,</span><span class='hljl-s'>&quot;/WRDS.csv&quot;</span><span class='hljl-p'>),</span><span class='hljl-n'>dateformat</span><span class='hljl-oB'>=</span><span class='hljl-s'>&quot;mm/dd/yyyy&quot;</span><span class='hljl-p'>)[</span><span class='hljl-ni'>13</span><span class='hljl-oB'>:</span><span class='hljl-k'>end</span><span class='hljl-p'>,</span><span class='hljl-oB'>:</span><span class='hljl-p'>];</span><span class='hljl-t'> </span><span class='hljl-cs'># 1960/01 to 2020/12</span><span class='hljl-t'>

</span><span class='hljl-n'>Fred_xt</span><span class='hljl-t'>  </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-nf'>TimeArray</span><span class='hljl-p'>(</span><span class='hljl-n'>Fred_df</span><span class='hljl-p'>,</span><span class='hljl-n'>timestamp</span><span class='hljl-oB'>=:</span><span class='hljl-n'>timestamp</span><span class='hljl-p'>);</span><span class='hljl-t'>
</span><span class='hljl-n'>wrds_xt</span><span class='hljl-t'>  </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-nf'>TimeArray</span><span class='hljl-p'>(</span><span class='hljl-n'>wrds</span><span class='hljl-p'>,</span><span class='hljl-n'>timestamp</span><span class='hljl-oB'>=:</span><span class='hljl-n'>DATE</span><span class='hljl-p'>);</span>
</pre>


<pre class="julia-error">
ERROR: UndefVarError: set_api_key not defined
</pre>


<h3>Representative Consumer Model: Interpreting estimates from aggregate data</h3>
<p>To interpret these results, lifetime utility is:</p>
<p class="math">\[
\sum_{t=1}^{\infty} \beta^{t} u\left(c_{t}\right)=(1+\alpha)^{-1} \sum_{t=1}^{\infty} \beta^{t} c_{t}^{1+\alpha}
\]</p>
<ul>
<li><p>NDS &#40;nondurables plus services&#41;</p>
</li>
<li><p>ND &#40;nondurables&#41;</p>
</li>
<li><p>EWR &#40;NYSE equally weighted average returns&#41;</p>
</li>
<li><p>VWR &#40;NYSE value weighted average returns&#41; </p>
<ul>
<li><p>Chemicals, transportation and equipment, and other retail, comprised the three industries.</p>
</li>
</ul>
</li>
<li><p>Note that:</p>
<ul>
<li><p>10 out of 12 specifications in Table III are rejected at the 0.05 level. </p>
</li>
<li><p>Since <span class="math">$\alpha>0$</span> implies convex increasing <span class="math">$u\left(c_{t}\right),$</span> the 2 remaining specifications in Table III not rejected in a statistical sense do not make economic sense.</p>
</li>
</ul>
</li>
</ul>

<h4>Question 1. From 1960 to present, plot the aggregate monthly series of:</h4>
<ul>
<li><p>Real consumption on expenditure on nondurables per capita <span class="math">$c_{t}$</span> and its ratio <span class="math">$c_{t+1} / c_{t}$</span></p>
</li>
<li><p>Real consumption on nondurables and services per capita <span class="math">$c_{t}^{*}$</span> and its ratio <span class="math">$c_{t+1}^{*} / c_{t}^{*}$</span></p>
</li>
<li><p>Value weighted aggregate stock returns <span class="math">$r_{t+1}$</span></p>
</li>
<li><p>Equally weighted aggregate stock returns <span class="math">$r_{t+1}^{*}$</span></p>
</li>
</ul>

<p>Real Personal Consumption Expenditure on Nondurables</p>
<p class="math">\[
    c_t = \frac{\text{Nondurables Consumption}_t * 1\text{e}9}{\text{Nondurables CPI}_t/100}*\frac{1}{\text{Population}_t * 1\text{e}3}
\]</p>
<p>Real Personal Consumption Expenditure on Nondurables and Services</p>
<p class="math">\[
    c_t^* = \left(\frac{\text{Nondurables Consumption}_t * 1\text{e}9}{\text{Nondurables CPI}_t/100}+\frac{\text{Services Consumption}_t * 1\text{e}9}{\text{Services CPI}_t/100}\right)*\frac{1}{\text{Population}_t * 1\text{e}3}
\]</p>
<p>Real Value-weighted Return &#40;VWRETD&#41;</p>
<p class="math">\[
    r_t = \text{Real Value-weighted Return}_t = \frac{1+\text{Value-weighted Return}_t}{\text{CPI}_{t}/\text{CPI}_{t-1}}
\]</p>
<p>Real Equal-weighted Return &#40;EWRETD&#41;</p>
<p class="math">\[
    r_t^* = \text{Real Equal-weighted Return}_t = \frac{1+\text{Equal-weighted Return}_t}{\text{CPI}_t/\text{CPI}_{t-1}}
\]</p>
<p>Real S&amp;P Return &#40;SPRTRN&#41;</p>
<p class="math">\[
    r_t^{**} = \text{Real S\&P Return}_t = \frac{1+\text{S\&P Return}_t}{\text{CPI}_t/\text{CPI}_{t-1}}
\]</p>


<pre class='hljl'>
<span class='hljl-cs'># FROM FED</span><span class='hljl-t'>
</span><span class='hljl-n'>PCEND</span><span class='hljl-t'>  </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-n'>Fred_xt</span><span class='hljl-p'>[</span><span class='hljl-sc'>:PCEND</span><span class='hljl-p'>]</span><span class='hljl-oB'>.*</span><span class='hljl-ni'>1_000_000_000</span><span class='hljl-p'>;</span><span class='hljl-t'> </span><span class='hljl-cs'># Billions of Dollars, Seasonally Adjusted Annual Rate</span><span class='hljl-t'>
</span><span class='hljl-n'>PPCEND</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-n'>Fred_xt</span><span class='hljl-p'>[</span><span class='hljl-sc'>:PPCEND</span><span class='hljl-p'>]</span><span class='hljl-oB'>./</span><span class='hljl-ni'>100</span><span class='hljl-p'>;</span><span class='hljl-t'>          </span><span class='hljl-cs'># Index 2012=100, Seasonally Adjusted</span><span class='hljl-t'>
</span><span class='hljl-n'>PCES</span><span class='hljl-t'>   </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-n'>Fred_xt</span><span class='hljl-p'>[</span><span class='hljl-sc'>:PCES</span><span class='hljl-p'>]</span><span class='hljl-oB'>.*</span><span class='hljl-ni'>1_000_000_000</span><span class='hljl-p'>;</span><span class='hljl-t'>  </span><span class='hljl-cs'># Billions of Dollars, Seasonally Adjusted Annual Rate</span><span class='hljl-t'>
</span><span class='hljl-n'>PPCES</span><span class='hljl-t'>  </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-n'>Fred_xt</span><span class='hljl-p'>[</span><span class='hljl-sc'>:PPCES</span><span class='hljl-p'>]</span><span class='hljl-oB'>./</span><span class='hljl-ni'>100</span><span class='hljl-p'>;</span><span class='hljl-t'>           </span><span class='hljl-cs'># Index 2012=100, Seasonally Adjusted</span><span class='hljl-t'>
</span><span class='hljl-n'>POP</span><span class='hljl-t'>    </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-n'>Fred_xt</span><span class='hljl-p'>[</span><span class='hljl-sc'>:POP</span><span class='hljl-p'>]</span><span class='hljl-oB'>.*</span><span class='hljl-ni'>1000</span><span class='hljl-p'>;</span><span class='hljl-t'>            </span><span class='hljl-cs'># Thousands of Persons</span><span class='hljl-t'>
</span><span class='hljl-n'>RF</span><span class='hljl-t'>     </span><span class='hljl-oB'>=</span><span class='hljl-p'>(</span><span class='hljl-n'>Fred_xt</span><span class='hljl-p'>[</span><span class='hljl-sc'>:RF</span><span class='hljl-p'>]</span><span class='hljl-oB'>./</span><span class='hljl-ni'>100</span><span class='hljl-p'>)[</span><span class='hljl-ni'>2</span><span class='hljl-oB'>:</span><span class='hljl-k'>end</span><span class='hljl-p'>];</span><span class='hljl-t'>      </span><span class='hljl-cs'># Percent, Not Seasonally Adjusted from 1960/01 to 2020/12</span><span class='hljl-t'>
</span><span class='hljl-n'>CPI</span><span class='hljl-t'>    </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-n'>Fred_xt</span><span class='hljl-p'>[</span><span class='hljl-sc'>:CPI</span><span class='hljl-p'>]</span><span class='hljl-oB'>./</span><span class='hljl-ni'>100</span><span class='hljl-p'>;</span><span class='hljl-t'>             </span><span class='hljl-cs'># CPI</span><span class='hljl-t'>

</span><span class='hljl-cs'># FROM WRDS</span><span class='hljl-t'>
</span><span class='hljl-n'>VWRETD</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-n'>wrds</span><span class='hljl-p'>[</span><span class='hljl-sc'>:vwretd</span><span class='hljl-p'>];</span><span class='hljl-t'>                  </span><span class='hljl-cs'># Value-Weighted Return (Incldues Distributions)  (vwretd)</span><span class='hljl-t'>
</span><span class='hljl-n'>VWRETX</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-n'>wrds</span><span class='hljl-p'>[</span><span class='hljl-sc'>:vwretx</span><span class='hljl-p'>];</span><span class='hljl-t'>                  </span><span class='hljl-cs'># Value-Weighted Return (Excluding Dividends)     (vwretx)</span><span class='hljl-t'>
</span><span class='hljl-n'>EWRETD</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-n'>wrds</span><span class='hljl-p'>[</span><span class='hljl-sc'>:ewretd</span><span class='hljl-p'>];</span><span class='hljl-t'>                  </span><span class='hljl-cs'># Equal-Weighted Return (Includes Distributions)  (ewretd)</span><span class='hljl-t'>
</span><span class='hljl-n'>EWRETX</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-n'>wrds</span><span class='hljl-p'>[</span><span class='hljl-sc'>:ewretx</span><span class='hljl-p'>];</span><span class='hljl-t'>                  </span><span class='hljl-cs'># Equal-Weighted Return (Excluding Dividends)     (ewretx)</span><span class='hljl-t'>
</span><span class='hljl-n'>SPRTRN</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-n'>wrds</span><span class='hljl-p'>[</span><span class='hljl-sc'>:sprtrn</span><span class='hljl-p'>];</span><span class='hljl-t'>                  </span><span class='hljl-cs'># Return on S&amp;P Composite Index (sprtrn)</span><span class='hljl-t'>
</span><span class='hljl-n'>SPINDX</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-n'>wrds</span><span class='hljl-p'>[</span><span class='hljl-sc'>:spindx</span><span class='hljl-p'>];</span><span class='hljl-t'>                  </span><span class='hljl-cs'># Level on S&amp;P Composite Index (spindx)</span><span class='hljl-t'>

</span><span class='hljl-cs'># Real Personal Consumption Expenditure</span><span class='hljl-t'>
</span><span class='hljl-n'>rPCENDpc</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-n'>PCEND</span><span class='hljl-oB'>./</span><span class='hljl-p'>(</span><span class='hljl-n'>PPCEND</span><span class='hljl-oB'>.*</span><span class='hljl-n'>POP</span><span class='hljl-p'>);</span><span class='hljl-t'>
</span><span class='hljl-n'>rPCESpc</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-n'>PCES</span><span class='hljl-oB'>./</span><span class='hljl-p'>(</span><span class='hljl-n'>PPCES</span><span class='hljl-oB'>.*</span><span class='hljl-n'>POP</span><span class='hljl-p'>);</span><span class='hljl-t'>
</span><span class='hljl-n'>rPCEpc</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-n'>rPCENDpc</span><span class='hljl-t'> </span><span class='hljl-oB'>.+</span><span class='hljl-t'> </span><span class='hljl-n'>rPCESpc</span><span class='hljl-p'>;</span><span class='hljl-t'>
</span><span class='hljl-n'>rPCENDpcRatio</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-n'>rPCENDpc</span><span class='hljl-oB'>./</span><span class='hljl-nf'>lag</span><span class='hljl-p'>(</span><span class='hljl-n'>rPCENDpc</span><span class='hljl-p'>,</span><span class='hljl-ni'>1</span><span class='hljl-p'>,</span><span class='hljl-n'>padding</span><span class='hljl-oB'>=</span><span class='hljl-kc'>false</span><span class='hljl-p'>);</span><span class='hljl-t'>
</span><span class='hljl-n'>rPCEpcRatio</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-n'>rPCEpc</span><span class='hljl-oB'>./</span><span class='hljl-nf'>lag</span><span class='hljl-p'>(</span><span class='hljl-n'>rPCEpc</span><span class='hljl-p'>,</span><span class='hljl-ni'>1</span><span class='hljl-p'>,</span><span class='hljl-n'>padding</span><span class='hljl-oB'>=</span><span class='hljl-kc'>false</span><span class='hljl-p'>);</span><span class='hljl-t'>
</span><span class='hljl-n'>TimeSeries</span><span class='hljl-oB'>.</span><span class='hljl-nf'>rename!</span><span class='hljl-p'>(</span><span class='hljl-n'>rPCENDpc</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-sc'>:rPCENDpc</span><span class='hljl-p'>);</span><span class='hljl-t'>
</span><span class='hljl-n'>TimeSeries</span><span class='hljl-oB'>.</span><span class='hljl-nf'>rename!</span><span class='hljl-p'>(</span><span class='hljl-n'>rPCESpc</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-sc'>:rPCESpc</span><span class='hljl-p'>);</span><span class='hljl-t'>
</span><span class='hljl-n'>TimeSeries</span><span class='hljl-oB'>.</span><span class='hljl-nf'>rename!</span><span class='hljl-p'>(</span><span class='hljl-n'>rPCEpc</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-sc'>:rPCEpc</span><span class='hljl-p'>);</span><span class='hljl-t'>
</span><span class='hljl-n'>TimeSeries</span><span class='hljl-oB'>.</span><span class='hljl-nf'>rename!</span><span class='hljl-p'>(</span><span class='hljl-n'>rPCENDpcRatio</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-sc'>:rPCENDpcRatio</span><span class='hljl-p'>);</span><span class='hljl-t'>
</span><span class='hljl-n'>TimeSeries</span><span class='hljl-oB'>.</span><span class='hljl-nf'>rename!</span><span class='hljl-p'>(</span><span class='hljl-n'>rPCEpcRatio</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-sc'>:rPCEpcRatio</span><span class='hljl-p'>);</span><span class='hljl-t'>

</span><span class='hljl-cs'># Inflation and Risk-free Return</span><span class='hljl-t'>
</span><span class='hljl-n'>INF</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-n'>CPI</span><span class='hljl-oB'>./</span><span class='hljl-nf'>lag</span><span class='hljl-p'>(</span><span class='hljl-n'>CPI</span><span class='hljl-p'>,</span><span class='hljl-ni'>1</span><span class='hljl-p'>,</span><span class='hljl-n'>padding</span><span class='hljl-oB'>=</span><span class='hljl-kc'>false</span><span class='hljl-p'>);</span><span class='hljl-t'>
</span><span class='hljl-n'>nRF</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-n'>RF</span><span class='hljl-p'>;</span><span class='hljl-t'> </span><span class='hljl-cs'># Nominal risk-free rate</span><span class='hljl-t'>
</span><span class='hljl-n'>TimeSeries</span><span class='hljl-oB'>.</span><span class='hljl-nf'>rename!</span><span class='hljl-p'>(</span><span class='hljl-n'>INF</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-sc'>:INF</span><span class='hljl-p'>);</span><span class='hljl-t'>
</span><span class='hljl-n'>TimeSeries</span><span class='hljl-oB'>.</span><span class='hljl-nf'>rename!</span><span class='hljl-p'>(</span><span class='hljl-n'>nRF</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-sc'>:nRF</span><span class='hljl-p'>);</span><span class='hljl-t'>

</span><span class='hljl-cs'># S&amp;P market return</span><span class='hljl-t'>
</span><span class='hljl-n'>rVWRETD</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-p'>(</span><span class='hljl-ni'>1</span><span class='hljl-t'> </span><span class='hljl-oB'>.+</span><span class='hljl-t'> </span><span class='hljl-n'>VWRETD</span><span class='hljl-p'>)</span><span class='hljl-t'> </span><span class='hljl-oB'>./</span><span class='hljl-t'> </span><span class='hljl-n'>INF</span><span class='hljl-t'>
</span><span class='hljl-n'>rEWRETD</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-p'>(</span><span class='hljl-ni'>1</span><span class='hljl-t'> </span><span class='hljl-oB'>.+</span><span class='hljl-t'> </span><span class='hljl-n'>EWRETD</span><span class='hljl-p'>)</span><span class='hljl-t'> </span><span class='hljl-oB'>./</span><span class='hljl-t'> </span><span class='hljl-n'>INF</span><span class='hljl-t'>
</span><span class='hljl-n'>rSPRTRN</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-p'>(</span><span class='hljl-ni'>1</span><span class='hljl-t'> </span><span class='hljl-oB'>.+</span><span class='hljl-t'> </span><span class='hljl-n'>SPRTRN</span><span class='hljl-p'>)</span><span class='hljl-t'> </span><span class='hljl-oB'>./</span><span class='hljl-t'> </span><span class='hljl-n'>INF</span><span class='hljl-t'>
</span><span class='hljl-n'>TimeSeries</span><span class='hljl-oB'>.</span><span class='hljl-nf'>rename!</span><span class='hljl-p'>(</span><span class='hljl-n'>rVWRETD</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-sc'>:rVWRETD</span><span class='hljl-p'>);</span><span class='hljl-t'>
</span><span class='hljl-n'>TimeSeries</span><span class='hljl-oB'>.</span><span class='hljl-nf'>rename!</span><span class='hljl-p'>(</span><span class='hljl-n'>rEWRETD</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-sc'>:rEWRETD</span><span class='hljl-p'>);</span><span class='hljl-t'>
</span><span class='hljl-n'>TimeSeries</span><span class='hljl-oB'>.</span><span class='hljl-nf'>rename!</span><span class='hljl-p'>(</span><span class='hljl-n'>rSPRTRN</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-sc'>:rSPRTRN</span><span class='hljl-p'>);</span>
</pre>


<pre class="julia-error">
ERROR: UndefVarError: Fred_xt not defined
</pre>



<pre class='hljl'>
<span class='hljl-nf'>gr</span><span class='hljl-p'>(</span><span class='hljl-n'>fmt</span><span class='hljl-oB'>=</span><span class='hljl-n'>png</span><span class='hljl-p'>);</span><span class='hljl-t'>
</span><span class='hljl-n'>min_date</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-n'>Dates</span><span class='hljl-oB'>.</span><span class='hljl-nf'>Date</span><span class='hljl-p'>(</span><span class='hljl-ni'>1960</span><span class='hljl-p'>,</span><span class='hljl-ni'>1</span><span class='hljl-p'>,</span><span class='hljl-ni'>1</span><span class='hljl-p'>)</span><span class='hljl-t'>
</span><span class='hljl-n'>max_date</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-n'>Dates</span><span class='hljl-oB'>.</span><span class='hljl-nf'>Date</span><span class='hljl-p'>(</span><span class='hljl-ni'>2020</span><span class='hljl-p'>,</span><span class='hljl-ni'>12</span><span class='hljl-p'>,</span><span class='hljl-ni'>1</span><span class='hljl-p'>)</span><span class='hljl-t'>
</span><span class='hljl-n'>p1</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-nf'>plot</span><span class='hljl-p'>(</span><span class='hljl-n'>rPCENDpc</span><span class='hljl-p'>,</span><span class='hljl-n'>label</span><span class='hljl-oB'>=</span><span class='hljl-s'>&quot;&quot;</span><span class='hljl-p'>,</span><span class='hljl-t'>
          </span><span class='hljl-n'>title</span><span class='hljl-oB'>=</span><span class='hljl-so'>L&quot;C_{t}: \textrm{PCEND per capita (Deflated)}&quot;</span><span class='hljl-p'>,</span><span class='hljl-t'>
          </span><span class='hljl-n'>xlims</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-n'>Dates</span><span class='hljl-oB'>.</span><span class='hljl-n'>value</span><span class='hljl-oB'>.</span><span class='hljl-p'>([</span><span class='hljl-n'>min_date</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>max_date</span><span class='hljl-p'>]),</span><span class='hljl-t'>
          </span><span class='hljl-n'>xticks</span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-n'>min_date</span><span class='hljl-oB'>:</span><span class='hljl-nf'>Year</span><span class='hljl-p'>(</span><span class='hljl-ni'>10</span><span class='hljl-p'>)</span><span class='hljl-oB'>:</span><span class='hljl-n'>max_date</span><span class='hljl-p'>)</span><span class='hljl-t'>
</span><span class='hljl-n'>p2</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-nf'>plot</span><span class='hljl-p'>(</span><span class='hljl-n'>rPCENDpcRatio</span><span class='hljl-p'>,</span><span class='hljl-n'>label</span><span class='hljl-oB'>=</span><span class='hljl-s'>&quot;&quot;</span><span class='hljl-p'>,</span><span class='hljl-t'>
          </span><span class='hljl-n'>title</span><span class='hljl-oB'>=</span><span class='hljl-so'>L&quot;C_{t+1}/C_{t}: \textrm{PCEND per capita Ratio}&quot;</span><span class='hljl-p'>,</span><span class='hljl-t'>
          </span><span class='hljl-n'>xlims</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-n'>Dates</span><span class='hljl-oB'>.</span><span class='hljl-n'>value</span><span class='hljl-oB'>.</span><span class='hljl-p'>([</span><span class='hljl-n'>min_date</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>max_date</span><span class='hljl-p'>]),</span><span class='hljl-t'>
          </span><span class='hljl-n'>xticks</span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-n'>min_date</span><span class='hljl-oB'>:</span><span class='hljl-nf'>Year</span><span class='hljl-p'>(</span><span class='hljl-ni'>10</span><span class='hljl-p'>)</span><span class='hljl-oB'>:</span><span class='hljl-n'>max_date</span><span class='hljl-p'>)</span><span class='hljl-t'>
</span><span class='hljl-n'>p3</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-nf'>plot</span><span class='hljl-p'>(</span><span class='hljl-n'>rPCEpc</span><span class='hljl-p'>,</span><span class='hljl-n'>label</span><span class='hljl-oB'>=</span><span class='hljl-s'>&quot;&quot;</span><span class='hljl-p'>,</span><span class='hljl-t'>
          </span><span class='hljl-n'>title</span><span class='hljl-oB'>=</span><span class='hljl-so'>L&quot;C_{t}^{*}: \textrm{PCE per capita (Deflated)}&quot;</span><span class='hljl-p'>,</span><span class='hljl-t'>
          </span><span class='hljl-n'>xlims</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-n'>Dates</span><span class='hljl-oB'>.</span><span class='hljl-n'>value</span><span class='hljl-oB'>.</span><span class='hljl-p'>([</span><span class='hljl-n'>min_date</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>max_date</span><span class='hljl-p'>]),</span><span class='hljl-t'>
          </span><span class='hljl-n'>xticks</span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-n'>min_date</span><span class='hljl-oB'>:</span><span class='hljl-nf'>Year</span><span class='hljl-p'>(</span><span class='hljl-ni'>10</span><span class='hljl-p'>)</span><span class='hljl-oB'>:</span><span class='hljl-n'>max_date</span><span class='hljl-p'>)</span><span class='hljl-t'>
</span><span class='hljl-n'>p4</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-nf'>plot</span><span class='hljl-p'>(</span><span class='hljl-n'>rPCEpcRatio</span><span class='hljl-p'>,</span><span class='hljl-n'>label</span><span class='hljl-oB'>=</span><span class='hljl-s'>&quot;&quot;</span><span class='hljl-p'>,</span><span class='hljl-t'>
          </span><span class='hljl-n'>title</span><span class='hljl-oB'>=</span><span class='hljl-so'>L&quot;C_{t+1}^{*}/C_{t}^{*}: \textrm{PCE per capita Ratio}&quot;</span><span class='hljl-p'>,</span><span class='hljl-t'>
          </span><span class='hljl-n'>xlims</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-n'>Dates</span><span class='hljl-oB'>.</span><span class='hljl-n'>value</span><span class='hljl-oB'>.</span><span class='hljl-p'>([</span><span class='hljl-n'>min_date</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>max_date</span><span class='hljl-p'>]),</span><span class='hljl-t'>
          </span><span class='hljl-n'>xticks</span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-n'>min_date</span><span class='hljl-oB'>:</span><span class='hljl-nf'>Year</span><span class='hljl-p'>(</span><span class='hljl-ni'>10</span><span class='hljl-p'>)</span><span class='hljl-oB'>:</span><span class='hljl-n'>max_date</span><span class='hljl-p'>)</span><span class='hljl-t'>
</span><span class='hljl-n'>fig_c</span><span class='hljl-oB'>=</span><span class='hljl-nf'>plot</span><span class='hljl-p'>(</span><span class='hljl-n'>p1</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>p2</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>p3</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>p4</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>layout</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-nd'>@layout</span><span class='hljl-p'>([</span><span class='hljl-n'>p1</span><span class='hljl-t'> </span><span class='hljl-n'>p3</span><span class='hljl-p'>;</span><span class='hljl-t'> </span><span class='hljl-n'>p2</span><span class='hljl-t'> </span><span class='hljl-n'>p4</span><span class='hljl-p'>]),</span><span class='hljl-t'> </span><span class='hljl-n'>label</span><span class='hljl-oB'>=</span><span class='hljl-p'>[</span><span class='hljl-s'>&quot;&quot;</span><span class='hljl-t'> </span><span class='hljl-s'>&quot;&quot;</span><span class='hljl-p'>],</span><span class='hljl-n'>size</span><span class='hljl-oB'>=</span><span class='hljl-p'>(</span><span class='hljl-ni'>1200</span><span class='hljl-p'>,</span><span class='hljl-ni'>800</span><span class='hljl-p'>))</span>
</pre>


<pre class="julia-error">
ERROR: UndefVarError: Dates not defined
</pre>



<pre class='hljl'>
<span class='hljl-n'>p1</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-nf'>plot</span><span class='hljl-p'>(</span><span class='hljl-n'>rVWRETD</span><span class='hljl-p'>,</span><span class='hljl-n'>label</span><span class='hljl-oB'>=</span><span class='hljl-s'>&quot;&quot;</span><span class='hljl-p'>,</span><span class='hljl-t'>
          </span><span class='hljl-n'>title</span><span class='hljl-oB'>=</span><span class='hljl-so'>L&quot;r_{t} \textrm{: Value-weighted Return}&quot;</span><span class='hljl-p'>,</span><span class='hljl-t'>
          </span><span class='hljl-n'>xlims</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-n'>Dates</span><span class='hljl-oB'>.</span><span class='hljl-n'>value</span><span class='hljl-oB'>.</span><span class='hljl-p'>([</span><span class='hljl-n'>min_date</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>max_date</span><span class='hljl-p'>]),</span><span class='hljl-t'>
          </span><span class='hljl-n'>xticks</span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-n'>min_date</span><span class='hljl-oB'>:</span><span class='hljl-nf'>Year</span><span class='hljl-p'>(</span><span class='hljl-ni'>15</span><span class='hljl-p'>)</span><span class='hljl-oB'>:</span><span class='hljl-n'>max_date</span><span class='hljl-p'>)</span><span class='hljl-t'>
</span><span class='hljl-n'>p2</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-nf'>plot</span><span class='hljl-p'>(</span><span class='hljl-n'>rEWRETD</span><span class='hljl-p'>,</span><span class='hljl-n'>label</span><span class='hljl-oB'>=</span><span class='hljl-s'>&quot;&quot;</span><span class='hljl-p'>,</span><span class='hljl-t'>
          </span><span class='hljl-n'>title</span><span class='hljl-oB'>=</span><span class='hljl-so'>L&quot;r_{t}^{*} \textrm{: Equal-weighted Return}&quot;</span><span class='hljl-p'>,</span><span class='hljl-t'>
          </span><span class='hljl-n'>xlims</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-n'>Dates</span><span class='hljl-oB'>.</span><span class='hljl-n'>value</span><span class='hljl-oB'>.</span><span class='hljl-p'>([</span><span class='hljl-n'>min_date</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>max_date</span><span class='hljl-p'>]),</span><span class='hljl-t'>
          </span><span class='hljl-n'>xticks</span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-n'>min_date</span><span class='hljl-oB'>:</span><span class='hljl-nf'>Year</span><span class='hljl-p'>(</span><span class='hljl-ni'>15</span><span class='hljl-p'>)</span><span class='hljl-oB'>:</span><span class='hljl-n'>max_date</span><span class='hljl-p'>)</span><span class='hljl-t'>
</span><span class='hljl-n'>p3</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-nf'>plot</span><span class='hljl-p'>(</span><span class='hljl-n'>rSPRTRN</span><span class='hljl-p'>,</span><span class='hljl-n'>label</span><span class='hljl-oB'>=</span><span class='hljl-s'>&quot;&quot;</span><span class='hljl-p'>,</span><span class='hljl-t'>
          </span><span class='hljl-n'>title</span><span class='hljl-oB'>=</span><span class='hljl-so'>L&quot;r_{t}^{**} \textrm{: S\&amp;P Return}&quot;</span><span class='hljl-p'>,</span><span class='hljl-t'>
          </span><span class='hljl-n'>xlims</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-n'>Dates</span><span class='hljl-oB'>.</span><span class='hljl-n'>value</span><span class='hljl-oB'>.</span><span class='hljl-p'>([</span><span class='hljl-n'>min_date</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>max_date</span><span class='hljl-p'>]),</span><span class='hljl-t'>
          </span><span class='hljl-n'>xticks</span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-n'>min_date</span><span class='hljl-oB'>:</span><span class='hljl-nf'>Year</span><span class='hljl-p'>(</span><span class='hljl-ni'>15</span><span class='hljl-p'>)</span><span class='hljl-oB'>:</span><span class='hljl-n'>max_date</span><span class='hljl-p'>)</span><span class='hljl-t'>
</span><span class='hljl-n'>fig_r</span><span class='hljl-oB'>=</span><span class='hljl-nf'>plot</span><span class='hljl-p'>(</span><span class='hljl-n'>p1</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>p2</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>p3</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>layout</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-nd'>@layout</span><span class='hljl-p'>([</span><span class='hljl-n'>p1</span><span class='hljl-t'> </span><span class='hljl-n'>p2</span><span class='hljl-t'> </span><span class='hljl-n'>p3</span><span class='hljl-p'>]),</span><span class='hljl-t'> </span><span class='hljl-n'>label</span><span class='hljl-oB'>=</span><span class='hljl-p'>[</span><span class='hljl-s'>&quot;&quot;</span><span class='hljl-t'> </span><span class='hljl-s'>&quot;&quot;</span><span class='hljl-p'>],</span><span class='hljl-n'>size</span><span class='hljl-oB'>=</span><span class='hljl-p'>(</span><span class='hljl-ni'>1200</span><span class='hljl-p'>,</span><span class='hljl-ni'>360</span><span class='hljl-p'>))</span>
</pre>


<pre class="julia-error">
ERROR: UndefVarError: Dates not defined
</pre>


<h4>Question 2. Replicate the two panels of Table III from Hansen and Singleton &#40;1984&#41; to the extent you can with their subsample &#40;1960-1 to 1978.12&#41; and the instruments they used.</h4>

<p>Before we get into Table III, let&#39;s see how we would replicate Table I:</p>

<p>&lt;img src&#61;&quot;&#91;Hansen,Singleton;1984;Ecma&#93; ERRATA - Table I estimates for 1959.2 - 1978.12.png&quot;&gt;</p>

<p>Let&#39;s consider the first line. We are using NDS, EWR, in the moment function and one their lagged terms as instruments.</p>
<p class="math">\[
\mathbb{E}\left[\begin{pmatrix} 1\\ \frac{c_t^{*}}{c_{t-1}^{*}}\\ r_{t}^{*} \end{pmatrix} 
    \cdot \left(r_{t+1}^{*}\beta\left(\frac{c_{t+1}^{*}}{c_t^{*}}\right)^{\alpha}-1\right)\right] = 0 \\
\]</p>


<pre class='hljl'>
<span class='hljl-cs'># TABLE 1: EXAMPLE</span><span class='hljl-t'>
</span><span class='hljl-cs'># CONSUMPTION: NDS</span><span class='hljl-t'>
</span><span class='hljl-cs'># RETURN:      EWR</span><span class='hljl-t'>
</span><span class='hljl-cs'># NLAG:        1</span><span class='hljl-t'>

</span><span class='hljl-n'>C⃰</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-nf'>values</span><span class='hljl-p'>(</span><span class='hljl-n'>rPCEpcRatio</span><span class='hljl-p'>)[</span><span class='hljl-ni'>2</span><span class='hljl-oB'>:</span><span class='hljl-k'>end</span><span class='hljl-p'>];</span><span class='hljl-t'>
</span><span class='hljl-n'>r⃰</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-nf'>values</span><span class='hljl-p'>(</span><span class='hljl-n'>rEWRETD</span><span class='hljl-p'>)[</span><span class='hljl-ni'>2</span><span class='hljl-oB'>:</span><span class='hljl-k'>end</span><span class='hljl-p'>];</span><span class='hljl-t'>
</span><span class='hljl-n'>X</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-p'>[</span><span class='hljl-n'>C⃰</span><span class='hljl-t'> </span><span class='hljl-n'>r⃰</span><span class='hljl-p'>];</span><span class='hljl-t'> </span><span class='hljl-cs'># N×2 matrix</span><span class='hljl-t'>

</span><span class='hljl-n'>C⃰_L1</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-nf'>values</span><span class='hljl-p'>(</span><span class='hljl-nf'>lag</span><span class='hljl-p'>(</span><span class='hljl-n'>rPCEpcRatio</span><span class='hljl-p'>,</span><span class='hljl-ni'>1</span><span class='hljl-p'>,</span><span class='hljl-n'>padding</span><span class='hljl-oB'>=</span><span class='hljl-kc'>false</span><span class='hljl-p'>))[</span><span class='hljl-ni'>1</span><span class='hljl-oB'>:</span><span class='hljl-k'>end</span><span class='hljl-p'>];</span><span class='hljl-t'>
</span><span class='hljl-n'>r⃰_L1</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-nf'>values</span><span class='hljl-p'>(</span><span class='hljl-nf'>lag</span><span class='hljl-p'>(</span><span class='hljl-n'>rEWRETD</span><span class='hljl-p'>,</span><span class='hljl-ni'>1</span><span class='hljl-p'>,</span><span class='hljl-n'>padding</span><span class='hljl-oB'>=</span><span class='hljl-kc'>false</span><span class='hljl-p'>))[</span><span class='hljl-ni'>1</span><span class='hljl-oB'>:</span><span class='hljl-k'>end</span><span class='hljl-p'>];</span><span class='hljl-t'>
</span><span class='hljl-n'>Z</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-p'>[</span><span class='hljl-nf'>ones</span><span class='hljl-p'>(</span><span class='hljl-nf'>length</span><span class='hljl-p'>(</span><span class='hljl-n'>C⃰_L1</span><span class='hljl-p'>))</span><span class='hljl-t'> </span><span class='hljl-n'>C⃰_L1</span><span class='hljl-t'> </span><span class='hljl-n'>r⃰_L1</span><span class='hljl-p'>];</span><span class='hljl-t'> </span><span class='hljl-cs'># N×l matrix</span><span class='hljl-t'>

</span><span class='hljl-k'>function</span><span class='hljl-t'> </span><span class='hljl-nf'>f_HS_TABLE1_EXAMPLE</span><span class='hljl-p'>(</span><span class='hljl-n'>γ</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>y</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>X</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>Z</span><span class='hljl-p'>)</span><span class='hljl-t'>
    </span><span class='hljl-cm'>#= 
    γ: parameters. γ[1]=α, γ[2]=β
    X: the matrix of variables that forms moments we wish to make 0
    Z: the matrix orthogonal to moment
    We want to have a N×3 vector
    =#</span><span class='hljl-t'>
    </span><span class='hljl-n'>C⃰</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>r⃰</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-n'>X</span><span class='hljl-p'>[</span><span class='hljl-oB'>:</span><span class='hljl-p'>,</span><span class='hljl-ni'>1</span><span class='hljl-p'>],</span><span class='hljl-t'> </span><span class='hljl-n'>X</span><span class='hljl-p'>[</span><span class='hljl-oB'>:</span><span class='hljl-p'>,</span><span class='hljl-ni'>2</span><span class='hljl-p'>]</span><span class='hljl-t'>
    </span><span class='hljl-k'>return</span><span class='hljl-t'> </span><span class='hljl-p'>(</span><span class='hljl-n'>r⃰</span><span class='hljl-t'> </span><span class='hljl-oB'>.*</span><span class='hljl-t'> </span><span class='hljl-n'>γ</span><span class='hljl-p'>[</span><span class='hljl-ni'>2</span><span class='hljl-p'>]</span><span class='hljl-t'> </span><span class='hljl-oB'>.*</span><span class='hljl-t'> </span><span class='hljl-n'>C⃰</span><span class='hljl-oB'>.^</span><span class='hljl-n'>γ</span><span class='hljl-p'>[</span><span class='hljl-ni'>1</span><span class='hljl-p'>]</span><span class='hljl-t'> </span><span class='hljl-oB'>.-</span><span class='hljl-t'> </span><span class='hljl-n'>y</span><span class='hljl-p'>)</span><span class='hljl-t'> </span><span class='hljl-oB'>.*</span><span class='hljl-t'> </span><span class='hljl-n'>Z</span><span class='hljl-t'> </span><span class='hljl-cs'># (N×1) ⊗ (N×3)</span><span class='hljl-t'>
</span><span class='hljl-k'>end</span><span class='hljl-p'>;</span><span class='hljl-t'>
</span><span class='hljl-n'>γ_GMM</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>σ_GMM</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>chi2_vec</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>df</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>pval_vec</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>diff_vec</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-nf'>iterated_GMM</span><span class='hljl-p'>(</span><span class='hljl-n'>f_HS_TABLE1_EXAMPLE</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-nf'>rand</span><span class='hljl-p'>(</span><span class='hljl-ni'>2</span><span class='hljl-p'>),</span><span class='hljl-t'> </span><span class='hljl-nf'>ones</span><span class='hljl-p'>(</span><span class='hljl-nf'>length</span><span class='hljl-p'>(</span><span class='hljl-n'>C⃰</span><span class='hljl-p'>)),</span><span class='hljl-t'> </span><span class='hljl-n'>X</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>Z</span><span class='hljl-p'>;</span><span class='hljl-t'> </span><span class='hljl-n'>tol</span><span class='hljl-oB'>=</span><span class='hljl-nfB'>1e-8</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>max_iter</span><span class='hljl-oB'>=</span><span class='hljl-ni'>100</span><span class='hljl-p'>);</span>
</pre>


<pre class="julia-error">
ERROR: UndefVarError: rPCEpcRatio not defined
</pre>


<p>Note that the code returns p-values as <code>pval_vec</code>, not <strong>&quot;Prob&quot;</strong>. In Hansen and Singleton &#40;1982&#41;, they reported &#40;1-p-value&#41; in the Prob column.</p>


<pre class='hljl'>
<span class='hljl-nf'>print</span><span class='hljl-p'>(</span><span class='hljl-s'>&quot;Hansen-Singleton GMM Replication: Table I </span><span class='hljl-se'>\n</span><span class='hljl-s'>&quot;</span><span class='hljl-p'>)</span><span class='hljl-t'>
</span><span class='hljl-nf'>print</span><span class='hljl-p'>(</span><span class='hljl-s'>&quot;Instrument Variable Estimates for the Period 1960:1 to 2020:12 </span><span class='hljl-se'>\n</span><span class='hljl-s'>&quot;</span><span class='hljl-p'>)</span><span class='hljl-t'>
</span><span class='hljl-nf'>print</span><span class='hljl-p'>(</span><span class='hljl-s'>&quot;One-step GMM </span><span class='hljl-se'>\n</span><span class='hljl-s'>&quot;</span><span class='hljl-p'>)</span><span class='hljl-t'>
</span><span class='hljl-nf'>print</span><span class='hljl-p'>(</span><span class='hljl-s'>&quot;Consumption | Return | NLAG |    α    |   se(α)   |    β    |   se(α)   |   χ²   | DF | p-value ||</span><span class='hljl-se'>\n</span><span class='hljl-s'>&quot;</span><span class='hljl-p'>)</span><span class='hljl-t'>
</span><span class='hljl-nd'>@printf</span><span class='hljl-p'>(</span><span class='hljl-s'>&quot;NDS         | EWR    | 1    | %7.4f | (%7.5f) | %7.4f | (%7.5f) | %6.4f | %2i | %6.4f  ||</span><span class='hljl-se'>\n</span><span class='hljl-s'>&quot;</span><span class='hljl-p'>,</span><span class='hljl-t'> 
        </span><span class='hljl-n'>γ_GMM</span><span class='hljl-p'>[</span><span class='hljl-ni'>1</span><span class='hljl-p'>][</span><span class='hljl-ni'>1</span><span class='hljl-p'>],</span><span class='hljl-t'> </span><span class='hljl-n'>σ_GMM</span><span class='hljl-p'>[</span><span class='hljl-ni'>1</span><span class='hljl-p'>][</span><span class='hljl-ni'>1</span><span class='hljl-p'>],</span><span class='hljl-n'>γ_GMM</span><span class='hljl-p'>[</span><span class='hljl-ni'>1</span><span class='hljl-p'>][</span><span class='hljl-ni'>2</span><span class='hljl-p'>],</span><span class='hljl-t'> </span><span class='hljl-n'>σ_GMM</span><span class='hljl-p'>[</span><span class='hljl-ni'>1</span><span class='hljl-p'>][</span><span class='hljl-ni'>2</span><span class='hljl-p'>],</span><span class='hljl-t'> </span><span class='hljl-n'>chi2_vec</span><span class='hljl-p'>[</span><span class='hljl-ni'>1</span><span class='hljl-p'>],</span><span class='hljl-t'> </span><span class='hljl-n'>df</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>pval_vec</span><span class='hljl-p'>[</span><span class='hljl-ni'>1</span><span class='hljl-p'>])</span>
</pre>


<pre class="output">
Hansen-Singleton GMM Replication: Table I 
Instrument Variable Estimates for the Period 1960:1 to 2020:12 
One-step GMM 
Consumption | Return | NLAG |    α    |   se&#40;α&#41;   |    β    |   se&#40;α&#41;   |  
 χ²   | DF | p-value ||
</pre>

<pre class="julia-error">
ERROR: UndefVarError: γ_GMM not defined
</pre>



<pre class='hljl'>
<span class='hljl-nf'>print</span><span class='hljl-p'>(</span><span class='hljl-s'>&quot;Hansen-Singleton GMM Replication: Table I </span><span class='hljl-se'>\n</span><span class='hljl-s'>&quot;</span><span class='hljl-p'>)</span><span class='hljl-t'>
</span><span class='hljl-nf'>print</span><span class='hljl-p'>(</span><span class='hljl-s'>&quot;Instrument Variable Estimates for the Period 1960:1 to 2020:12 </span><span class='hljl-se'>\n</span><span class='hljl-s'>&quot;</span><span class='hljl-p'>)</span><span class='hljl-t'>
</span><span class='hljl-nf'>print</span><span class='hljl-p'>(</span><span class='hljl-s'>&quot;Two-step GMM </span><span class='hljl-se'>\n</span><span class='hljl-s'>&quot;</span><span class='hljl-p'>)</span><span class='hljl-t'>
</span><span class='hljl-nf'>print</span><span class='hljl-p'>(</span><span class='hljl-s'>&quot;Consumption | Return | NLAG |    α    |   se(α)   |    β    |   se(α)   |   χ²   | DF |  p-value ||</span><span class='hljl-se'>\n</span><span class='hljl-s'>&quot;</span><span class='hljl-p'>)</span><span class='hljl-t'>
</span><span class='hljl-nd'>@printf</span><span class='hljl-p'>(</span><span class='hljl-s'>&quot;NDS         | EWR    | 1    | %7.4f | (%7.5f) | %7.4f | (%7.5f) | %6.4f | %2i |  %6.4f  ||</span><span class='hljl-se'>\n</span><span class='hljl-s'>&quot;</span><span class='hljl-p'>,</span><span class='hljl-t'> 
        </span><span class='hljl-n'>γ_GMM</span><span class='hljl-p'>[</span><span class='hljl-ni'>2</span><span class='hljl-p'>][</span><span class='hljl-ni'>1</span><span class='hljl-p'>],</span><span class='hljl-t'> </span><span class='hljl-n'>σ_GMM</span><span class='hljl-p'>[</span><span class='hljl-ni'>2</span><span class='hljl-p'>][</span><span class='hljl-ni'>1</span><span class='hljl-p'>],</span><span class='hljl-t'> </span><span class='hljl-n'>γ_GMM</span><span class='hljl-p'>[</span><span class='hljl-ni'>2</span><span class='hljl-p'>][</span><span class='hljl-ni'>2</span><span class='hljl-p'>],</span><span class='hljl-t'> </span><span class='hljl-n'>σ_GMM</span><span class='hljl-p'>[</span><span class='hljl-ni'>2</span><span class='hljl-p'>][</span><span class='hljl-ni'>2</span><span class='hljl-p'>],</span><span class='hljl-t'> </span><span class='hljl-n'>chi2_vec</span><span class='hljl-p'>[</span><span class='hljl-ni'>2</span><span class='hljl-p'>],</span><span class='hljl-t'> </span><span class='hljl-n'>df</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>pval_vec</span><span class='hljl-p'>[</span><span class='hljl-ni'>2</span><span class='hljl-p'>])</span>
</pre>


<pre class="output">
Hansen-Singleton GMM Replication: Table I 
Instrument Variable Estimates for the Period 1960:1 to 2020:12 
Two-step GMM 
Consumption | Return | NLAG |    α    |   se&#40;α&#41;   |    β    |   se&#40;α&#41;   |  
 χ²   | DF |  p-value ||
</pre>

<pre class="julia-error">
ERROR: UndefVarError: γ_GMM not defined
</pre>



<pre class='hljl'>
<span class='hljl-nf'>print</span><span class='hljl-p'>(</span><span class='hljl-s'>&quot;Hansen-Singleton GMM Replication: Table I </span><span class='hljl-se'>\n</span><span class='hljl-s'>&quot;</span><span class='hljl-p'>)</span><span class='hljl-t'>
</span><span class='hljl-nf'>print</span><span class='hljl-p'>(</span><span class='hljl-s'>&quot;Instrument Variable Estimates for the Period 1960:1 to 2020:12 </span><span class='hljl-se'>\n</span><span class='hljl-s'>&quot;</span><span class='hljl-p'>)</span><span class='hljl-t'>
</span><span class='hljl-nf'>print</span><span class='hljl-p'>(</span><span class='hljl-s'>&quot;Iterated GMM until convergence with tolerance 1e-8 </span><span class='hljl-se'>\n</span><span class='hljl-s'>&quot;</span><span class='hljl-p'>)</span><span class='hljl-t'>
</span><span class='hljl-nf'>print</span><span class='hljl-p'>(</span><span class='hljl-s'>&quot;Consumption | Return | NLAG |    α    |   se(α)   |    β    |   se(α)   |   χ²   | DF |  p-value | Iteration ||</span><span class='hljl-se'>\n</span><span class='hljl-s'>&quot;</span><span class='hljl-p'>)</span><span class='hljl-t'>
</span><span class='hljl-nd'>@printf</span><span class='hljl-p'>(</span><span class='hljl-s'>&quot;NDS         | EWR    | 1    | %7.4f | (%7.5f) | %7.4f | (%7.5f) | %6.4f | %2i |  %6.4f  | %5i     ||</span><span class='hljl-se'>\n</span><span class='hljl-s'>&quot;</span><span class='hljl-p'>,</span><span class='hljl-t'> 
        </span><span class='hljl-n'>γ_GMM</span><span class='hljl-p'>[</span><span class='hljl-k'>end</span><span class='hljl-p'>][</span><span class='hljl-ni'>1</span><span class='hljl-p'>],</span><span class='hljl-t'> </span><span class='hljl-n'>σ_GMM</span><span class='hljl-p'>[</span><span class='hljl-k'>end</span><span class='hljl-p'>][</span><span class='hljl-ni'>1</span><span class='hljl-p'>],</span><span class='hljl-t'> </span><span class='hljl-n'>γ_GMM</span><span class='hljl-p'>[</span><span class='hljl-k'>end</span><span class='hljl-p'>][</span><span class='hljl-ni'>2</span><span class='hljl-p'>],</span><span class='hljl-t'> </span><span class='hljl-n'>σ_GMM</span><span class='hljl-p'>[</span><span class='hljl-k'>end</span><span class='hljl-p'>][</span><span class='hljl-ni'>2</span><span class='hljl-p'>],</span><span class='hljl-t'> </span><span class='hljl-n'>chi2_vec</span><span class='hljl-p'>[</span><span class='hljl-k'>end</span><span class='hljl-p'>],</span><span class='hljl-t'> </span><span class='hljl-n'>df</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>pval_vec</span><span class='hljl-p'>[</span><span class='hljl-k'>end</span><span class='hljl-p'>],</span><span class='hljl-t'> </span><span class='hljl-nf'>size</span><span class='hljl-p'>(</span><span class='hljl-n'>γ_GMM</span><span class='hljl-p'>)[</span><span class='hljl-ni'>1</span><span class='hljl-p'>])</span>
</pre>


<pre class="output">
Hansen-Singleton GMM Replication: Table I 
Instrument Variable Estimates for the Period 1960:1 to 2020:12 
Iterated GMM until convergence with tolerance 1e-8 
Consumption | Return | NLAG |    α    |   se&#40;α&#41;   |    β    |   se&#40;α&#41;   |  
 χ²   | DF |  p-value | Iteration ||
</pre>

<pre class="julia-error">
ERROR: UndefVarError: γ_GMM not defined
</pre>


<h3>Let&#39;s replicate Table III &#40;Finally&#33;&#41;</h3>

<p>&lt;img src&#61;&quot;&#91;Hansen,Singleton;1984;Ecma&#93; ERRATA - Table III estimates with multiple returns.png&quot;&gt;</p>

<h4>Panel A</h4>

<p>There is one more complication here: we now have two sets of orthogonality conditions. The first line estimates of Table III uses equally- and value-weighted returns, with one lag for each of the consumption ration and equally- and value-weighted returns. This is a set of 8 population moment conditions in 2 parameters &#40;<span class="math">$\alpha,\beta$</span>&#41;.</p>

<p class="math">\[
\begin{align*}
\mathbb{E}\left[\begin{pmatrix}
1\\ 
\frac{c_t}{c_{t-1}}\\ 
r_{t}^*\\ 
r_{t}
\end{pmatrix} \cdot \left(r_{t+1}^*\beta\left(\frac{c_{t+1}^*}{c_t^*}\right)^{\alpha}-1\right)\right] &= 0 \\
\mathbb{E}\left[\begin{pmatrix}
1\\ 
\frac{c_t}{c_{t-1}}\\ 
r_{t}^*\\ 
r_{t}
\end{pmatrix} \cdot \left(r_{t+1}\beta\left(\frac{c_{t+1}^*}{c_t^*}\right)^{\alpha}-1\right)\right] &= 0
\end{align*}
\]</p>

<p>The degree of freedom &#40;DF&#41; is 2*&#40;1&#43;&#40;NLAG of consumption ratio&#41;&#43;&#40;NLAG of EWR&#41;&#43;&#40;NLAG of VWR&#41;&#41;-2</p>
<ul>
<li><p>NLAG&#61;1: <span class="math">$2\times(1+1+1+1)-2=6$</span></p>
</li>
<li><p>NLAG&#61;2: <span class="math">$2\times(1+2+2+2)-2=12$</span> </p>
</li>
<li><p>NLAG&#61;4: <span class="math">$2\times(1+4+4+4)-2=24$</span></p>
</li>
</ul>


<pre class='hljl'>
<span class='hljl-cs'># TABLE 3: EXAMPLE</span><span class='hljl-t'>
</span><span class='hljl-cs'># CONSUMPTION: NDS</span><span class='hljl-t'>
</span><span class='hljl-cs'># RETURN: EWR &amp; VWR</span><span class='hljl-t'>
</span><span class='hljl-cs'># NLAG: 1</span><span class='hljl-t'>

</span><span class='hljl-n'>C⃰</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-nf'>values</span><span class='hljl-p'>(</span><span class='hljl-n'>rPCEpcRatio</span><span class='hljl-p'>)[</span><span class='hljl-ni'>2</span><span class='hljl-oB'>:</span><span class='hljl-k'>end</span><span class='hljl-p'>];</span><span class='hljl-t'>
</span><span class='hljl-n'>r</span><span class='hljl-t'>  </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-nf'>values</span><span class='hljl-p'>(</span><span class='hljl-n'>rVWRETD</span><span class='hljl-p'>)[</span><span class='hljl-ni'>2</span><span class='hljl-oB'>:</span><span class='hljl-k'>end</span><span class='hljl-p'>];</span><span class='hljl-t'>
</span><span class='hljl-n'>r⃰</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-nf'>values</span><span class='hljl-p'>(</span><span class='hljl-n'>rEWRETD</span><span class='hljl-p'>)[</span><span class='hljl-ni'>2</span><span class='hljl-oB'>:</span><span class='hljl-k'>end</span><span class='hljl-p'>];</span><span class='hljl-t'>
</span><span class='hljl-n'>X</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-p'>[</span><span class='hljl-n'>C⃰</span><span class='hljl-t'> </span><span class='hljl-n'>r</span><span class='hljl-t'> </span><span class='hljl-n'>r⃰</span><span class='hljl-p'>];</span><span class='hljl-t'>

</span><span class='hljl-n'>C⃰_L1</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-nf'>values</span><span class='hljl-p'>(</span><span class='hljl-nf'>lag</span><span class='hljl-p'>(</span><span class='hljl-n'>rPCEpcRatio</span><span class='hljl-p'>,</span><span class='hljl-ni'>1</span><span class='hljl-p'>,</span><span class='hljl-n'>padding</span><span class='hljl-oB'>=</span><span class='hljl-kc'>false</span><span class='hljl-p'>));</span><span class='hljl-t'>
</span><span class='hljl-n'>r_L1</span><span class='hljl-t'>  </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-nf'>values</span><span class='hljl-p'>(</span><span class='hljl-nf'>lag</span><span class='hljl-p'>(</span><span class='hljl-n'>rVWRETD</span><span class='hljl-p'>,</span><span class='hljl-ni'>1</span><span class='hljl-p'>,</span><span class='hljl-n'>padding</span><span class='hljl-oB'>=</span><span class='hljl-kc'>false</span><span class='hljl-p'>));</span><span class='hljl-t'>
</span><span class='hljl-n'>r⃰_L1</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-nf'>values</span><span class='hljl-p'>(</span><span class='hljl-nf'>lag</span><span class='hljl-p'>(</span><span class='hljl-n'>rEWRETD</span><span class='hljl-p'>,</span><span class='hljl-ni'>1</span><span class='hljl-p'>,</span><span class='hljl-n'>padding</span><span class='hljl-oB'>=</span><span class='hljl-kc'>false</span><span class='hljl-p'>));</span><span class='hljl-t'>
</span><span class='hljl-n'>Z</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-p'>[</span><span class='hljl-nf'>ones</span><span class='hljl-p'>(</span><span class='hljl-nf'>length</span><span class='hljl-p'>(</span><span class='hljl-n'>C⃰_L1</span><span class='hljl-p'>))</span><span class='hljl-t'> </span><span class='hljl-n'>C⃰_L1</span><span class='hljl-t'> </span><span class='hljl-n'>r_L1</span><span class='hljl-t'> </span><span class='hljl-n'>r⃰_L1</span><span class='hljl-p'>];</span><span class='hljl-t'>

</span><span class='hljl-k'>function</span><span class='hljl-t'> </span><span class='hljl-nf'>f_HS_TABLE3_EXAMPLE</span><span class='hljl-p'>(</span><span class='hljl-n'>γ</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>y</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>X</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>Z</span><span class='hljl-p'>)</span><span class='hljl-t'>
    </span><span class='hljl-cm'>#= 
    γ: parameters. γ[1]=α, γ[2]=β
    X: the matrix of variables that forms moments we wish to make 0
    Z: the matrix orthogonal to moment
    We want to have a N×8 vector
    =#</span><span class='hljl-t'>
    </span><span class='hljl-n'>C⃰</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>r</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>r⃰</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-n'>X</span><span class='hljl-p'>[</span><span class='hljl-oB'>:</span><span class='hljl-p'>,</span><span class='hljl-ni'>1</span><span class='hljl-p'>],</span><span class='hljl-t'> </span><span class='hljl-n'>X</span><span class='hljl-p'>[</span><span class='hljl-oB'>:</span><span class='hljl-p'>,</span><span class='hljl-ni'>2</span><span class='hljl-p'>],</span><span class='hljl-t'> </span><span class='hljl-n'>X</span><span class='hljl-p'>[</span><span class='hljl-oB'>:</span><span class='hljl-p'>,</span><span class='hljl-ni'>3</span><span class='hljl-p'>];</span><span class='hljl-t'>
    </span><span class='hljl-n'>m1</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-p'>(</span><span class='hljl-n'>r⃰</span><span class='hljl-t'> </span><span class='hljl-oB'>.*</span><span class='hljl-t'> </span><span class='hljl-n'>γ</span><span class='hljl-p'>[</span><span class='hljl-ni'>2</span><span class='hljl-p'>]</span><span class='hljl-t'> </span><span class='hljl-oB'>.*</span><span class='hljl-t'> </span><span class='hljl-n'>C⃰</span><span class='hljl-oB'>.^</span><span class='hljl-n'>γ</span><span class='hljl-p'>[</span><span class='hljl-ni'>1</span><span class='hljl-p'>]</span><span class='hljl-t'> </span><span class='hljl-oB'>-</span><span class='hljl-t'> </span><span class='hljl-n'>y</span><span class='hljl-p'>)</span><span class='hljl-t'> </span><span class='hljl-oB'>.*</span><span class='hljl-t'> </span><span class='hljl-n'>Z</span><span class='hljl-t'> </span><span class='hljl-cs'># (N×1) ⊗ (N×4)</span><span class='hljl-t'>
    </span><span class='hljl-n'>m2</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-p'>(</span><span class='hljl-n'>r</span><span class='hljl-t'>  </span><span class='hljl-oB'>.*</span><span class='hljl-t'> </span><span class='hljl-n'>γ</span><span class='hljl-p'>[</span><span class='hljl-ni'>2</span><span class='hljl-p'>]</span><span class='hljl-t'> </span><span class='hljl-oB'>.*</span><span class='hljl-t'> </span><span class='hljl-n'>C⃰</span><span class='hljl-oB'>.^</span><span class='hljl-n'>γ</span><span class='hljl-p'>[</span><span class='hljl-ni'>1</span><span class='hljl-p'>]</span><span class='hljl-t'> </span><span class='hljl-oB'>-</span><span class='hljl-t'> </span><span class='hljl-n'>y</span><span class='hljl-p'>)</span><span class='hljl-t'> </span><span class='hljl-oB'>.*</span><span class='hljl-t'> </span><span class='hljl-n'>Z</span><span class='hljl-t'> </span><span class='hljl-cs'># (N×1) ⊗ (N×4)</span><span class='hljl-t'>
    </span><span class='hljl-k'>return</span><span class='hljl-t'> </span><span class='hljl-p'>[</span><span class='hljl-n'>m1</span><span class='hljl-t'> </span><span class='hljl-n'>m2</span><span class='hljl-p'>]</span><span class='hljl-t'>
</span><span class='hljl-k'>end</span><span class='hljl-p'>;</span>
</pre>


<pre class="julia-error">
ERROR: UndefVarError: rPCEpcRatio not defined
</pre>


<h4>Panel B</h4>

<p>In Hansen and Singleton &#40;1984&#41;, they describe how they used the nominal risk-free returns:</p>

<p>&lt;img src&#61;&quot;&#91;Hansen,Singleton;1984;Ecma&#93; ERRATA - on nominal risk-free returns on Table III.png&quot; width&#61;&quot;700&quot;&gt;</p>

<p class="math">\[
\begin{align*}
\mathbb{E}\left[\begin{pmatrix}
1\\ 
\frac{c_t}{c_{t-1}}\\ 
r_{t}\\ 
\frac{R_{t+1}^f}{R_{t}^f}\\
\frac{R_{t}^f}{R_{t-1}^f}
\end{pmatrix} \cdot \left(r_{t+1}\beta\left(\frac{c_{t+1}^*}{c_t^*}\right)^{\alpha}-1\right)\right] &= 0 \\
\mathbb{E}\left[\begin{pmatrix}
1\\ 
\frac{c_t}{c_{t-1}}\\ 
r_t \\
\frac{R_{t+1}^f}{R_{t}^f}\\
\frac{R_{t}^f}{R_{t-1}^f}
\end{pmatrix} \cdot \left(R_{t+1}^f \beta\left(\frac{c_{t+1}}{c_t}\right)^{\alpha}-1\right)\right] &= 0
\end{align*}
\]</p>

<p>Their claim is that the degree of freedom is 2* &#91;constant &#43; &#40;risk-free ratio &#43; NLAG for risk-free ratio&#41; &#43; &#40;NLAG for consumption ratio&#41; &#43; &#40;NLAG for VWR&#41;&#93;-2</p>
<ul>
<li><p>NLAG&#61;1: <span class="math">$2\times(1+(1+1)+1+1)-2=8$</span></p>
</li>
<li><p>NLAG&#61;2: <span class="math">$2\times(1+(1+2)+2+2)-2=14$</span></p>
</li>
<li><p>NLAG&#61;4: <span class="math">$2\times(1+(1+4)+4+4)-2=26$</span></p>
</li>
</ul>
<p>&#40;Credit to Christine Dabbs&#41; However, it seems like Hansen and Singleton double-counted the number of risk-free ratios. They have df &#61; 8, 16, 32. These numbers are replicable if we counted degree of freedoms as:</p>
<p>2* &#91;constant &#43; 2*&#40;NLAG for risk-free ratio&#41; &#43; &#40;NLAG for consumption ratio&#41; &#43; &#40;NLAG for VWR&#41;&#93;-2</p>
<ul>
<li><p>NLAG&#61;1: <span class="math">$2\times(1+2*1+1+1)-2=8$</span></p>
</li>
<li><p>NLAG&#61;2: <span class="math">$2\times(1+2*2+2+2)-2=16$</span></p>
</li>
<li><p>NLAG&#61;4: <span class="math">$2\times(1+2*4+4+4)-2=32$</span></p>
</li>
</ul>

<h4>Question 3</h4>
<p>Here, you are now estimating 4 parameters, <span class="math">$(\alpha_1,\beta_1,\alpha_2,\beta_2)$</span>. You may want to find <span class="math">$(\alpha_1,\beta_1)$</span> only with data from 1960.1 to 1978.12 and <span class="math">$(\alpha_2,\beta_2)$</span> with data from 1979.1 and onward. You can change <code>f_HS_TABLE3_EXAMPLE</code> to do this exercise. You can only use data from 1960.1 to 1978.12 for <code>m1</code> and use data from 1979.1 to 2020.12 for <code>m2</code>. You may also want to use <span class="math">$4\times1$</span> vector <span class="math">$\vec{\gamma}$</span>. This is your &#39;unconstrained&#39; GMM.</p>
<p>Now, you are asked to test <span class="math">$(\alpha_1,\beta_1)=(\alpha_2,\beta_2)$</span>. The following theorem will be helpful:</p>

<h4>Theorem &#40;<a href="https://comlabgames.com/structuraleconometrics/3&#37;20Asymptotic&#37;20Theory&#37;20for&#37;20Nonlinear&#37;20Models/13&#37;20Testing&#37;20Parametric&#37;20Models/13&#37;20Testing&#37;20Parametric&#37;20Models.pdf">Professor Miller&#39;s Lecture Notes, slide 17</a>&#41;</h4>
<p>Let <span class="math">$J_{un}$</span> be the unconstrained GMM criterion function with <span class="math">$l_1$</span> orthogonality conditions and <span class="math">$k_1$</span> parameters. Let <span class="math">$J_{con}$</span> be the constrained GMM criterion function with <span class="math">$l_2$</span> orthogonality conditions and <span class="math">$k_2$</span> parameters. Then,</p>
<p class="math">\[
J_{con} - J_{un} \overset{d}{\longrightarrow} \chi^2_{(l_2-k_2)-(l_1-k_1)}.
\]</p>

<p>Additionally, you might be able to test models with more parameters in more time frames, say, before/after the financial crisis in 2008 and before/after COVID-19. To do so, you may need more instruments using more lagged variables.</p>

<h4>Question 4 and 5</h4>
<p>I will leave questions 4 and 5 for you to explore. Now you have basic codes to run, I am sure you can easily modify code and get the estimates.</p>

<h4>Question 6</h4>
<p>Let’s come back to data and think about big picture here. Hansen and Singleton &#40;1982&#41; assumes that we have a stationary environment. Test whether any of these series we considered in question 1 have a unit root. &#40;You should read about <a href="https://en.wikipedia.org/wiki/Unit_root_test">unit root tests</a> first.&#41; Is there evidencethat these series are not stationary and ergodic?</p>

<p>I use <a href="https://en.wikipedia.org/wiki/Augmented_Dickey&#37;E2&#37;80&#37;93Fuller_test">Augmented Dickey-Fuller &#40;ADF&#41; Test</a>. I will let you discuss whether you think time series data we used are stationary and ergodic.</p>

<p>&#40;Not graded&#41; TA&#39;s conjecture: Try ADF tests with i&#41; a constant, ii&#41; a trend, iii&#41; a trend and trend squared. What do these tests tell you? If Hansen and Singleton &#40;1982&#41; requires stationarity, how would you incorporate the findings to your model?</p>


<pre class='hljl'>
<span class='hljl-n'>varDF</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-nf'>DataFrame</span><span class='hljl-p'>(</span><span class='hljl-n'>varname</span><span class='hljl-oB'>=</span><span class='hljl-nf'>Vector</span><span class='hljl-p'>{</span><span class='hljl-n'>String</span><span class='hljl-p'>}(),</span><span class='hljl-t'>
                </span><span class='hljl-n'>varsymbol</span><span class='hljl-oB'>=</span><span class='hljl-nf'>Vector</span><span class='hljl-p'>{</span><span class='hljl-n'>Symbol</span><span class='hljl-p'>}(),</span><span class='hljl-t'>
                </span><span class='hljl-n'>vardata</span><span class='hljl-oB'>=</span><span class='hljl-nf'>Vector</span><span class='hljl-p'>{</span><span class='hljl-n'>TimeArray</span><span class='hljl-p'>}())</span><span class='hljl-t'>
</span><span class='hljl-n'>varDF</span><span class='hljl-oB'>=</span><span class='hljl-nf'>vcat</span><span class='hljl-p'>(</span><span class='hljl-n'>varDF</span><span class='hljl-p'>,</span><span class='hljl-nf'>DataFrame</span><span class='hljl-p'>(</span><span class='hljl-n'>varname</span><span class='hljl-oB'>=</span><span class='hljl-s'>&quot;PCE per Capita (deflated)&quot;</span><span class='hljl-p'>,</span><span class='hljl-n'>varsymbol</span><span class='hljl-oB'>=:</span><span class='hljl-n'>rPCEpc</span><span class='hljl-p'>,</span><span class='hljl-n'>vardata</span><span class='hljl-oB'>=</span><span class='hljl-n'>rPCEpc</span><span class='hljl-p'>))</span><span class='hljl-t'>
</span><span class='hljl-n'>varDF</span><span class='hljl-oB'>=</span><span class='hljl-nf'>vcat</span><span class='hljl-p'>(</span><span class='hljl-n'>varDF</span><span class='hljl-p'>,</span><span class='hljl-nf'>DataFrame</span><span class='hljl-p'>(</span><span class='hljl-n'>varname</span><span class='hljl-oB'>=</span><span class='hljl-s'>&quot;PCEND per Capita (deflated)&quot;</span><span class='hljl-p'>,</span><span class='hljl-n'>varsymbol</span><span class='hljl-oB'>=:</span><span class='hljl-n'>rPCENDpc</span><span class='hljl-p'>,</span><span class='hljl-n'>vardata</span><span class='hljl-oB'>=</span><span class='hljl-n'>rPCENDpc</span><span class='hljl-p'>))</span><span class='hljl-t'>
</span><span class='hljl-n'>varDF</span><span class='hljl-oB'>=</span><span class='hljl-nf'>vcat</span><span class='hljl-p'>(</span><span class='hljl-n'>varDF</span><span class='hljl-p'>,</span><span class='hljl-nf'>DataFrame</span><span class='hljl-p'>(</span><span class='hljl-n'>varname</span><span class='hljl-oB'>=</span><span class='hljl-s'>&quot;PCE per Capita (deflated) ratio&quot;</span><span class='hljl-p'>,</span><span class='hljl-n'>varsymbol</span><span class='hljl-oB'>=:</span><span class='hljl-n'>rPCEpcRatio</span><span class='hljl-p'>,</span><span class='hljl-n'>vardata</span><span class='hljl-oB'>=</span><span class='hljl-n'>rPCEpcRatio</span><span class='hljl-p'>))</span><span class='hljl-t'>
</span><span class='hljl-n'>varDF</span><span class='hljl-oB'>=</span><span class='hljl-nf'>vcat</span><span class='hljl-p'>(</span><span class='hljl-n'>varDF</span><span class='hljl-p'>,</span><span class='hljl-nf'>DataFrame</span><span class='hljl-p'>(</span><span class='hljl-n'>varname</span><span class='hljl-oB'>=</span><span class='hljl-s'>&quot;PCEND per Capita (deflated) ratio&quot;</span><span class='hljl-p'>,</span><span class='hljl-n'>varsymbol</span><span class='hljl-oB'>=:</span><span class='hljl-n'>rPCENDpcRatio</span><span class='hljl-p'>,</span><span class='hljl-n'>vardata</span><span class='hljl-oB'>=</span><span class='hljl-n'>rPCENDpcRatio</span><span class='hljl-p'>))</span><span class='hljl-t'>
</span><span class='hljl-n'>varDF</span><span class='hljl-oB'>=</span><span class='hljl-nf'>vcat</span><span class='hljl-p'>(</span><span class='hljl-n'>varDF</span><span class='hljl-p'>,</span><span class='hljl-nf'>DataFrame</span><span class='hljl-p'>(</span><span class='hljl-n'>varname</span><span class='hljl-oB'>=</span><span class='hljl-s'>&quot;Real Equal-weighted Returns&quot;</span><span class='hljl-p'>,</span><span class='hljl-n'>varsymbol</span><span class='hljl-oB'>=:</span><span class='hljl-n'>rEWRETD</span><span class='hljl-p'>,</span><span class='hljl-n'>vardata</span><span class='hljl-oB'>=</span><span class='hljl-n'>rEWRETD</span><span class='hljl-p'>))</span><span class='hljl-t'>
</span><span class='hljl-n'>varDF</span><span class='hljl-oB'>=</span><span class='hljl-nf'>vcat</span><span class='hljl-p'>(</span><span class='hljl-n'>varDF</span><span class='hljl-p'>,</span><span class='hljl-nf'>DataFrame</span><span class='hljl-p'>(</span><span class='hljl-n'>varname</span><span class='hljl-oB'>=</span><span class='hljl-s'>&quot;Real Value-Weighted Returns&quot;</span><span class='hljl-p'>,</span><span class='hljl-n'>varsymbol</span><span class='hljl-oB'>=:</span><span class='hljl-n'>rVWRETD</span><span class='hljl-p'>,</span><span class='hljl-n'>vardata</span><span class='hljl-oB'>=</span><span class='hljl-n'>rVWRETD</span><span class='hljl-p'>))</span><span class='hljl-t'>
</span><span class='hljl-n'>varDF</span><span class='hljl-oB'>=</span><span class='hljl-nf'>vcat</span><span class='hljl-p'>(</span><span class='hljl-n'>varDF</span><span class='hljl-p'>,</span><span class='hljl-nf'>DataFrame</span><span class='hljl-p'>(</span><span class='hljl-n'>varname</span><span class='hljl-oB'>=</span><span class='hljl-s'>&quot;Real S&amp;P Returns&quot;</span><span class='hljl-p'>,</span><span class='hljl-n'>varsymbol</span><span class='hljl-oB'>=:</span><span class='hljl-n'>rSPRTRN</span><span class='hljl-p'>,</span><span class='hljl-n'>vardata</span><span class='hljl-oB'>=</span><span class='hljl-n'>rSPRTRN</span><span class='hljl-p'>))</span><span class='hljl-t'>
</span><span class='hljl-k'>for</span><span class='hljl-t'> </span><span class='hljl-n'>i</span><span class='hljl-t'> </span><span class='hljl-kp'>in</span><span class='hljl-t'> </span><span class='hljl-ni'>1</span><span class='hljl-oB'>:</span><span class='hljl-ni'>4</span><span class='hljl-t'>
    </span><span class='hljl-n'>name</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-n'>varDF</span><span class='hljl-p'>[</span><span class='hljl-sc'>:varname</span><span class='hljl-p'>][</span><span class='hljl-n'>i</span><span class='hljl-p'>]</span><span class='hljl-t'>
    </span><span class='hljl-n'>symbol</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-n'>varDF</span><span class='hljl-p'>[</span><span class='hljl-sc'>:varsymbol</span><span class='hljl-p'>][</span><span class='hljl-n'>i</span><span class='hljl-p'>]</span><span class='hljl-t'>
    </span><span class='hljl-n'>data</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-n'>varDF</span><span class='hljl-p'>[</span><span class='hljl-sc'>:vardata</span><span class='hljl-p'>][</span><span class='hljl-n'>i</span><span class='hljl-p'>]</span><span class='hljl-t'>
    </span><span class='hljl-n'>data</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-nf'>DataFrame</span><span class='hljl-p'>(</span><span class='hljl-n'>data</span><span class='hljl-p'>)[</span><span class='hljl-oB'>!</span><span class='hljl-p'>,</span><span class='hljl-n'>symbol</span><span class='hljl-p'>][</span><span class='hljl-ni'>2</span><span class='hljl-oB'>:</span><span class='hljl-k'>end</span><span class='hljl-p'>]</span><span class='hljl-t'>
    </span><span class='hljl-nf'>print</span><span class='hljl-p'>(</span><span class='hljl-s'>&quot;ADF Test: </span><span class='hljl-si'>$name</span><span class='hljl-s'> </span><span class='hljl-se'>\n</span><span class='hljl-s'>&quot;</span><span class='hljl-p'>)</span><span class='hljl-t'>
    </span><span class='hljl-nf'>print</span><span class='hljl-p'>(</span><span class='hljl-s'>&quot;        | Coefficient |  Statistic  | p-value | </span><span class='hljl-se'>\n</span><span class='hljl-s'>&quot;</span><span class='hljl-p'>)</span><span class='hljl-t'>
    </span><span class='hljl-k'>for</span><span class='hljl-t'> </span><span class='hljl-n'>lags</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-p'>[</span><span class='hljl-ni'>1</span><span class='hljl-p'>,</span><span class='hljl-ni'>2</span><span class='hljl-p'>,</span><span class='hljl-ni'>4</span><span class='hljl-p'>,</span><span class='hljl-ni'>6</span><span class='hljl-p'>]</span><span class='hljl-t'>
        </span><span class='hljl-n'>stat</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-nf'>ADFTest</span><span class='hljl-p'>(</span><span class='hljl-n'>data</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-sc'>:none</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>lags</span><span class='hljl-p'>)</span><span class='hljl-oB'>.</span><span class='hljl-n'>stat</span><span class='hljl-t'>
        </span><span class='hljl-n'>coef</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-nf'>ADFTest</span><span class='hljl-p'>(</span><span class='hljl-n'>data</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-sc'>:none</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>lags</span><span class='hljl-p'>)</span><span class='hljl-oB'>.</span><span class='hljl-n'>coef</span><span class='hljl-t'>
        </span><span class='hljl-n'>pval</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-nf'>pvalue</span><span class='hljl-p'>(</span><span class='hljl-nf'>ADFTest</span><span class='hljl-p'>(</span><span class='hljl-n'>data</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-sc'>:none</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>lags</span><span class='hljl-p'>))</span><span class='hljl-t'>
        </span><span class='hljl-nf'>print</span><span class='hljl-p'>(</span><span class='hljl-s'>&quot;NLAGS:</span><span class='hljl-si'>$lags</span><span class='hljl-s'> |&quot;</span><span class='hljl-p'>)</span><span class='hljl-t'>
        </span><span class='hljl-nd'>@printf</span><span class='hljl-p'>(</span><span class='hljl-s'>&quot; %11.8f | %11.8f |  %6.4f | </span><span class='hljl-se'>\n</span><span class='hljl-s'>&quot;</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>coef</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>stat</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>pval</span><span class='hljl-p'>)</span><span class='hljl-t'>
    </span><span class='hljl-k'>end</span><span class='hljl-t'>
    </span><span class='hljl-nf'>print</span><span class='hljl-p'>(</span><span class='hljl-s'>&quot;</span><span class='hljl-se'>\n</span><span class='hljl-s'>&quot;</span><span class='hljl-p'>)</span><span class='hljl-t'>
</span><span class='hljl-k'>end</span>
</pre>


<pre class="julia-error">
ERROR: UndefVarError: TimeArray not defined
</pre>



<pre class='hljl'>
<span class='hljl-k'>for</span><span class='hljl-t'> </span><span class='hljl-n'>i</span><span class='hljl-t'> </span><span class='hljl-kp'>in</span><span class='hljl-t'> </span><span class='hljl-ni'>5</span><span class='hljl-oB'>:</span><span class='hljl-nf'>size</span><span class='hljl-p'>(</span><span class='hljl-n'>varDF</span><span class='hljl-p'>)[</span><span class='hljl-ni'>1</span><span class='hljl-p'>]</span><span class='hljl-t'>
    </span><span class='hljl-n'>name</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-n'>varDF</span><span class='hljl-p'>[</span><span class='hljl-sc'>:varname</span><span class='hljl-p'>][</span><span class='hljl-n'>i</span><span class='hljl-p'>]</span><span class='hljl-t'>
    </span><span class='hljl-n'>symbol</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-n'>varDF</span><span class='hljl-p'>[</span><span class='hljl-sc'>:varsymbol</span><span class='hljl-p'>][</span><span class='hljl-n'>i</span><span class='hljl-p'>]</span><span class='hljl-t'>
    </span><span class='hljl-n'>data</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-n'>varDF</span><span class='hljl-p'>[</span><span class='hljl-sc'>:vardata</span><span class='hljl-p'>][</span><span class='hljl-n'>i</span><span class='hljl-p'>]</span><span class='hljl-t'>
    </span><span class='hljl-n'>data</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-nf'>DataFrame</span><span class='hljl-p'>(</span><span class='hljl-n'>data</span><span class='hljl-p'>)[</span><span class='hljl-oB'>!</span><span class='hljl-p'>,</span><span class='hljl-n'>symbol</span><span class='hljl-p'>][</span><span class='hljl-ni'>2</span><span class='hljl-oB'>:</span><span class='hljl-k'>end</span><span class='hljl-p'>]</span><span class='hljl-t'>
    </span><span class='hljl-nf'>print</span><span class='hljl-p'>(</span><span class='hljl-s'>&quot;ADF Test: </span><span class='hljl-si'>$name</span><span class='hljl-s'> </span><span class='hljl-se'>\n</span><span class='hljl-s'>&quot;</span><span class='hljl-p'>)</span><span class='hljl-t'>
    </span><span class='hljl-nf'>print</span><span class='hljl-p'>(</span><span class='hljl-s'>&quot;        | Coefficient |  Statistic  | p-value | </span><span class='hljl-se'>\n</span><span class='hljl-s'>&quot;</span><span class='hljl-p'>)</span><span class='hljl-t'>
    </span><span class='hljl-k'>for</span><span class='hljl-t'> </span><span class='hljl-n'>lags</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-p'>[</span><span class='hljl-ni'>1</span><span class='hljl-p'>,</span><span class='hljl-ni'>2</span><span class='hljl-p'>,</span><span class='hljl-ni'>4</span><span class='hljl-p'>,</span><span class='hljl-ni'>6</span><span class='hljl-p'>]</span><span class='hljl-t'>
        </span><span class='hljl-n'>stat</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-nf'>ADFTest</span><span class='hljl-p'>(</span><span class='hljl-n'>data</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-sc'>:none</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>lags</span><span class='hljl-p'>)</span><span class='hljl-oB'>.</span><span class='hljl-n'>stat</span><span class='hljl-t'>
        </span><span class='hljl-n'>coef</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-nf'>ADFTest</span><span class='hljl-p'>(</span><span class='hljl-n'>data</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-sc'>:none</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>lags</span><span class='hljl-p'>)</span><span class='hljl-oB'>.</span><span class='hljl-n'>coef</span><span class='hljl-t'>
        </span><span class='hljl-n'>pval</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-nf'>pvalue</span><span class='hljl-p'>(</span><span class='hljl-nf'>ADFTest</span><span class='hljl-p'>(</span><span class='hljl-n'>data</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-sc'>:none</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>lags</span><span class='hljl-p'>))</span><span class='hljl-t'>
        </span><span class='hljl-nf'>print</span><span class='hljl-p'>(</span><span class='hljl-s'>&quot;NLAGS:</span><span class='hljl-si'>$lags</span><span class='hljl-s'> |&quot;</span><span class='hljl-p'>)</span><span class='hljl-t'>
        </span><span class='hljl-nd'>@printf</span><span class='hljl-p'>(</span><span class='hljl-s'>&quot; %11.8f | %11.8f |  %6.4f | </span><span class='hljl-se'>\n</span><span class='hljl-s'>&quot;</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>coef</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>stat</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>pval</span><span class='hljl-p'>)</span><span class='hljl-t'>
    </span><span class='hljl-k'>end</span><span class='hljl-t'>
    </span><span class='hljl-nf'>print</span><span class='hljl-p'>(</span><span class='hljl-s'>&quot;</span><span class='hljl-se'>\n</span><span class='hljl-s'>&quot;</span><span class='hljl-p'>)</span><span class='hljl-t'>
</span><span class='hljl-k'>end</span>
</pre>


<pre class="julia-error">
ERROR: UndefVarError: varDF not defined
</pre>


<p>References:</p>
<ul>
<li><p><a href="https://comlabgames.com/structuraleconometrics/">Professor Miller&#39;s Lecture Note Chapters 3 and 12</a></p>
</li>
<li><p><a href="https://www.ssc.wisc.edu/~bhansen/econometrics/Econometrics.pdf">Bruce Hansen&#39;s econometrics textbook</a></p>
</li>
<li><p>Hansen, Lars Peter, and Kenneth J. Singleton. &quot;Generalized instrumental variables estimation of nonlinear rational expectations models.&quot; Econometrica: Journal of the Econometric Society &#40;1982&#41;: 1269-1286.</p>
</li>
<li><p>Hansen, Lars Peter. &quot;Large sample properties of generalized method of moments estimators.&quot; Econometrica: Journal of the econometric society &#40;1982&#41;: 1029-1054.</p>
</li>
<li><p>Newey, Whitney K., and Daniel McFadden. &quot;Large sample estimation and hypothesis testing.&quot; Handbook of econometrics 4 &#40;1994&#41;: 2111-2245.</p>
</li>
</ul>


        <HR/>
        <div class="footer">
          <p>
            Published from <a href="Hansen and Singleton, 1982 (GMM).ipynb">Hansen and Singleton, 1982 (GMM).ipynb</a>
            using <a href="http://github.com/JunoLab/Weave.jl">Weave.jl</a> v0.10.10 on 2022-02-21.
          </p>
        </div>
      </div>
    </div>
  </div>
</BODY>

</HTML>
